<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>RRZ - Ask AI Dental Radiology Assistant</title>
<script defer="" src="shared/aiClient.js"></script>
<style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --bg3:#334155;
      --glass:rgba(15, 23, 42, 0.78);
      --border:rgba(255,255,255,0.12);
      --text:#ffffff; --muted:rgba(226,232,240,0.80);
      --userBg:rgba(59,130,246,0.16); --userBd:rgba(59,130,246,0.35);
      --aiBg:rgba(16,185,129,0.14); --aiBd:rgba(16,185,129,0.28);
      --btn1:#06b6d4; --btn2:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0; color:var(--text); min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 50%,var(--bg3) 100%)}
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px}
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .title{display:flex; gap:12px; align-items:center}
    .logo{width:48px; height:48px; border-radius:16px; display:flex; align-items:center; justify-content:center; background:var(--glass); border:1px solid var(--border); backdrop-filter:blur(16px)}
    .logo img{width:36px; height:36px; object-fit:contain}
    .h1{margin:0; font-weight:800; font-size:18px}
    .sub{margin:3px 0 0; color:var(--muted); font-size:12px}
    .glass{background:var(--glass); border:1px solid var(--border); backdrop-filter:blur(16px)}
    .btn{cursor:pointer; padding:10px 14px; border-radius:14px; border:1px solid var(--border); background:var(--glass); color:var(--text)}
    .btn:hover{filter:brightness(1.05)}

    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{border-radius:18px; padding:14px}
    .chatBox{min-height:60vh; display:flex; flex-direction:column}
    .chat{flex:1; overflow:auto; padding-right:6px}
    .msg{border-radius:16px; padding:12px; margin-bottom:10px}
    .msg .who{font-weight:800; margin-bottom:6px}
    .msg-user{background:var(--userBg); border:1px solid var(--userBd)}
    .msg-ai{background:var(--aiBg); border:1px solid var(--aiBd)}

    .inputRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    textarea{width:100%; min-height:54px; resize:vertical; padding:12px; border-radius:14px; border:0; outline:none; color:#0f172a}
    .send{padding:12px 16px; border-radius:14px; border:0; cursor:pointer; font-weight:800; color:white; background:linear-gradient(90deg,var(--btn1),var(--btn2))}
    .send:disabled{opacity:0.7; cursor:not-allowed}

    .meta{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:12px}
    .meta label{display:flex; gap:8px; align-items:center}
    .meta input{accent-color:#22d3ee}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .side h2{margin:0 0 10px; font-size:14px; font-weight:800}
    .qbtn{width:100%; text-align:right; padding:10px 12px; border-radius:14px; border:1px solid var(--userBd); background:var(--userBg); color:var(--text); cursor:pointer; margin-bottom:8px}
    .qbtn:hover{filter:brightness(1.06)}
    .hr{height:1px; background:rgba(255,255,255,0.10); margin:12px 0}
    .muted{color:var(--muted); font-size:12px; margin-top:10px}
  
    .thinkingDots{display:inline-flex; gap:4px; align-items:center}
    .thinkingDots span{
      width:7px; height:7px; border-radius:999px; background:rgba(226,232,240,0.9);
      display:inline-block; animation:dotPulse 1s infinite ease-in-out;
    }
    .thinkingDots span:nth-child(2){animation-delay:0.15s}
    .thinkingDots span:nth-child(3){animation-delay:0.30s}
    @keyframes dotPulse{
      0%, 80%, 100%{ transform: translateY(0); opacity:0.55 }
      40%{ transform: translateY(-4px); opacity:1 }
    }

</style>
</head>
<body>
<div class="wrap">
<div class="row">
<div class="title">
<div class="logo glass">
<img alt="AI" onerror="this.style.display='none'; document.getElementById('aiIconFallback').style.display='block'" src="Ask ai.png"/>
<span id="aiIconFallback" style="display:none; font-size:22px;">ğŸ¤–</span>
</div>
<div>
<h1 class="h1">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ (Dental Radiology AI Assistant)</h1>
<p class="sub">Ø§Ø³Ø£Ù„ ÙÙŠ Ø£Ø´Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†ØŒ ØªÙ‚Ø±ÙŠØ±ØŒ ØªÙØ³ÙŠØ± Ø¹Ù„Ø§Ù…Ø§ØªØŒ Ø£Ùˆ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª ØªØ´Ø®ÙŠØµÙŠØ©.</p>
</div>
</div>
<button class="btn glass" onclick="goBack()">â¬… Back to Dashboard</button>
</div>
<div class="grid">
<div>
<div class="card glass chatBox">
<div class="chat" id="chat"></div>
<div class="inputRow">
<div style="flex:1; min-width:260px">
<textarea id="q" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
</div>
<button class="send" id="sendBtn" onclick="send()">Send</button>
</div>
<div class="meta">
<label style="display:flex; gap:8px; align-items:center;">
<span style="opacity:.85">Specialty</span>
<select id="topic" style="padding:6px 8px; border-radius:10px; border:1px solid var(--border); background:rgba(15,23,42,0.55); color:#fff;">
<option selected="" value="general">General Dental Radiology</option>
<option value="cbct">CBCT</option>
<option value="panorama">Panoramic</option>
<option value="ceph">Cephalometric</option>
<option value="endo">Endodontics</option>
<option value="ortho">Orthodontics</option>
<option value="implants">Implants</option>
</select>
</label>
<label style="display:flex; gap:8px; align-items:center;">
<input checked="" id="incWarn" type="checkbox"/>
<span>Add â€œnot a diagnosisâ€ disclaimer</span>
</label>
<button class="btn" onclick="clearChat()" style="padding:8px 10px; border-radius:12px;" type="button">ğŸ§¹ Clear</button>
<span class="mono" id="status" style="margin-inline-start:auto"></span>
</div>
</div>
<div class="muted">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙ‚Ø¯Ù… Ø¯Ø¹Ù…Ù‹Ø§ Ø¹Ù„Ù…ÙŠÙ‹Ø§ Ù„Ù„Ø·Ø¨ÙŠØ¨ ÙˆÙ„Ø§ ÙŠÙØ¹Ø¯ ØªØ´Ø®ÙŠØµÙ‹Ø§ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙŠÙ„Ø²Ù… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ ÙˆØ§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©.
        </div>
</div>
</div>
</div>
<script>
  // RRZ Ask AI (Independent Chat) â€” uses Netlify AI gateway: /.netlify/functions/ai
  const LS_KEY = 'rrz_askai_chat_v2';

  
  let isThinking = false;
function goBack(){ window.location.href = 'dashboard.html'; }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  // We store only UI-visible messages
  function loadChat(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(e){ return []; }
  }
  function saveChat(arr){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(arr||[])); }catch(e){}
  }

  // Internal messages to send upstream (role: user/assistant)
  // We keep a hidden first user message that acts like a "system" instruction.
  function topicSystemText(topic){
    switch(String(topic||'general')){
      case 'cbct':
        return "You are a dental radiology assistant specialized in CBCT. Answer clinically, mention relevant anatomy, imaging pitfalls, differential diagnosis, and recommended next steps. Be concise and structured.";
      case 'panorama':
        return "You are a dental radiology assistant specialized in panoramic imaging. Answer clinically, mention common artifacts/overlap, differential diagnosis, and recommended next steps. Be concise and structured.";
      case 'ceph':
        return "You are an orthodontic imaging assistant specialized in cephalometry. Answer with orthodontic relevance, link findings to treatment considerations, and be structured.";
      case 'endo':
        return "You are an endodontic-focused dental radiology assistant. Emphasize periapical pathology, root morphology, resorption, and endo decision-making.";
      case 'ortho':
        return "You are an orthodontics assistant. Focus on orthodontic diagnosis, biomechanics considerations, and treatment options.";
      case 'implants':
        return "You are an implant planning assistant. Focus on bone volume, critical structures, implant safety margins, and staged recommendations.";
      default:
        return "You are a dental radiology assistant. Answer clinically, be concise, and structure your response (Findings/Impression/Recommendations when appropriate).";
    }
  }

  function buildUpstreamMessages(uiMsgs){
    const topic = document.getElementById('topic')?.value || 'general';
    const sys = topicSystemText(topic);
    const upstream = [{ role: 'user', content: `SYSTEM:\n${sys}` }];

    (uiMsgs||[]).forEach(m=>{
      if(!m || !m.role) return;
      if(m.role === 'user' || m.role === 'assistant'){
        upstream.push({ role: m.role, content: String(m.content||'') });
      }
    });

    // Optional disclaimer request appended to the latest user message context
    const incWarn = document.getElementById('incWarn')?.checked;
    if (incWarn){
      upstream.push({ role:'user', content: "At the end, add a brief disclaimer: 'Not a final diagnosis; correlate clinically and with imaging context.'"});
    }
    return upstream;
  }

  function render(){
    const chat = document.getElementById('chat');
    const msgs = loadChat();
    if(!msgs.length){
      chat.innerHTML = `
        <div class="msg msg-ai">
          <div class="who">AI</div>
          <div>Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø­Ø± ÙÙŠ ÙØ±ÙˆØ¹ Ø£Ø´Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù† (CBCT / Panorama / Ceph / Endo / Implantsâ€¦)ØŒ ÙˆØ³Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù…Ø«Ù„ ChatGPT.</div>
          <div style="margin-top:8px; opacity:.8; font-size:12px;">Tip: ØºÙŠÙ‘Ø± Specialty Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„ ØªØ®ØµØµÙŠ.</div>
        </div>
      `;
      return;
    }
    let html = msgs.map(m=>{
      const cls = m.role === 'user' ? 'msg msg-user' : 'msg msg-ai';
      const who = m.role === 'user' ? 'You' : 'AI';
      return `
        <div class="${cls}">
          <div class="who">${who}</div>
          <div class="txt">${escapeHtml(m.content).replace(/\n/g,'<br>')}</div>
        </div>
      `;
    }).join('');
    if(isThinking){
      html += `
        <div class="msg msg-ai">
          <div class="who">AI</div>
          <div class="txt"><span class="thinkingDots"><span></span><span></span><span></span></span></div>
        </div>
      `;
    }
    chat.innerHTML = html;

    chat.scrollTop = chat.scrollHeight;
  }

  function setStatus(t){
    const s = document.getElementById('status');
    if(s) s.textContent = t || '';
  }

  function clearChat(){
    saveChat([]);
    render();
  }

  async function send(){
    const input = document.getElementById('q');
    const val = (input?.value || '').trim();
    if(!val) return;

    const msgs = loadChat();
    msgs.push({ role:'user', content: val, at: Date.now() });
    saveChat(msgs);
    input.value = '';
    render();

    try{
      isThinking = true; render();
      const upstreamMessages = buildUpstreamMessages(msgs);

      const resp = await fetch('/.netlify/functions/ai', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ messages: upstreamMessages })
      });

      const data = await resp.json().catch(()=> ({}));
      if(!resp.ok || !data || data.ok === false){
        throw new Error(data?.error || `HTTP ${resp.status}`);
      }

      // Normalize text from gateway
      const text = data.text || data?.raw?.choices?.[0]?.message?.content || '';
      isThinking = false;
      msgs.push({ role:'assistant', content: text, at: Date.now() });
      saveChat(msgs);
      render();
      setStatus('');
    }catch(e){
      isThinking = false;
      console.warn(e);
      const msgs2 = loadChat();
      msgs2.push({ role:'assistant', content: "âŒ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ AI. Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.", at: Date.now() });
      saveChat(msgs2);
      render();
      setStatus('');
    }
  }

  // Enter to send
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){
      const a = document.activeElement;
      if(a && a.id === 'q'){ e.preventDefault(); send(); }
    }
  });

  // initial render
  render();
</script>
</body>
</html>
