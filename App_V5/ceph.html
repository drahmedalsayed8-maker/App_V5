<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Royal Ray Zone | Cephalometric Analysis</title>
  <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="shared/aiClient.js" defer></script>
  <style>
    :root { 
      --primary: #1a3c5a; 
      --accent: #3498db; 
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --bg-dark: #0f172a;
      --gold: #c5a059;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); color: white; overflow: hidden; }

    .en-text { direction: ltr; display: inline-block; text-align: left; }

    #main-home { 
      display: flex; justify-content: center; align-items: center; height: 100vh; 
      background: linear-gradient(rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.8)), url('a.jpg') center/cover no-repeat;
    }
    .container { background: rgba(255, 255, 255, 0.95); padding: 35px; border-radius: 30px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); color: var(--primary); border: 2px solid var(--gold); }
    
    .upload-group { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
    
    .upload-btn { 
      display: block; width: 100%; padding: 14px; background: #f8fafc; 
      border: 2px solid #e2e8f0; border-radius: 15px; color: var(--primary); 
      font-weight: 600; cursor: pointer; transition: 0.3s; text-align: center;
      text-decoration: none;
    }
    .upload-btn:hover { border-color: var(--accent); background: #f0f9ff; }

    /* === NEW: Calibration View === */
    #calibration-view { 
      display: none; height: 100vh; flex-direction: column; background: #000; 
      position: relative; align-items: center; justify-content: center; 
    }
    .calibration-header { 
      padding: 15px 25px; background: var(--primary); border-bottom: 2px solid var(--gold);
      width: 100%; text-align: center; color: var(--gold); font-weight: bold; 
    }
    .calibration-container { 
      display: flex; gap: 20px; padding: 20px; 
      justify-content: center; align-items: center; flex-wrap: wrap;
    }
    .calibration-canvas-wrapper { 
      position: relative; border: 2px solid var(--gold); 
      border-radius: 10px; overflow: hidden; 
    }
    .calibration-controls { 
      background: rgba(15,23,42,0.9); padding: 20px; border-radius: 15px; 
      min-width: 300px; max-width: 400px; border: 1px solid rgba(197,160,89,0.3);
    }
    .calibration-btn { 
      width: 100%; padding: 16px; margin: 8px 0; border: none; 
      border-radius: 12px; font-weight: bold; cursor: pointer; 
      transition: 0.3s; font-size: 14px;
    }
    .calibration-btn.manual { 
      background: linear-gradient(45deg, #3498db, #1a3c5a); 
      color: white; 
    }
    .calibration-btn.auto { 
      background: linear-gradient(45deg, #27ae60, #1a3c5a); 
      color: white; 
    }
    .calibration-btn.apply { 
      background: var(--gold); color: #0b1220; 
    }
    .calibration-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .distance-input { 
      width: 100%; padding: 10px; margin: 10px 0; 
      border: 1px solid var(--gold); border-radius: 8px; 
      background: rgba(255,255,255,0.1); color: white; 
      font-size: 14px; text-align: center;
    }
    .distance-input::placeholder { color: rgba(255,255,255,0.5); }
    .calibration-info { 
      color: var(--gold); font-size: 12px; margin-top: 10px; 
      line-height: 1.5; text-align: center;
    }

    #analysis-view { display: none; height: 100vh; flex-direction: column; background: #000; position: relative; }
    .engine-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: var(--primary); border-bottom: 2px solid var(--gold); }
    
    .floating-footer { 
      position: absolute; bottom: 45px; left: 0; width: 100%; 
      display: flex; justify-content: center; z-index: 10;
    }

    #canvas-container-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; }

    #analysis-board { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 1500; display: none; flex-direction: column; }
    .board-grid { display: grid; grid-template-columns: 1fr 350px; height: calc(100% - 130px); padding: 20px; gap: 20px; }
    .preview-box { background: #000; border-radius: 15px; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px solid var(--gold); }
    .preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    .data-box { background: #1e293b; border-radius: 15px; padding: 20px; overflow-y: auto; border: 1px solid #334155; }
    .data-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; font-size: 14px; direction: ltr; color: white; }

    #finalReport { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #e2e8f0; color: #1e293b; z-index: 2000; display: none; overflow-y: auto; padding: 30px 10px; }
    .report-card { 
      max-width: 700px; margin: 0 auto; background: white; 
      border-radius: 0; box-shadow: 0 0 40px rgba(0,0,0,0.2); 
      border: 15px solid white; outline: 2px solid var(--primary);
      position: relative; padding-bottom: 40px;
    }
    .report-header { text-align: center; border-bottom: 3px double var(--gold); padding-bottom: 15px; margin-bottom: 25px; }
    .report-header h1 { color: var(--primary); font-size: 28px; letter-spacing: 2px; }
    
    .report-body { padding: 0 30px; display: grid; grid-template-columns: 1fr; gap: 20px; }
    .report-section { background: #fdfdfd; padding: 15px; border-left: 5px solid var(--primary); border-radius: 0 10px 10px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
    .report-section h3 { color: var(--primary); margin-bottom: 12px; font-size: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    
    .report-item { margin: 8px 0; font-size: 15px; display: flex; justify-content: space-between; direction: ltr; }
    .status-badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
    .normal { color: var(--success); font-weight: bold; }
    .abnormal { color: var(--danger); font-weight: bold; }

    .btn-group { padding: 25px 15px 50px 15px; background: #1e293b; display: flex; justify-content: center; gap: 10px; border-top: 1px solid #334155; }
    .action-btn { padding: 14px 28px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
    
    @media (max-width: 768px) { .board-grid { grid-template-columns: 1fr; } .report-card { width: 95%; } }

    /* === RRZ Add-on: Landmark sidebar + Report pages === */
    .lm-sidebar{
      position: absolute;
      top: 72px;
      left: 12px;
      width: 260px;
      max-height: calc(100vh - 170px);
      overflow: auto;
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(197,160,89,0.55);
      border-radius: 14px;
      padding: 10px;
      z-index: 60;
      backdrop-filter: blur(10px);
    }
    .lm-sidebar h4{ margin: 0 0 10px 0; color: var(--gold); font-size: 12px; letter-spacing: 1px; }
    .lm-group{ margin: 10px 0 14px 0; }
    .lm-group-title{
      font-size: 15px;
      font-weight: 900;
      color: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, rgba(197,160,89,0.30), rgba(52,152,219,0.18));
      border: 1px solid rgba(197,160,89,0.38);
      margin: 14px 0 10px 0;
      letter-spacing: 0.3px;
    }
    
    .lm-item{
      display:flex; align-items:flex-start; gap:10px; padding: 8px 8px;
      border-radius: 10px; cursor: pointer; transition: .15s;
      border: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px;
    }
    /* ===== RRZ V23 PATCH: Pending landmark selection (sidebar -> click on image) ===== */
    .lm-item.pending{
      outline: 2px dashed var(--gold);
      background: rgba(197,160,89,0.18) !important;
    }
    .lm-item.pending .lm-badge{
      box-shadow: 0 0 0 3px rgba(197,160,89,0.22);
    }

    .lm-item:hover{ background: rgba(197,160,89,0.18); border-color: rgba(197,160,89,0.35); }
    .lm-badge{
      min-width: 44px; text-align:center; padding: 4px 8px;
      border-radius: 10px; font-weight: 900; font-size: 12px;
      color:#0b1220; background: rgba(255,255,255,0.9);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .lm-full{ font-size: 11px; line-height: 1.35; color: #e5e7eb; direction: ltr; text-align:left; opacity: .95; }

    .rp-nav{ display:flex; gap:8px; justify-content:center; margin: 10px 0 12px 0; flex-wrap: wrap; }
    .rp-btn{
      padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06); color: #e5e7eb; cursor:pointer;
      font-weight: 800; font-size: 12px; transition: .18s;
    }
    
    .rrzBackWrap{ display:flex; justify-content:flex-start; margin:10px 0; }
    .rrzBackBtn{ border:1px solid var(--gold); background:transparent; color:var(--gold); padding:6px 12px; border-radius:10px; cursor:pointer; font-weight:700; white-space:nowrap; }
    .rrzBackBtn:hover{ background: rgba(212,175,55,0.12); }
    .rp-btn.active{ background: rgba(197,160,89,0.92); border-color: rgba(197,160,89,0.92); color:#0b1220; }
    .rp-page{ display:none; }
    .rp-page.active{ display:block; }

    /* === RRZ V5.1 patch: place Go Back at bottom-left of each analysis sub-page (sidebar) === */
    #analysis-board .rp-page{ position: relative; padding-bottom: 64px; }
    #analysis-board .rp-page .rrzBackWrap{ position: absolute; bottom: 12px; left: 12px; margin: 0; }

    /* === RRZ Patch: ensure Final Report button is always visible === */
    #analysis-board{ overflow:hidden; }
    #analysis-board .board-grid{ flex:1; height:auto !important; min-height:0; }
    #analysis-board .btn-group{ flex:0 0 auto; padding-bottom:20px; }
    .rrz-final-fab{
      position:absolute; bottom:16px; left:50%; transform:translateX(-50%); z-index:1600;
      padding:12px 18px; border-radius:999px; border:1px solid rgba(197,160,89,0.9);
      background:rgba(197,160,89,0.95); color:#0b1220; font-weight:900; cursor:pointer;
      box-shadow:0 14px 28px rgba(0,0,0,0.45);
    }
    .rrz-final-fab:hover{ filter:brightness(1.02); }

    /* === NEW: Zoom & Pan Controls === */
    .zoom-controls {
      position: absolute; top: 80px; right: 20px;
      display: flex; flex-direction: column; gap: 8px; z-index: 100;
    }
    .zoom-btn {
      width: 42px; height: 42px; border-radius: 12px;
      background: rgba(15, 23, 42, 0.9); border: 1px solid var(--gold);
      color: var(--gold); font-size: 18px; font-weight: bold;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(5px); transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .zoom-btn:hover { background: var(--gold); color: #0b1220; }
    .zoom-btn.active { background: var(--success); color: white; border-color: var(--success); }

    /* === RRZ V4: Header actions (Generate + Final) === */
    .rrzHeaderActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: nowrap;
    }
    .rrzHdrBtn{
      padding:8px 14px;
      border-radius:30px;
      border:1px solid var(--gold);
      background:rgba(255,255,255,0.08);
      color:white;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      transition:0.15s;
      white-space:nowrap;
    }
    .rrzHdrBtn:hover{ background:rgba(197,160,89,0.18); }
    .rrzHdrBtn.primary{
      background: rgba(197,160,89,0.92);
      border-color: rgba(197,160,89,0.92);
      color:#0b1220;
    }
    /* Print helpers */
    @media print{
      body{ background:white !important; }
      .no-print{ display:none !important; }
    }

    /* === NEW: ÿ£ŸÜŸÖÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ === */
    .rp-btn.comprehensive {
      background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1);
      color: white;
    }

    .rrzTable {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }

    .rrzTable th {
      background: #1e293b;
      color: var(--gold);
      padding: 8px;
      text-align: left;
    }

    .rrzTable td {
      padding: 8px;
      border-bottom: 1px solid #334155;
    }

    .angle-label {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px;
    }

    .angle-normal {
      background: rgba(39, 174, 96, 0.2);
      color: #27ae60;
    }

    .angle-abnormal {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    /* === NEW: ÿ£ŸÜŸÖÿßÿ∑ ŸÑÿµŸÅÿ≠ÿ© 12 Angles === */
    .comp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .comp-item {
      background: rgba(30, 41, 59, 0.5);
      padding: 10px;
      border-radius: 8px;
      border-left: 4px solid var(--gold);
    }

    .comp-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--gold);
      text-align: center;
      margin-top: 5px;
    }

    /* ===== RRZ V6: Active Landmark Item Style ===== */
    .lm-item.active {
      background: rgba(197,160,89,0.25) !important;
      border-color: rgba(197,160,89,0.6) !important;
      box-shadow: 0 0 10px rgba(197,160,89,0.3) !important;
    }
    
    /* ===== RRZ V8: Treatment Planner Styles ===== */
    /* ===== RRZ V24 PATCH: Treatment Planner Upload/Export Buttons ===== */
    .tpUploadBtn{
      position:absolute;
      right:14px;
      bottom:14px;
      z-index:5;
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(197,160,89,0.65);
      background: linear-gradient(135deg, rgba(197,160,89,0.18), rgba(15,23,42,0.85));
      color:#fff;
      font-weight:700;
      font-size:13px;
      letter-spacing:0.2px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    .tpUploadBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(197,160,89,0.95);
      box-shadow: 0 14px 28px rgba(0,0,0,0.45);
      background: linear-gradient(135deg, rgba(197,160,89,0.26), rgba(15,23,42,0.88));
    }
    .tpUploadBtn:active{ transform: translateY(0px) scale(0.99); }

    .tpExportBtn{
      background: linear-gradient(135deg, rgba(197,160,89,0.20), rgba(197,160,89,0.06));
      color: #fff;
      border: 1px solid rgba(197,160,89,0.7);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: 0.2px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      margin-right: 10px;
    }
    .tpExportBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(197,160,89,0.95);
      box-shadow: 0 14px 28px rgba(0,0,0,0.35);
    }
    /* =============================================================== */

    #treatment-planner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f172a;
      z-index: 2500;
      overflow-y: auto;
      padding: 20px;
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .tool-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: var(--gold) !important;
    }

    .tool-item.selected {
      border-color: var(--success) !important;
      background: rgba(39, 174, 96, 0.1) !important;
    }

    .elastic-btn {
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .elastic-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .elastic-btn.selected {
      border-color: white;
      box-shadow: 0 0 0 3px var(--gold);
    }

    .treatment-canvas-tool {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--gold);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: bold;
      pointer-events: none;
      z-index: 100;
    }

    /* Treatment Plan Status Indicators */
    .plan-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
    }

    .plan-status.draft {
      background: #f39c12;
      color: white;
    }

    .plan-status.active {
      background: #27ae60;
      color: white;
    }

    .plan-status.completed {
      background: #3498db;
      color: white;
    }

    /* Treatment Timeline */
    .timeline-item {
      position: relative;
      padding-left: 20px;
      margin-bottom: 15px;
      border-left: 3px solid var(--accent);
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* Responsive Treatment Planner */
    @media (max-width: 1024px) {
      #treatment-planner > div > div {
        grid-template-columns: 1fr !important;
        height: auto !important;
      }
      
      #treatment-planner > div {
        padding: 15px !important;
      }
    }

    @media (max-width: 768px) {
      #treatment-planner {
        padding: 10px !important;
      }
      
      .elastic-btn {
        font-size: 14px;
      }
    }

    /* Notification Animations */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>
</head>
<body>

<div id="main-home">
  <div class="container">
    <h1 style="font-size: 36px; margin-bottom: 0; letter-spacing: 1px;">Royal</h1>
    <p style="color:var(--gold); letter-spacing:6px; font-weight: bold; margin-bottom: 20px;">RAY ZONE</p>

    <div class="upload-group">
      <label for="imgLoader" id="btnUploadCeph" class="upload-btn" role="button" tabindex="0">‚ò† Upload Cephalometric</label>
      <input type="file" id="imgLoader" accept="image/*" style="display:none">
    </div>

    <p style="margin-top: 25px; font-size: 12px; color: #94a3b8;">CephPro Elite v3.0 | 12 Angles Complete</p>
  </div>
</div>

<!-- ===================== CALIBRATION MODULE (NEW) ===================== -->
<div id="calibration-view">
  <div class="calibration-header">
    <span>üìè Photo Calibration</span>
    <span style="font-size: 12px;">Select calibration method to ensure accurate measurements</span>
  </div>
  <div class="calibration-container">
    <div class="calibration-canvas-wrapper">
      <canvas id="calibrationCanvas"></canvas>
    </div>
    <div class="calibration-controls">
      <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">Calibrate Image</h3>
      
      <button class="calibration-btn manual" onclick="manualCalibration()">
        üéØ Manual Calibration
      </button>
      <div class="calibration-info">
        Place two points on a known distance, then enter the real measurement
      </div>
      
      <input type="number" id="calibrationDistance" class="distance-input" placeholder="Enter real distance (mm)" min="1" max="200" style="display:none;">
      
      <button class="calibration-btn apply" id="applyCalibrationBtn" onclick="applyCalibration()" style="display:none;">
        ‚úì Apply Calibration
      </button>
      
      <button class="calibration-btn auto" onclick="autoCalibration()">
        ü§ñ Auto Calibration
      </button>
      <div class="calibration-info">
        Auto-detect scale using standard anatomical references
      </div>
      
      <button class="calibration-btn" style="background: #64748b; color: white; margin-top: 30px;" onclick="skipCalibration()">
        ‚è≠Ô∏è Skip & Use Default (1.0x)
      </button>
    </div>
  </div>
</div>

<!-- ===================== CEPHALOMETRIC MODULE ===================== -->
<div id="analysis-view">
  <button class="rrzHomeFab" onclick="showHome()">‚Üê Home</button>
  <div class="engine-header">
    <button onclick="showHome()" style="color:white; background:none; border:none; cursor:pointer; font-size: 18px;">‚úñ</button>
    <span style="font-weight: bold; color: var(--gold);">ANALYSIS MODE</span>
    <div class="rrzHeaderActions">
      <button class="rrzHdrBtn primary" onclick="generateAnalysis()">Generate Report üìê</button>
    </div>
  </div>
  
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="togglePan()" id="btnPan" title="Move Image">‚úã</button>
    <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">‚ûï</button>
    <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚ûñ</button>
    <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">‚ü≤</button>
  </div>

  <div id="canvas-container-wrapper"><canvas id="mainCanvas"></canvas></div>
  <div class="lm-sidebar" id="lmSidebar" style="display:none;"><h4>Landmarks</h4><div id="lmList"></div>
    <button id="btnCephRefSidebar" class="lm-ref-btn no-print" onclick="openCephReference()" style="width:100%; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(197,160,89,0.55); background:linear-gradient(90deg, rgba(52,152,219,0.20), rgba(197,160,89,0.25)); color:#fff; font-weight:900; letter-spacing:.3px; cursor:pointer;">REFERENCE CEPHALOMETRIC IMAGE</button>
</div>

  <div class="floating-footer" style="display:none;">
    <button onclick="generateAnalysis()" class="action-btn" style="background:var(--gold); color:white; min-width: 250px; box-shadow: 0 10px 20px rgba(0,0,0,0.4);">Generate Report üìê</button>
  </div>
</div>

<div id="analysis-board">
  <button class="rrzHomeFab" onclick="showHome()">‚Üê Home</button>
  <div class="engine-header">
    <span>Digital Measurements</span>
    <div class="rrzHeaderActions">
      <button class="rrzHdrBtn primary" onclick="generateAnalysis()">Generate Report üìê</button>
      <button class="rrzHdrBtn" onclick="closeAnalysis()">Edit Points</button>
    </div>
  </div>
  <div class="board-grid" id="captureBoard">
    <div class="preview-box" id="resultPreview"></div>
    <div class="data-box">
      <h3 style="color: var(--gold); margin-bottom:15px; text-align: center;">Cephalometric Data</h3>
      <div class="rp-nav">
        <button class="rp-btn active" id="btn_rp_quick" onclick="showReportPage('rp_quick')">Quick</button>
        <button class="rp-btn" id="btn_rp_steiner" onclick="showReportPage('rp_steiner')">Steiner</button>
        <button class="rp-btn" id="btn_rp_downs" onclick="showReportPage('rp_downs')">Downs</button>
        <button class="rp-btn" id="btn_rp_eastman" onclick="showReportPage('rp_eastman')">Eastman</button>
        <button class="rp-btn" id="btn_rp_jarabak" onclick="showReportPage('rp_jarabak')">Jarabak</button>
        <button class="rp-btn" id="btn_rp_tweed" onclick="showReportPage('rp_tweed')">Tweed</button>
        <button class="rp-btn comprehensive" id="btn_rp_comprehensive" onclick="showReportPage('rp_comprehensive')">12 Angles</button>
        <!-- New button for occlusion analysis -->
        <button class="rp-btn" id="btn_rp_occlusion" onclick="showReportPage('rp_occlusion')">Occlusion</button>
      </div>
      
      <div class="rp-page active" id="rp_quick">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div><div style="margin:8px 0 10px 0; font-size:12px; color:#cbd5e1; text-align:center;">Quick Angles</div>
        <div class="data-row"><span>SNA Angle (Maxilla)</span> <span id="b_sna" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>SNB Angle (Mandible)</span> <span id="b_snb" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>ANB Angle (Relation)</span> <span id="b_anb" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>FMA (FH to Mand. Plane)</span> <span id="b_fma" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>Interincisal Angle</span> <span id="b_inter" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>Molar Relation (U6M - L6M)</span> <span id="b_molar_mm" style="color:var(--accent)">-</span></div>
        <div class="data-row"><span>Molar Class</span> <span id="b_molar_class" style="color:var(--accent)">-</span></div>
      </div>
      
      <div class="rp-page" id="rp_steiner">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Steiner Analysis - All Measurements</div>
        <div class="data-row"><span>SNA Angle</span> <span id="st_sna">-</span></div>
        <div class="data-row"><span>SNB Angle</span> <span id="st_snb">-</span></div>
        <div class="data-row"><span>ANB Angle</span> <span id="st_anb">-</span></div>
        <div class="data-row"><span>Occlusal Plane to SN</span> <span id="st_op_sn">-</span></div>
        <div class="data-row"><span>Mandibular Plane to SN</span> <span id="st_mp_sn">-</span></div>
        <div class="data-row"><span>U1 to NA (Angle)</span> <span id="st_u1na_ang">-</span></div>
        <div class="data-row"><span>U1 to NA (mm)</span> <span id="st_u1na_mm">-</span></div>
        <div class="data-row"><span>L1 to NB (Angle)</span> <span id="st_l1nb_ang">-</span></div>
        <div class="data-row"><span>L1 to NB (mm)</span> <span id="st_l1nb_mm">-</span></div>
        <div class="data-row"><span>Interincisal Angle</span> <span id="st_inter">-</span></div>
        <!-- Additional Steiner Measurements -->
        <div class="data-row"><span>Facial Angle (Steiner)</span> <span id="st_facial">-</span></div>
        <div class="data-row"><span>Y-Axis (Steiner)</span> <span id="st_yaxis">-</span></div>
        <div class="data-row"><span>Convexity (Steiner)</span> <span id="st_convexity">-</span></div>
        <div class="data-row"><span>Upper Lip to E-Line</span> <span id="st_ul_eline">-</span></div>
        <div class="data-row"><span>Lower Lip to E-Line</span> <span id="st_ll_eline">-</span></div>
        <div class="rrzLmBlock" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.06); border:1px solid rgba(197,160,89,0.35); border-radius:10px;">
          <div style="font-weight:900; color:var(--gold); font-size:12px; margin-bottom:6px;">Required Landmarks</div>
          <div id="rp_lm_steiner"></div>
        </div>
      </div>
      
      <div class="rp-page" id="rp_downs">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Downs Analysis - All Measurements</div>
        <div class="data-row"><span>Facial Angle</span> <span id="dn_facial">-</span></div>
        <div class="data-row"><span>Angle of Convexity</span> <span id="dn_convex">-</span></div>
        <div class="data-row"><span>Mandibular Plane Angle</span> <span id="dn_mp">-</span></div>
        <div class="data-row"><span>Y-Axis</span> <span id="dn_yaxis">-</span></div>
        <div class="data-row"><span>Cant of Occlusal Plane</span> <span id="dn_cant_op">-</span></div>
        <div class="data-row"><span>Interincisal Angle</span> <span id="dn_inter">-</span></div>
        <div class="data-row"><span>Incisor Occlusal Plane Angle</span> <span id="dn_inc_occl">-</span></div>
        <div class="data-row"><span>Incisor Mandibular Plane Angle</span> <span id="dn_inc_mp">-</span></div>
        <div class="data-row"><span>Upper Incisor to A-Pog Line</span> <span id="dn_u1_apog">-</span></div>
        <div class="data-row"><span>Lower Incisor to A-Pog Line</span> <span id="dn_l1_apog">-</span></div>
        <div class="data-row"><span>Gonial Angle (Downs)</span> <span id="dn_gonial">-</span></div>
        <div class="data-row"><span>Saddle Angle (Downs)</span> <span id="dn_saddle">-</span></div>
        <div class="data-row"><span>Articular Angle (Downs)</span> <span id="dn_articular">-</span></div>
        <div class="rrzLmBlock" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.06); border:1px solid rgba(197,160,89,0.35); border-radius:10px;">
          <div style="font-weight:900; color:var(--gold); font-size:12px; margin-bottom:6px;">Required Landmarks</div>
          <div id="rp_lm_downs"></div>
        </div>
      </div>
      
      <div class="rp-page" id="rp_eastman">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Eastman Analysis - All Measurements</div>
        <div class="data-row"><span>SNA Angle (Eastman)</span> <span id="ea_sna">-</span></div>
        <div class="data-row"><span>SNB Angle (Eastman)</span> <span id="ea_snb">-</span></div>
        <div class="data-row"><span>ANB Angle (Eastman)</span> <span id="ea_anb">-</span></div>
        <div class="data-row"><span>SN to Maxillary Plane</span> <span id="ea_sn_mx">-</span></div>
        <div class="data-row"><span>Wits Appraisal</span> <span id="ea_wits">-</span></div>
        <div class="data-row"><span>U1 to Maxillary Plane Angle</span> <span id="ea_u1_mx">-</span></div>
        <div class="data-row"><span>L1 to Mandibular Plane Angle</span> <span id="ea_l1_mp">-</span></div>
        <div class="data-row"><span>Interincisal Angle (Eastman)</span> <span id="ea_inter">-</span></div>
        <div class="data-row"><span>Maxillary-Mandibular Planes Angle</span> <span id="ea_mx_mp">-</span></div>
        <div class="data-row"><span>Upper Anterior Face Height</span> <span id="ea_uafh">-</span></div>
        <div class="data-row"><span>Lower Anterior Face Height</span> <span id="ea_lafh">-</span></div>
        <div class="data-row"><span>Lower AFH Ratio</span> <span id="ea_lafh_ratio">-</span></div>
        <div class="data-row"><span>L1 to A-Pog (Eastman)</span> <span id="ea_l1_apog">-</span></div>
        <div class="data-row"><span>Lower Lip to E-Plane (Eastman)</span> <span id="ea_ll_eplane">-</span></div>
        <div class="data-row"><span>Nasolabial Angle</span> <span id="ea_nasolab">-</span></div>
        <div class="data-row"><span>Upper Lip Length</span> <span id="ea_ul_length">-</span></div>
        <div class="data-row"><span>Lower Lip Length</span> <span id="ea_ll_length">-</span></div>
        <div class="rrzLmBlock" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.06); border:1px solid rgba(197,160,89,0.35); border-radius:10px;">
          <div style="font-weight:900; color:var(--gold); font-size:12px; margin-bottom:6px;">Required Landmarks</div>
          <div id="rp_lm_eastman"></div>
        </div>
      </div>
      
      <div class="rp-page" id="rp_jarabak">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Jarabak Analysis - All Measurements</div>
        <div class="data-row"><span>Saddle Angle (N-S-Ar)</span> <span id="ja_saddle">-</span></div>
        <div class="data-row"><span>Articular Angle (S-Ar-Go)</span> <span id="ja_articular">-</span></div>
        <div class="data-row"><span>Gonial Angle (Ar-Go-Me)</span> <span id="ja_gonial">-</span></div>
        <div class="data-row"><span>Bjork Sum</span> <span id="ja_bjork_sum">-</span></div>
        <div class="data-row"><span>Anterior Cranial Base Length (S-N)</span> <span id="ja_sn">-</span></div>
        <div class="data-row"><span>Posterior Cranial Base Length (S-Ar)</span> <span id="ja_sar">-</span></div>
        <div class="data-row"><span>Upper Gonial Angle</span> <span id="ja_upper_gonial">-</span></div>
        <div class="data-row"><span>Lower Gonial Angle</span> <span id="ja_lower_gonial">-</span></div>
        <div class="data-row"><span>Ramus Height (Ar-Go)</span> <span id="ja_ramus">-</span></div>
        <div class="data-row"><span>Mandibular Body Length (Go-Me)</span> <span id="ja_body">-</span></div>
        <div class="data-row"><span>Body to Ant. Cranial Base Ratio</span> <span id="ja_body_ratio">-</span></div>
        <div class="data-row"><span>SNA (Jarabak)</span> <span id="ja_sna">-</span></div>
        <div class="data-row"><span>SNB (Jarabak)</span> <span id="ja_snb">-</span></div>
        <div class="data-row"><span>ANB (Jarabak)</span> <span id="ja_anb">-</span></div>
        <div class="data-row"><span>SN to Go-Me Angle</span> <span id="ja_sn_gome">-</span></div>
        <div class="data-row"><span>Facial Depth (Jarabak)</span> <span id="ja_facial_depth">-</span></div>
        <div class="data-row"><span>Facial Length on Y Axis</span> <span id="ja_facial_length">-</span></div>
        <div class="data-row"><span>Y Axis to SN Angle</span> <span id="ja_yaxis_sn">-</span></div>
        <div class="data-row"><span>Posterior Facial Height (S-Go)</span> <span id="ja_pfh">-</span></div>
        <div class="data-row"><span>Anterior Facial Height (N-Me)</span> <span id="ja_afh">-</span></div>
        <div class="data-row"><span>Facial Height Ratio (PFH/AFH)</span> <span id="ja_fh_ratio">-</span></div>
        <div class="data-row"><span>Facial Plane (Jarabak)</span> <span id="ja_facial_plane">-</span></div>
        <div class="data-row"><span>Facial Convexity</span> <span id="ja_facial_convexity">-</span></div>
        <div class="data-row"><span>Occlusal Plane to Go-Me Angle</span> <span id="ja_op_gome">-</span></div>
        <div class="data-row"><span>Interincisal Angle (Jarabak)</span> <span id="ja_inter">-</span></div>
        <div class="data-row"><span>U1 to SN Angle</span> <span id="ja_u1_sn">-</span></div>
        <div class="data-row"><span>U1 to Facial Plane (mm)</span> <span id="ja_u1_facial">-</span></div>
        <div class="data-row"><span>Upper Lip to E-Plane (Jarabak)</span> <span id="ja_ul_eplane">-</span></div>
        <div class="data-row"><span>Lower Lip to E-Plane (Jarabak)</span> <span id="ja_ll_eplane">-</span></div>
        <div class="rrzLmBlock" style="margin-top:12px; padding:10px; background:rgba(255,255,255,0.06); border:1px solid rgba(197,160,89,0.35); border-radius:10px;">
          <div style="font-weight:900; color:var(--gold); font-size:12px; margin-bottom:6px;">Required Landmarks</div>
          <div id="rp_lm_jarabak"></div>
        </div>
      </div>

      <div class="rp-page" id="rp_tweed">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Tweed Analysis</div>
        <div class="data-row"><span>FMA</span> <span id="tw_fma">-</span></div>
        <div class="data-row"><span>FMIA</span> <span id="tw_fmia">-</span></div>
        <div class="data-row"><span>IMPA</span> <span id="tw_impa">-</span></div>
        <div style="margin-top:10px; font-size:11px; color:#94a3b8; direction:ltr; text-align:left;">
          Norms (Mean ¬± SD): FMA 25¬±4.0, FMIA 65¬±5.0, IMPA 90¬±3.5
        </div>
      </div>

      
      <div class="rp-page" id="rp_comprehensive">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">12 Key Angles Comprehensive Analysis</div>
        <div class="comp-grid">
          <div class="comp-item"><span>1. SNA Angle</span><div class="comp-value" id="comp_sna">-</div></div>
          <div class="comp-item"><span>2. SNB Angle</span><div class="comp-value" id="comp_snb">-</div></div>
          <div class="comp-item"><span>3. ANB Angle</span><div class="comp-value" id="comp_anb">-</div></div>
          <div class="comp-item"><span>4. FMA Angle</span><div class="comp-value" id="comp_fma">-</div></div>
          <div class="comp-item"><span>5. IMPA Angle</span><div class="comp-value" id="comp_impa">-</div></div>
          <div class="comp-item"><span>6. U1-NA Angle</span><div class="comp-value" id="comp_u1na_ang">-</div></div>
          <div class="comp-item"><span>7. L1-NB Angle</span><div class="comp-value" id="comp_l1nb_ang">-</div></div>
          <div class="comp-item"><span>8. Interincisal Angle</span><div class="comp-value" id="comp_inter">-</div></div>
          <div class="comp-item"><span>9. Gonial Angle</span><div class="comp-value" id="comp_gonial">-</div></div>
          <div class="comp-item"><span>10. Saddle Angle</span><div class="comp-value" id="comp_saddle">-</div></div>
          <div class="comp-item"><span>11. Nasolabial Angle</span><div class="comp-value" id="comp_nasolab">-</div></div>
          <div class="comp-item"><span>12. Facial Angle</span><div class="comp-value" id="comp_facial">-</div></div>
        </div>
      </div>

      <!-- ===== NEW: Occlusion Analysis Page ===== -->
      <div class="rp-page" id="rp_occlusion">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div style="margin:6px 0 8px 0; font-size:12px; color:#cbd5e1; text-align:center;">Occlusion Analysis</div>

        

        <div class="data-row"><span>Overjet</span> <span id="occl_horizontal">-</span></div>
        <div class="data-row"><span>Overbite</span> <span id="occl_vertical">-</span></div>
        <div class="data-row"><span>Open bite</span> <span id="occl_bite_type">-</span></div>
        <div class="data-row"><span>Cross bite</span> <span id="occl_crossbite">-</span></div>
      </div>
    </div>
  </div>
  
  <button class="rrz-final-fab" onclick="showFinalReport()">Final Report View üìÑ</button>
</div>

<!-- ===================== FINAL REPORT MODULE ===================== -->
<div id="finalReport">
  <div class="report-card" id="printableReport">
    <div class="report-header">
      <div class="rrzBackWrap" style="justify-content:flex-end;"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
      <p style="color: var(--gold); font-weight: bold;">ROYAL RAY ZONE</p>
      <h1>CEPHALOMETRIC ANALYSIS</h1>
      <p style="font-size: 12px; color: #666;">Date: <span id="reportDate"></span> | Case ID: #RYL-2024 | Patient: <span id="reportPatientName">--</span></p>
    </div>

    <div class="report-body">
      <div class="report-section">
        <h3>Skeletal Analysis <span>üíÄ</span></h3>
        <div class="report-item"><span>Maxillary Position (SNA)</span> <span id="r_sna_status">--</span></div>
        <div class="report-item"><span>Mandibular Position (SNB)</span> <span id="r_snb_status">--</span></div>
        <div class="report-item"><span>Maxillo-Mandibular (ANB)</span> <span id="r_anb_status">--</span></div>
        <div class="report-item"><span>Facial Angle (Downs)</span> <span id="r_facial_down">--</span></div>
        <div class="report-item"><span>Angle of Convexity (Downs)</span> <span id="r_convexity">--</span></div>
        <div class="report-item"><span>Y-Axis (Downs)</span> <span id="r_yaxis">--</span></div>
      </div>

      <div class="report-section" style="border-left-color: var(--success);">
        <h3>Dental Analysis <span>ü¶∑</span></h3>
        <div class="report-item"><span>Interincisal Angle</span> <span id="r_inter_val">--</span></div>
        <div class="report-item"><span>Upper Incisor to NA</span> <span id="r_u1na_status">--</span></div>
        <div class="report-item"><span>Lower Incisor to NB</span> <span id="r_l1nb_status">--</span></div>
        <div class="report-item"><span>IMPA (L1-Mand Plane)</span> <span id="r_impa_status">--</span></div>
        <div class="report-item"><span>U1 to A-Pog (Downs)</span> <span id="r_u1_apog">--</span></div>
        <div class="report-item"><span>L1 to A-Pog (Eastman)</span> <span id="r_l1_apog">--</span></div>
        <div class="report-item"><span>Molar Relation (U6M - L6M)</span> <span id="r_molar_relation">--</span></div>
        <!-- New occlusion analysis items -->
<div class="report-item"><span>Overjet</span> <span id="r_ui_inclination">--</span></div>
        <div class="report-item"><span>Overbite</span> <span id="r_li_inclination">--</span></div>
        <div class="report-item"><span>Open bite</span> <span id="r_bite_type">--</span></div>
        <div class="report-item"><span>Cross bite</span> <span id="r_crossbite_severity">--</span></div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 200px; gap: 20px;">
        <div class="report-section" style="border-left-color: var(--warning);">
          <h3>Soft Tissue <span>üë§</span></h3>
          <div class="report-item"><span>Nasolabial Angle</span> <span id="r_nasolab_status">--</span></div>
          <div class="report-item"><span>Facial Angle</span> <span id="r_facial_status">--</span></div>
          <div class="report-item"><span>Lower AFH Ratio</span> <span id="r_lafh_ratio">--</span></div>
          <div class="report-item"><span>Upper Anterior Face Height</span> <span id="r_uafh">--</span></div>
          <div class="report-item"><span>Lower Anterior Face Height</span> <span id="r_lafh">--</span></div>
          <div class="report-item"><span>Upper Lip to E-Line</span> <span id="r_ul_eline">--</span></div>
          <div class="report-item"><span>Lower Lip to E-Line</span> <span id="r_ll_eline">--</span></div>
        </div>
        <div style="border: 1px solid var(--gold); padding: 5px; background: #000; height: 180px; display: flex; align-items: center; justify-content: center;">
          <img id="reportMiniImg" style="max-width: 100%; max-height: 100%;" src="">
        </div>
      </div>

      <div class="rp-nav" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <button class="rp-btn active" id="btn_fr_written" onclick="showFinalPage('fr_written')">Written Report</button>
        <button class="rp-btn" id="btn_fr_final" onclick="showFinalPage('fr_final')">Final Summary</button>
        <button class="rp-btn" id="btn_fr_downs" onclick="showFinalPage('fr_downs')">Downs</button>
        <button class="rp-btn" id="btn_fr_steiner" onclick="showFinalPage('fr_steiner')">Steiner</button>
        <button class="rp-btn" id="btn_fr_eastman" onclick="showFinalPage('fr_eastman')">Eastman</button>
        <button class="rp-btn" id="btn_fr_jarabak" onclick="showFinalPage('fr_jarabak')">Jarabak</button>
        <button class="rp-btn" id="btn_fr_tweed" onclick="showFinalPage('fr_tweed')">Tweed</button>
        <button class="rp-btn comprehensive" id="btn_fr_comprehensive" onclick="showFinalPage('fr_comprehensive')">12 Angles</button>
        <!-- New button for occlusion report -->
        <button class="rp-btn" id="btn_fr_occlusion" onclick="showFinalPage('fr_occlusion')">Occlusion Analysis</button>
      </div>

      <div class="rp-page active" id="fr_written">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--gold);">
          <h3>Written Report <span>üìù</span></h3>
          <div class="rrzPatientBanner">
            <div style="font-size:12px; font-weight:700; color:#334155; letter-spacing:.2px;">Patient Name</div>
            <div class="name"><span id="wr_patientNameTop">--</span></div>
          </div>

          <div class="report-item"><span>Date</span> <span id="wr_date">--</span></div>
          <div class="report-item"><span>Case ID</span> <span id="wr_case">#RYL-2024</span></div>
          <div class="report-item rrzV9Hide"><span>Generated From</span> <span class="normal">Cephalometric Analysis v3.0</span></div>
        </div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Steiner Analysis <span>üìä</span></h3>
          <div id="tbl_written_steiner" style="direction:ltr;"></div>
        </div>

        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Downs Analysis <span>üìä</span></h3>
          <div id="tbl_written_downs" style="direction:ltr;"></div>
        </div>

        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Eastman Analysis <span>üìä</span></h3>
          <div id="tbl_written_eastman" style="direction:ltr;"></div>
        </div>
        
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Jarabak Analysis <span>üìä</span></h3>
          <div id="tbl_written_jarabak" style="direction:ltr;"></div>
        </div>
      </div>

      <div class="rp-page" id="fr_final">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--gold);">
          <h3>Final Summary Table <span>‚úÖ</span></h3>
          <div id="tbl_final" style="direction:ltr;"></div>
        </div>
      </div>

      <div class="rp-page" id="fr_downs">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Downs Analysis <span>üìä</span></h3>
          <div id="tbl_downs" style="direction:ltr;"></div>
        </div>
      </div>

      <div class="rp-page" id="fr_steiner">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Steiner Analysis <span>üìä</span></h3>
          <div id="tbl_steiner" style="direction:ltr;"></div>
        </div>
      </div>

      <div class="rp-page" id="fr_eastman">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Eastman Analysis <span>üìä</span></h3>
          <div id="tbl_eastman" style="direction:ltr;"></div>
        </div>
      </div>
      
      <div class="rp-page" id="fr_jarabak">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Jarabak Analysis <span>üìä</span></h3>
          <div id="tbl_jarabak" style="direction:ltr;"></div>
        </div>
      </div>

      <div class="rp-page" id="fr_tweed">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--primary);">
          <h3>Tweed Analysis <span>üìä</span></h3>
          <div id="tbl_tweed" style="direction:ltr;"></div>
        </div>
      </div>


      <div class="rp-page" id="fr_comprehensive">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--gold);">
          <h3>12 Key Angles Analysis <span>üìä</span></h3>
          <div id="tbl_comprehensive" style="direction:ltr;"></div>
        </div>
      </div>

      <!-- ===== NEW: Occlusion Analysis Page ===== -->
      <div class="rp-page" id="fr_occlusion">
        <div class="rrzBackWrap"><button class="rrzBackBtn" onclick="rrzGoBack()">Go Back</button></div>
        <div class="report-section" style="border-left-color: var(--success);">
          <h3>Occlusion Analysis <span>ü¶∑</span></h3>
          <div id="tbl_occlusion" style="direction:ltr;"></div>
        </div>
      </div>
    </div>

    <div style="margin-top: 30px; padding: 0 30px; text-align: right; font-size: 14px;">
      <p>Digital Signature</p>
      <p style="font-family: 'cursive'; color: var(--primary); font-size: 20px;">Royal Ray Expert</p>
    </div>
  </div>
  
  <div style="text-align: center; margin-top: 25px; padding-bottom: 50px;">
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('written')">Print Written üñ®Ô∏è</button>
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('final')">Print Final ‚úÖ</button>
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('steiner')">Print Steiner</button>
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('downs')">Print Downs</button>
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('eastman')">Print Eastman</button>
    <button class="action-btn no-print" style="background: rgba(255,255,255,0.08); border:1px solid var(--gold); color:#0b1220;" onclick="printFinalReport('jarabak')">Print Jarabak</button>
    <button class="action-btn no-print" style="background: rgba(197,160,89,0.14); border:1px solid var(--gold); color: var(--gold);" onclick="printFinalReport('tweed')">Print Tweed</button>
    <button class="action-btn no-print comprehensive" style="background: linear-gradient(45deg, #FF6B6B, #4ECDC4); color:white;" onclick="printFinalReport('comprehensive')">Print 12 Angles</button>
    <button class="action-btn no-print" style="background: rgba(197,160,89,0.92); border-color: rgba(197,160,89,0.92); color:#0b1220;" onclick="printFinalReport('all')">Print All / PDF</button>
    <!-- New button for occlusion report -->
    <button class="action-btn no-print" style="background: linear-gradient(45deg, #FF9800, #FF5722); color: white;" onclick="printFinalReport('occlusion')">Print Occlusion</button>
    
    <button class="action-btn no-print" style="background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1); color: white; border: 1px solid var(--gold);" onclick="showTreatmentPlanner()">
      ü¶∑ Treatment Planner
    </button>
    
    <button class="action-btn" style="background:#64748b; color:white;" onclick="document.getElementById('finalReport').style.display='none'">Go Back</button>
    <button class="action-btn" style="background:var(--primary); color:white;" onclick="downloadCephalometricAnalysis()">Download CEPHALOMETRIC ANALYSIS</button>
  </div>
</div>

<!-- ========== RRZ V8: Treatment Planner Module ========== -->
<div id="treatment-planner">
  <div class="tp-shell" style="max-width: 1200px; margin: 0 auto; background: #FFF3E0; border-radius: 15px; padding: 25px; position: relative;">
    
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--gold);">
      <div>
        <h2 style="color: var(--primary); margin: 0;">ü¶∑ Treatment Planner</h2>
        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Create and customize treatment plan based on cephalometric analysis</p>
      </div>
      <button type="button" class="tpExportBtn" onclick="printTreatmentPlan()">‚¨á Export Report</button>
      <button onclick="closeTreatmentPlanner()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">‚úï Close</button>
    </div>

    <!-- Main Content Grid -->
    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 180px);">
      
      <!-- Left Panel: Tools Selection -->
      <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
        <h3 style="color: var(--primary); margin-bottom: 20px;">üõ†Ô∏è Orthodontic Tools</h3>
        
        <div style="margin-bottom: 25px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">Brackets & Tubes</h4>
          <div class="tool-item" data-type="bracket" data-name="MBT 0.022">
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; background: white; border: 1px solid #ddd; cursor: pointer; transition: 0.2s;" onclick="selectTool('bracket', 'MBT 0.022')">
              <div style="width: 30px; height: 30px; background: linear-gradient(45deg, #3498db, #1a3c5a); border-radius: 4px;"></div>
              <div>
                <div style="font-weight: bold; font-size: 13px;">MBT 0.022"</div>
                <div style="font-size: 11px; color: #666;">Standard prescription</div>
              </div>
            </div>
          </div>
          
          <div class="tool-item" data-type="bracket" data-name="Roth 0.018" style="margin-top: 8px;">
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; background: white; border: 1px solid #ddd; cursor: pointer; transition: 0.2s;" onclick="selectTool('bracket', 'Roth 0.018')">
              <div style="width: 30px; height: 30px; background: linear-gradient(45deg, #27ae60, #1a3c5a); border-radius: 4px;"></div>
              <div>
                <div style="font-weight: bold; font-size: 13px;">Roth 0.018"</div>
                <div style="font-size: 11px; color: #666;">Minimal torque</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">Archwires</h4>
          <div class="tool-item" data-type="wire" data-name="NiTi 0.014">
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; background: white; border: 1px solid #ddd; cursor: pointer; transition: 0.2s;" onclick="selectTool('wire', 'NiTi 0.014')">
              <div style="width: 40px; height: 4px; background: linear-gradient(90deg, #8e44ad, #9b59b6); border-radius: 2px;"></div>
              <div>
                <div style="font-weight: bold; font-size: 13px;">NiTi 0.014"</div>
                <div style="font-size: 11px; color: #666;">Superelastic</div>
              </div>
            </div>
          </div>
          
          <div class="tool-item" data-type="wire" data-name="SS 0.016x0.022" style="margin-top: 8px;">
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; background: white; border: 1px solid #ddd; cursor: pointer; transition: 0.2s;" onclick="selectTool('wire', 'SS 0.016x0.022')">
              <div style="width: 40px; height: 4px; background: linear-gradient(90deg, #95a5a6, #7f8c8d); border-radius: 2px;"></div>
              <div>
                <div style="font-weight: bold; font-size: 13px;">SS 0.016√ó0.022"</div>
                <div style="font-size: 11px; color: #666;">Rectangular steel</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">Elastics</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
            <div class="elastic-btn" data-force="3.5oz" onclick="selectElastic('3.5oz', 'Class II')" style="background: #FF6B6B;">II</div>
            <div class="elastic-btn" data-force="3.5oz" onclick="selectElastic('3.5oz', 'Class III')" style="background: #4ECDC4;">III</div>
            <div class="elastic-btn" data-force="3.5oz" onclick="selectElastic('3.5oz', 'Vertical')" style="background: #45B7D1;">V</div>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">Additional Devices</h4>
          <select id="additionalDevices" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;" onchange="addDevice(this.value)">
            <option value="">Select device...</option>
            <option value="TPA">TPA (Transpalatal Arch)</option>
            <option value="Nance">Nance Button</option>
            <option value="QuadHelix">Quad Helix</option>
            <option value="RME">RME (Rapid Maxillary Expander)</option>
            <option value="Headgear">Headgear</option>
            <option value="Forsus">Forsus‚Ñ¢</option>
            <option value="Carriere">Carriere Motion‚Ñ¢</option>
          </select>
        </div>
      </div>

      <!-- Center Panel: Treatment Canvas & Plan Editor -->
      <div style="display: flex; flex-direction: column; gap: 20px;">
        
        <!-- Treatment Canvas -->
        <div style="flex: 1; background: #000; border-radius: 12px; border: 1px solid var(--gold); position: relative; overflow: hidden;">
          <canvas id="treatmentCanvas" style="width: 100%; height: 100%;"></canvas>
          <input id="tpImageUploadInput" type="file" accept="image/*" style="display:none" onchange="tpHandleImageUpload(event)">
          <button class="tpUploadBtn" type="button" onclick="document.getElementById('tpImageUploadInput').click()">üì∑ Upload Image</button>

          <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
            Treatment Visualization
          </div>
        </div>

        <!-- Treatment Plan Editor -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
          <h3 style="color: var(--primary); margin-bottom: 15px;">üìù Treatment Plan</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #555;">Duration (months)</label>
              <input type="number" id="treatmentDuration" min="6" max="36" value="18" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #555;">Difficulty Level</label>
              <select id="treatmentDifficulty" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="simple">Simple</option>
                <option value="moderate" selected>Moderate</option>
                <option value="complex">Complex</option>
                <option value="surgical">Surgical</option>
              </select>
            </div>
          </div>
          
          <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #555;">Treatment Phases</label>
          <textarea id="treatmentPhases" style="width: 100%; height: 120px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-family: Arial, Roboto, 'Open Sans', sans-serif; font-size: 13px; resize: vertical; background:#fff; color:#111;">
Phase 1 (Months 1-6): Alignment and leveling
- Bond MBT 0.022" brackets
- Sequence: NiTi 0.014" ‚Üí 0.016" ‚Üí 0.018"
- Class II elastics 3.5oz

Phase 2 (Months 7-12): Space closure and correction
- Rectangular SS 0.016√ó0.022"
- TPA for molar control
- Continue Class II elastics

Phase 3 (Months 13-18): Finishing and detailing
- Final archwire adjustments
- Bite settling with vertical elastics
- Retention planning</textarea>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center;">
      <button type="button" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;" onclick="generateTreatmentFromAnalysis()">ü§ñ Generate from Analysis</button>
</div>
  </div>
</div>

<script>
  function showHome(){
    try {
      const av = document.getElementById('analysis-view'); if(av) av.style.display = 'none';
      const ab = document.getElementById('analysis-board'); if(ab) ab.style.display = 'none';
      const fr = document.getElementById('finalReport'); if(fr) fr.style.display = 'none';
      const cv = document.getElementById('calibration-view'); if(cv) cv.style.display = 'none';
      const tp = document.getElementById('treatment-planner'); if(tp) tp.style.display = 'none';
      const mh = document.getElementById('main-home'); if(mh) mh.style.display = 'flex';
    } catch(e) {}
  }
</script>
<script>
  // ===== GLOBAL VARIABLES =====
  const canvas = new fabric.Canvas('mainCanvas', { selection: false });
  let cephPoints = {};
  let tracingLines = [];
  let angleLabels = [];
  let labelObjects = {};
  let pointMeta = {};
  const pointRadius = 2; // ===== RRZ V12 PATCH: smaller landmark points =====

  // ===== RRZ V23 PATCH: Pending landmark placement (sidebar select -> click image to place) =====
  let rrzPendingLandmarkKey = null;

  function rrzUpdatePendingLandmarkUI(){
    try{
      document.querySelectorAll('.lm-item').forEach(el => el.classList.remove('pending'));
      if(rrzPendingLandmarkKey){
        const it = document.querySelector(`.lm-item[data-key="${rrzPendingLandmarkKey}"]`);
        if(it) it.classList.add('pending');
      }
    }catch(e){}
  }

  function rrzSetPendingLandmark(key){
    rrzPendingLandmarkKey = key;
    rrzUpdatePendingLandmarkUI();
  }

  function rrzClearPendingLandmark(){
    rrzPendingLandmarkKey = null;
    rrzUpdatePendingLandmarkUI();
  }
  // ===== END RRZ V23 PATCH =====

  // ===== RRZ V18 PATCH: landmark placement gating (prevents computing values for unplaced default-center points) =====
  function rrzPlaced(key){
    const k = rrzCanonKey(key);
    return !!(cephPoints[k] && pointMeta[k] && pointMeta[k].placed);
  }
  function rrzAllPlaced(...keys){
    return keys.every(k => rrzPlaced(k));
  }
  // ==================================================================================================

  // ===== RRZ V6: Active Points Tracking =====
  let activePoints = new Set(); // ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäÿßŸã

  // ===== RRZ V7: Calibration Variables =====
  let calibrationScale = 1.0; // ÿπÿßŸÖŸÑ ÿßŸÑŸÖŸÇŸäÿßÿ≥ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
  let calibrationCanvas = null;
  let calibrationPoints = { p1: null, p2: null };
  // ===== RRZ PATCH: Calibration canvas pan (drag) + zoom (mouse wheel) =====
  let rrzCal_isPanning = false;
  let rrzCal_lastPosX = 0;
  let rrzCal_lastPosY = 0;
  let rrzCal_spaceDown = false;

  document.addEventListener('keydown', function(e){
    if(e.code === 'Space'){
      const cv = document.getElementById('calibration-view');
      if(cv && cv.style.display !== 'none'){ try{ e.preventDefault(); }catch(_e){} }
      rrzCal_spaceDown = true;
    }
  }, { passive:false });

  document.addEventListener('keyup', function(e){
    if(e.code === 'Space') rrzCal_spaceDown = false;
  });

  function rrzEnableCalibrationPanZoom(cv){
    if(!cv || cv.__rrzPanZoomEnabled) return;
    cv.__rrzPanZoomEnabled = true;

    // Zoom with mouse wheel
    cv.on('mouse:wheel', function(opt){
      const e = opt.e;
      let zoom = cv.getZoom();
      const delta = e.deltaY;
      zoom *= Math.pow(0.999, delta);
      zoom = Math.min(Math.max(zoom, 0.2), 10);

      const pt = new fabric.Point(e.offsetX, e.offsetY);
      cv.zoomToPoint(pt, zoom);

      e.preventDefault();
      e.stopPropagation();
    });

    // Pan by dragging empty space OR holding Space (recommended)
    cv.on('mouse:down', function(opt){
      const e = opt.e;
      const clickedEmpty = !opt.target;
      const wantPan = rrzCal_spaceDown || clickedEmpty || e.button === 1; // space / empty / middle button
      if(!wantPan) return;

      rrzCal_isPanning = true;
      cv.discardActiveObject();
      cv.selection = false;
      cv.defaultCursor = 'grabbing';
      rrzCal_lastPosX = e.clientX;
      rrzCal_lastPosY = e.clientY;
    });

    cv.on('mouse:move', function(opt){
      if(!rrzCal_isPanning) return;
      const e = opt.e;
      const vpt = cv.viewportTransform;
      vpt[4] += (e.clientX - rrzCal_lastPosX);
      vpt[5] += (e.clientY - rrzCal_lastPosY);
      cv.requestRenderAll();
      rrzCal_lastPosX = e.clientX;
      rrzCal_lastPosY = e.clientY;
    });

    function endPan(){
      if(!rrzCal_isPanning) return;
      rrzCal_isPanning = false;
      cv.selection = false; // keep off; you already move points individually
      cv.defaultCursor = 'grab';
      cv.requestRenderAll();
    }

    cv.on('mouse:up', endPan);
    cv.on('mouse:out', endPan);

    cv.defaultCursor = 'grab';
  }
  // ===== END RRZ PATCH =====

  let isCalibrationMode = false;
  // ==========================================

  // ===== ZOOM & PAN LOGIC =====
  let isPanning = false;
  function zoomIn() {
    let zoom = canvas.getZoom();
    zoom *= 1.1;
    if (zoom > 5) zoom = 5;
    canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, zoom);
  }
  function zoomOut() {
    let zoom = canvas.getZoom();
    zoom /= 1.1;
    if (zoom < 0.5) zoom = 0.5;
    canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, zoom);
  }
  function resetZoom() {
    canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
  }
  function togglePan(){
    isPanning = !isPanning;
    const btn = document.getElementById('btnPan');
    if(isPanning){
      btn.classList.add('active');
      canvas.selection = false;
      canvas.forEachObject(o => o.selectable = false);
    } else {
      btn.classList.remove('active');
      canvas.selection = false;
      canvas.forEachObject(o => o.selectable = true);
    }
  }

  // Mouse Events for Panning
  let isDragging = false;
  let lastPosX, lastPosY;
  canvas.on('mouse:down', function(opt) {
    var evt = opt.e;
    if (isPanning) {
      isDragging = true;
      selection = false;
      lastPosX = evt.clientX;
      lastPosY = evt.clientY;
    }
  });
  canvas.on('mouse:move', function(opt) {
    if (isPanning && isDragging) {
      var e = opt.e;
      var vpt = this.viewportTransform;
      vpt[4] += e.clientX - lastPosX;
      vpt[5] += e.clientY - lastPosY;
      this.requestRenderAll();
      lastPosX = e.clientX;
      lastPosY = e.clientY;
    }
  });
  canvas.on('mouse:up', function(opt) {
    if(isPanning){
      this.setViewportTransform(this.viewportTransform);
      isDragging = false;
    }
  });

  // ===== RRZ V23 PATCH: Mouse wheel zoom + drag pan (no Pan button) + click-to-drop pending landmarks =====
  // Wheel zoom (trackpad/mouse wheel) - zooms to pointer position.
  canvas.on('mouse:wheel', function(opt) {
    try{
      const e = opt.e;
      const delta = e.deltaY;
      let zoom = canvas.getZoom();
      zoom *= Math.pow(0.999, delta);
      if (zoom > 6) zoom = 6;
      if (zoom < 0.25) zoom = 0.25;

      const p = new fabric.Point(e.offsetX, e.offsetY);
      canvas.zoomToPoint(p, zoom);
      e.preventDefault();
      e.stopPropagation();
    }catch(err){}
  });

  // Drag pan (mouse hold on empty space/background).
  let rrzDragPanning = false;
  let rrzLastPosX = 0, rrzLastPosY = 0;

  canvas.on('mouse:down', function(opt){
    const e = opt.e;

    // 1) If a landmark is pending -> drop it exactly where the user clicked (only if clicked on background).
    if(rrzPendingLandmarkKey && !opt.target){
      try{
        const pt = canvas.getPointer(e);
        addLandmarkAt(rrzPendingLandmarkKey, pt.x, pt.y);
        rrzClearPendingLandmark();
        // prevent immediate pan start on same click
        e.preventDefault();
        e.stopPropagation();
        return;
      }catch(err){}
    }

    // 2) Otherwise, start panning ONLY if user clicks on empty canvas (not on objects).
    if(!opt.target && e.button === 0){
      rrzDragPanning = true;
      rrzLastPosX = e.clientX;
      rrzLastPosY = e.clientY;
      canvas.defaultCursor = 'grabbing';
    }
  });

  canvas.on('mouse:move', function(opt){
    if(rrzDragPanning){
      const e = opt.e;
      const vpt = canvas.viewportTransform;
      vpt[4] += e.clientX - rrzLastPosX;
      vpt[5] += e.clientY - rrzLastPosY;
      canvas.requestRenderAll();
      rrzLastPosX = e.clientX;
      rrzLastPosY = e.clientY;
    }
  });

  canvas.on('mouse:up', function(){
    if(rrzDragPanning){
      rrzDragPanning = false;
      canvas.defaultCursor = 'default';
      canvas.setViewportTransform(canvas.viewportTransform);
    }
  });
  // ===== END RRZ V23 PATCH =====


  // ===================== RRZ V9 PATCH =====================
  // Patient Name integration (reads from dashboard.html via localStorage / URL params)
  // Expected in dashboard.html when saving patient:
  //   localStorage.setItem('rrz_patient_name', patientName);
  // =========================================================
  function rrzEscapeHtml(str){
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function rrzGetPatientName(){
    try{
      const direct = (window.RRZ_patientName || '').trim();
      if(direct) return direct;

      const keys = ['rrz_patient_name','patientName','patient_name','RRZ_PATIENT_NAME','dash_patient_name','rrzPatientName'];
      for(const k of keys){
        const v = (localStorage.getItem(k) || sessionStorage.getItem(k) || '').trim();
        if(v) return v;
      }
      const qs = new URLSearchParams(window.location.search);
      const qv = (qs.get('patientName') || qs.get('patient') || qs.get('name') || '').trim();
      if(qv) return qv;

      // Optional: get from opener (if opened by dashboard.html)
      if(window.opener && !window.opener.closed){
        try{
          const ov = (window.opener.RRZ_patientName || '').trim();
          if(ov) return ov;
        }catch(e){}
      }
    }catch(e){}
    return '‚Äî';
  }

  function rrzApplyPatientNameToUI(){
    const pn = rrzGetPatientName();
    const ids = ['wr_patientNameTop','wr_patientName','reportPatientName'];
    ids.forEach(id => { const el=document.getElementById(id); if(el) el.textContent = pn; });
  }

  // React to patient updates (when dashboard.html changes localStorage)
  window.addEventListener('storage', function(e){
    if(!e) return;
    const keys = ['rrz_patient_name','patientName','patient_name','RRZ_PATIENT_NAME','dash_patient_name','rrzPatientName'];
    if(keys.includes(e.key)){ rrzApplyPatientNameToUI(); }
  });

  // Optional: accept postMessage from dashboard.html
  window.addEventListener('message', function(e){
    try{
      if(!e || !e.data) return;
      if(e.data.type === 'RRZ_PATIENT_NAME' && typeof e.data.value === 'string'){
        localStorage.setItem('rrz_patient_name', e.data.value);
        rrzApplyPatientNameToUI();
      }
    }catch(err){}
  });

  // =================== End RRZ V9 PATCH ===================

  document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
  rrzApplyPatientNameToUI();
// ===== POINT SETTINGS =====
  const pointSettings = [
    { key:'S',   id:'S-sella',                 x:0.40, y:0.30, c:'#BD10E0' },
    { key:'N',   id:'Na-Nasion (skeletal)',    x:0.65, y:0.28, c:'#07EC7B' },
    { key:'Po',  id:'Po-porion',               x:0.30, y:0.45, c:'#7ED321' },
    { key:'Or',  id:'Or-Orbital',              x:0.55, y:0.45, c:'#FE9A03' },
    { key:'Co',  id:'Co - Condyle',            x:0.22, y:0.38, c:'#FE9A03' },
    { key:'Ba',  id:'Ba - Basion',             x:0.18, y:0.60, c:'#EEF0F2' },
    { key:'ANS', id:'ANS',                     x:0.68, y:0.55, c:'#010AFE' },
    { key:'PNS', id:'PNS',                     x:0.45, y:0.55, c:'#FF0079' },
    { key:'A',   id:'A -point',                x:0.70, y:0.60, c:'#6200FF' },
    { key:'B',   id:'B-point',                 x:0.68, y:0.75, c:'#8F00FE' },
    { key:'Go',  id:'Go - Gonion',             x:0.40, y:0.70, c:'#000000' },
    { key:'Gn',  id:'Gn -Gnathion',            x:0.67, y:0.85, c:'#FF03D6' },
    { key:'Me',  id:'Me-Menton',               x:0.65, y:0.88, c:'#F8E71C' },
    { key:'Pog', id:'Pog- pogonion (skeletal)',x:0.70, y:0.82, c:'#07EC7B' },
    { key:'U1A', id:'UI- apex',                x:0.66, y:0.62, c:'#02C2FF' },
    { key:'U1E', id:'UI - coronal',            x:0.72, y:0.66, c:'#FF2D00' },
    { key:'L1A', id:'LI- apex',                x:0.66, y:0.79, c:'#FF2D00' },
    { key:'L1E', id:'LI- coronal',             x:0.71, y:0.72, c:'#FFF500' },

    { key:'UMD', id:'U.molar - distal point',  x:0.52, y:0.60, c:'#FFFFFF' },

    { key:'LMD', id:'L.molar - distal point',  x:0.52, y:0.70, c:'#02C2FF' },
    { key:'Nsoft', id:'Soft tissue - Na',      x:0.72, y:0.29, c:'#8F00FE' },
    { key:'Prn',   id:'Pn- pronasal',          x:0.82, y:0.52, c:'#000000' },
    { key:'Sn',    id:'Sn- Subnasal',          x:0.78, y:0.60, c:'#FF2D00' },
    { key:'Ls',    id:'UL-Upper lip',          x:0.83, y:0.65, c:'#DBFF00' },
    { key:'Li',    id:'LL- Lower lip',         x:0.82, y:0.72, c:'#4A90E2' },
    { key:'STA',   id:'Soft tissue - A point', x:0.78, y:0.62, c:'#F5A623' },
    { key:'STB',   id:'Soft tissue - B point', x:0.76, y:0.76, c:'#FF03D6' },
    { key:'PgS',   id:'Soft tissue - Pog',     x:0.78, y:0.85, c:'#FFF500' },
    { key:'OcclA', id:'OcclA - Anterior Occlusal',    x:0.62, y:0.62, c:'#00E5FF' },
    { key:'OcclP', id:'OcclP - Posterior Occlusal',   x:0.48, y:0.58, c:'#00E676' },
    { key:'U6M',  id:'U6M - Upper molar mesial point',   x:0.52, y:0.58, c:'#FF5722' },
    { key:'L6M',  id:'L6M - Lower molar mesial point',   x:0.52, y:0.63, c:'#4CAF50' },
    
    // ===== NEW POINTS FOR ADDITIONAL MEASUREMENTS =====
    { key:'Ar',   id:'Ar-Articulare',          x:0.25, y:0.50, c:'#FF9800' },
    { key:'Xi',   id:'Xi-Point',               x:0.35, y:0.65, c:'#9C27B0' },
    { key:'Ptm',  id:'Ptm-Pterygomaxillary',  x:0.45, y:0.50, c:'#3F51B5' },
    { key:'E',    id:'E-Point',               x:0.85, y:0.80, c:'#607D8B' },
    { key:'Pt',   id:'Pt-Pterygoid',          x:0.42, y:0.48, c:'#8BC34A' },
    { key:'Pr',   id:'Pr-Prosthion',          x:0.72, y:0.65, c:'#E91E63' },
    { key:'Id',   id:'Id-Infradentale',       x:0.70, y:0.78, c:'#9C27B0' },
    { key:'M',    id:'M-Menton (Soft)',       x:0.68, y:0.87, c:'#00BCD4' },
    { key:'G',    id:'G-Glabella',            x:0.75, y:0.25, c:'#FF9800' },
    { key:'Cm',   id:'Cm-Columella',          x:0.80, y:0.55, c:'#4CAF50' },    { key:'Pos',  id:'Pos-Pogonion (Soft)',   x:0.78, y:0.85, c:'#FF9800' }
  ];
  // ===== Point Alias Map (deduplicate equivalent landmarks) =====
  // These keys are considered identical. The UI should show ONLY the canonical keys.
  const RRZ_POINT_ALIASES = Object.freeze({
    UMM:'U6M', // Upper molar mesial (legacy) -> U6M
    LMM:'L6M', // Lower molar mesial (legacy) -> L6M
    UL: 'Ls',   // Upper lip (Steiner) -> Labrale superius
    ULs:'Ls',
    LL: 'Li',   // Lower lip (Steiner) -> Labrale inferius
    LLs:'Li',
    Pos:'PgS',  // Soft pogonion alternative -> Soft tissue Pog
    PM:'Po'     // Porion midpoint (legacy) -> Po-porion (lateral ceph uses single Porion)
  });

  function rrzCanonKey(key){ return RRZ_POINT_ALIASES[key] || key; }
  function rrzP(key){ return cephPoints[rrzCanonKey(key)] || null; }



  // ===== IMAGE UPLOAD - MODIFIED FOR CALIBRATION =====
  document.getElementById('imgLoader').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = (f) => {
      const img = new Image();
      img.src = f.target.result;
      img.onload = () => {
        // ===== RRZ V7: Show calibration view instead of analysis =====
        document.getElementById('main-home').style.display = 'none';
        document.getElementById('calibration-view').style.display = 'flex';
        
        // Initialize calibration canvas
        const ratio = Math.min((window.innerWidth * 0.7)/img.width, (window.innerHeight - 200)/img.height);
        const calCanvas = document.getElementById('calibrationCanvas');
        calCanvas.width = img.width * ratio;
        calCanvas.height = img.height * ratio;
        
        calibrationCanvas = new fabric.Canvas('calibrationCanvas', { selection: false });
        const fabImg = new fabric.Image(img);
        fabImg.scale(ratio);
        calibrationCanvas.setBackgroundImage(fabImg, calibrationCanvas.renderAll.bind(calibrationCanvas));
        
        
        try{ rrzEnableCalibrationPanZoom(calibrationCanvas); }catch(e){}
// Store original image for main canvas later
        window.RRZ_OriginalImage = img;
        window.RRZ_ImageRatio = ratio;
        
        // Reset calibration data
        calibrationScale = 1.0;
        calibrationPoints = { p1: null, p2: null };
        // =============================================================
      };
    };
    if (!e.target.files || !e.target.files[0]) { return; }
    reader.readAsDataURL(e.target.files[0]);
  };

  // ===== NEW: CALIBRATION FUNCTIONS =====
  function manualCalibration() {
    if (!calibrationCanvas) return;
    
    isCalibrationMode = true;
    
    // Clear previous points
    if (calibrationPoints.p1) calibrationCanvas.remove(calibrationPoints.p1);
    if (calibrationPoints.p2) calibrationCanvas.remove(calibrationPoints.p2);
    calibrationPoints = { p1: null, p2: null };
    
    // Show distance input
    document.getElementById('calibrationDistance').style.display = 'block';
    document.getElementById('applyCalibrationBtn').style.display = 'block';
    
    // Create first calibration point (center left)
    const p1 = new fabric.Circle({
      left: calibrationCanvas.width * 0.4,
      top: calibrationCanvas.height / 2,
      radius: 3,
      fill: '#FF6B6B',
      stroke: 'white',
      strokeWidth: 1,
      originX: 'center',
      originY: 'center',
      hasControls: false,
      hasBorders: false,
      selectable: true
    });
    
    // Create second calibration point (center right)
    const p2 = new fabric.Circle({
      left: calibrationCanvas.width * 0.6,
      top: calibrationCanvas.height / 2,
      radius: 3,
      fill: '#4ECDC4',
      stroke: 'white',
      strokeWidth: 1,
      originX: 'center',
      originY: 'center',
      hasControls: false,
      hasBorders: false,
      selectable: true
    });
    
    // Add distance label
    const line = new fabric.Line([p1.left, p1.top, p2.left, p2.top], {
      stroke: 'white',
      strokeWidth: 2,
      strokeDashArray: [5, 5],
      selectable: false
    });
    
    const label = new fabric.Text('?', {
      fontSize: 16,
      fontWeight: 'bold',
      fill: 'white',
      backgroundColor: 'rgba(0,0,0,0.6)',
      left: (p1.left + p2.left) / 2,
      top: (p1.top + p2.top) / 2 - 20,
      selectable: false
    });
    
    // Update line and label when points move
    function updateCalibrationLine() {
      line.set({
        x1: p1.left,
        y1: p1.top,
        x2: p2.left,
        y2: p2.top
      });
      
      const pixelDistance = Math.hypot(p2.left - p1.left, p2.top - p1.top);
      label.set({
        left: (p1.left + p2.left) / 2,
        top: (p1.top + p2.top) / 2 - 20,
        text: pixelDistance.toFixed(1) + ' px'
      });
      
      calibrationCanvas.renderAll();
    }
    
    p1.on('moving', updateCalibrationLine);
    p2.on('moving', updateCalibrationLine);
    
    calibrationCanvas.add(line, p1, p2, label);
    calibrationPoints.p1 = p1;
    calibrationPoints.p2 = p2;
    calibrationPoints.line = line;
    calibrationPoints.label = label;
    
    updateCalibrationLine();
  }

  function autoCalibration() {
    // ===== RRZ V7: Auto Calibration using standard references =====
    // Standard: Average distance between Sella-Nasion is approx 70mm in adults
    // We'll use this as a reference point if available
    
    alert('Auto Calibration: Assuming standard 70mm Sella-Nasion distance as reference.\n\nYou can manually adjust later if needed.');
    
    // Use default scale of 1.0 for now, or implement smart detection
    calibrationScale = 1.0;
    
    // Show calibration complete message
    showAnalysisView();
  }

  function applyCalibration() {
    if (!calibrationPoints.p1 || !calibrationPoints.p2) {
      alert('Please place both calibration points first!');
      return;
    }
    
    const realDistance = parseFloat(document.getElementById('calibrationDistance').value);
    if (!realDistance || realDistance <= 0) {
      alert('Please enter a valid real distance in mm!');
      return;
    }
    
    const pixelDistance = Math.hypot(
      calibrationPoints.p2.left - calibrationPoints.p1.left,
      calibrationPoints.p2.top - calibrationPoints.p1.top
    );
    
    // Calculate scale factor: real mm per pixel
    calibrationScale = realDistance / pixelDistance;
    
    // Show confirmation
    alert(`Calibration Applied Successfully!\n\nScale: ${calibrationScale.toFixed(4)} mm/px\nReal Distance: ${realDistance} mm\nPixel Distance: ${pixelDistance.toFixed(1)} px`);
    
    showAnalysisView();
  }

  function skipCalibration() {
    calibrationScale = 1.0;
    showAnalysisView();
  }

  function showAnalysisView() {
    // Hide calibration and show analysis view
    document.getElementById('calibration-view').style.display = 'none';
    document.getElementById('analysis-view').style.display = 'flex';
    document.getElementById('lmSidebar').style.display = 'block';
    
    // Initialize main canvas with original image
    const ratio = window.RRZ_ImageRatio;
    canvas.setDimensions({ 
      width: window.RRZ_OriginalImage.width * ratio, 
      height: window.RRZ_OriginalImage.height * ratio 
    });
    
    const fabImg = new fabric.Image(window.RRZ_OriginalImage);
    fabImg.scale(ratio);
    canvas.setBackgroundImage(fabImg, canvas.renderAll.bind(canvas));
    
    // Initialize point metadata
    pointSettings.forEach(p => {
      const shortLbl = makeShortLabel(p.id, p.key);
      pointMeta[p.key] = { full: p.id, short: shortLbl, color: p.c };
      cephPoints[p.key] = null;
      labelObjects[p.key] = null;
    });
    
    buildLandmarkSidebar();
  }

  // ===== END CALIBRATION FUNCTIONS =====

  function makeShortLabel(fullName, fallbackKey){
    const s = (fullName || '').trim();
    if(/^Soft\s*tissue\s*-\s*/i.test(s)){
      const base = s.replace(/^Soft\s*tissue\s*-\s*/i,'').trim();
      let abbr = base.split(/[\s\(]/)[0].replace(/[^A-Za-z0-9\.]/g,'');
      if(!abbr) abbr = (fallbackKey || 'ST');
      if(abbr.toLowerCase() === 'na') abbr = 'Na';
      if(abbr.toLowerCase() === 'pog') abbr = 'Pog';
      return abbr + 's';
    }
    if(s.includes('-')){
      let left = s.split('-')[0].trim();
      left = left.replace(/[^A-Za-z0-9\.]/g,'');
      if(left) return left;
    }
    const t = s.split(/[\s\(]/)[0].trim().replace(/[^A-Za-z0-9\.]/g,'');
    return t || (fallbackKey || '?');
  }

  function buildLandmarkSidebar(){
    const box = document.getElementById('lmList');
    if(!box) return;
    box.innerHTML = '';

    // Grouping for easier landmark selection (Skeletal / Dental / Soft Tissue)
    const SKELETAL = new Set(['S','N','Po','Or','Co','Ba','ANS','PNS','A','B','Go','Gn','Me','Pog','Ar','Xi','Ptm','Pt']);
    const DENTAL   = new Set(['U1A','U1E','L1A','L1E','UMD','LMD','OcclA','OcclP','U6M','L6M','Id','Pr']);
    const SOFT     = new Set(['Nsoft','Prn','Sn','Ls','Li','STA','STB','PgS','Cm','M','G','Pos','E']);

    const groups = [
      { key:'skeletal', title:'Skeletal Landmarks', list:[] },
      { key:'dental',   title:'Dental Landmarks',   list:[] },
      { key:'soft',     title:'Soft Tissue Landmarks', list:[] },
    ];

    // ===== Landmark ordering (as provided) =====
    const ORDER_SKELETAL = ['N','S','Po','Or','Co','Ar','Ba','ANS','PNS','A','B','Pog','Gn','Me','Go','Xi','Ptm','Pt'];
    const ORDER_DENTAL   = ['U1A','U1E','Pr','L1E','L1A','Id','U6M','L6M','UMD','LMD','OcclA','OcclP'];
    const ORDER_SOFT     = ['G','Nsoft','Prn','Sn','STA','Cm','Ls','E','Li','STB','PgS','M','Pos'];

    function orderIndex(groupKey, pointKey){
      const k = rrzCanonKey(pointKey);
      let order = ORDER_SKELETAL;
      if(groupKey === 'dental') order = ORDER_DENTAL;
      if(groupKey === 'soft') order = ORDER_SOFT;
      const i = order.indexOf(k);
      return i === -1 ? 9999 : i;
    }


    const shown = new Set();
    pointSettings.forEach(p => {
      const canonical = rrzCanonKey(p.key);
      // Hide alias entries from the sidebar
      if (canonical !== p.key) return;
      if (shown.has(canonical)) return;
      shown.add(canonical);

      let cat = 'skeletal';
      if (SOFT.has(canonical)) cat = 'soft';
      else if (DENTAL.has(canonical)) cat = 'dental';
      else if (SKELETAL.has(canonical)) cat = 'skeletal';

      const g = groups.find(x => x.key === cat);
      if(g) g.list.push({ key: canonical, point: p });
    });

    groups.forEach(g=>{
      if(!g.list.length) return;

      const wrap = document.createElement('div');
      wrap.className = 'lm-group';

      const title = document.createElement('div');
      title.className = 'lm-group-title';
      title.textContent = g.title;
      wrap.appendChild(title);

      // Sort items according to the required clinical order
      g.list.sort((a,b)=> orderIndex(g.key, a.key) - orderIndex(g.key, b.key));

      g.list.forEach(({key, point})=>{
        const shortLbl = makeShortLabel(point.id, point.key);
        const item = document.createElement('div');
        item.className = 'lm-item';
        item.setAttribute('data-key', key);
        item.innerHTML = `
          <div class="lm-badge" style="border:2px solid ${point.c};">${shortLbl}</div>
          <div class="lm-full">${point.id}</div>
        `;
        item.onclick = () => toggleLandmark(key);
        wrap.appendChild(item);
      });

      box.appendChild(wrap);
    });
  }

  function toggleLandmark(key) {
    const pointData = pointSettings.find(p => p.key === key);
    if (!pointData) return;

    // ===== RRZ V23 PATCH: Sidebar click only ARMS placement; actual point is dropped on next image click =====
    // If the landmark already exists -> remove it immediately (same as original workflow).
    if (activePoints.has(key) && cephPoints[key]) {
      removeLandmark(key);
      // If it was pending, clear pending as well.
      if(rrzPendingLandmarkKey === key) rrzClearPendingLandmark();
      return;
    }

    // If user clicks the same item again while pending -> cancel.
    if(rrzPendingLandmarkKey === key){
      rrzClearPendingLandmark();
      return;
    }

    // Arm this landmark; user must click on the ceph image to place it.
    rrzSetPendingLandmark(key);
    // =====================================================================================================
  }

  function addLandmarkInCenter(key) {
    const pointData = pointSettings.find(p => p.key === key);
    if (!pointData) return;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    const circle = new fabric.Circle({
      left: centerX,
      top: centerY,
      radius: pointRadius,
      fill: pointData.c,
      stroke: 'white',
      strokeWidth: 1,
      originX: 'center',
      originY: 'center',
      hasControls: false,
      hasBorders: false
    });

    // ===== RRZ V18 PATCH: track whether landmark was actually placed by user (moved from default) =====
    if(!pointMeta[key]) pointMeta[key] = {};
    pointMeta[key].placed = false;
    pointMeta[key].placedAt = null;
    // ===============================================================================================

    
    const shortLbl = makeShortLabel(pointData.id, pointData.key);
    const text = new fabric.Text(shortLbl, {
      fontSize: 9,
      fontWeight: 'bold',
      fill: 'yellow',
      left: centerX + 6,
      top: centerY - 15,
      selectable: false
    });
    
    circle.on('modified', () => {
      if(pointMeta[key]){ pointMeta[key].placed = true; if(!pointMeta[key].placedAt) pointMeta[key].placedAt = Date.now(); }
    });

    circle.on('moving', () => {
      // ===== RRZ V18 PATCH: mark as placed on first move =====
      if(pointMeta[key] && !pointMeta[key].placed){ pointMeta[key].placed = true; pointMeta[key].placedAt = Date.now(); }
      // =====================================================
      text.set({ left: circle.left + 6, top: circle.top - 15 });
      canvas.renderAll();
    });
    
    circle.on('removed', () => {
      if (text) canvas.remove(text);
    });
    
    cephPoints[key] = circle;
    labelObjects[key] = text;
    
    canvas.add(circle, text);
    activePoints.add(key);
    
    updateLandmarkSidebarItem(key, true);
    canvas.renderAll();
  }

  
  // ===== RRZ V23 PATCH: Place landmark at specific (x,y) instead of forcing center =====
  function addLandmarkAt(key, x, y) {
    const pointData = pointSettings.find(p => p.key === key);
    if (!pointData) return;

    const circle = new fabric.Circle({
      left: x,
      top: y,
      radius: pointRadius,
      fill: pointData.c,
      stroke: 'white',
      strokeWidth: 1,
      originX: 'center',
      originY: 'center',
      hasControls: false,
      hasBorders: false
    });

    // Mark as placed immediately because it was dropped intentionally by click.
    if(!pointMeta[key]) pointMeta[key] = {};
    pointMeta[key].placed = true;
    pointMeta[key].placedAt = Date.now();

    const shortLbl = makeShortLabel(pointData.id, pointData.key);
    const text = new fabric.Text(shortLbl, {
      fontSize: 9,
      fontWeight: 'bold',
      fill: 'yellow',
      left: x + 6,
      top: y - 15,
      selectable: false
    });

    circle.on('modified', () => {
      if(pointMeta[key]){ pointMeta[key].placed = true; if(!pointMeta[key].placedAt) pointMeta[key].placedAt = Date.now(); }
    });

    circle.on('moving', () => {
      if(pointMeta[key] && !pointMeta[key].placed){ pointMeta[key].placed = true; pointMeta[key].placedAt = Date.now(); }
      text.set({ left: circle.left + 6, top: circle.top - 15 });
      canvas.renderAll();
    });

    circle.on('removed', () => {
      if (text) canvas.remove(text);
    });

    cephPoints[key] = circle;
    labelObjects[key] = text;

    canvas.add(circle, text);
    activePoints.add(key);

    updateLandmarkSidebarItem(key, true);
    canvas.renderAll();
  }
  // ===== END RRZ V23 PATCH =====

  function removeLandmark(key) {
    const circle = cephPoints[key];
    const text = labelObjects[key];
    
    if (circle) {
      canvas.remove(circle);
      cephPoints[key] = null;
    }
    if (text) {
      canvas.remove(text);
      labelObjects[key] = null;
    }
    
    activePoints.delete(key);
    
    // ===== RRZ V18 PATCH: clear placement meta =====
    try{ delete pointMeta[key]; }catch(e){}
    // =========================================
updateLandmarkSidebarItem(key, false);
    canvas.renderAll();
  }

  function updateLandmarkSidebarItem(key, isActive) {
    const item = document.querySelector(`.lm-item[data-key="${key}"]`);
    if (item) {
      if (isActive) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    }
  }

  function focusLandmark(key){
    toggleLandmark(key);
  }

  function showReportPage(id){
    window.RRZ_rpStack = window.RRZ_rpStack || [];
    try{
      const cur = document.querySelector('#analysis-board .rp-page.active');
      if(cur && cur.id && cur.id !== id){ window.RRZ_rpStack.push(cur.id); }
    }catch(e){}

    document.querySelectorAll('#analysis-board .rp-page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
    const map = { 
      rp_quick:'btn_rp_quick', 
      rp_steiner:'btn_rp_steiner', 
      rp_downs:'btn_rp_downs', 
      rp_eastman:'btn_rp_eastman',
      rp_jarabak:'btn_rp_jarabak',
      rp_tweed:'btn_rp_tweed',
      rp_comprehensive:'btn_rp_comprehensive',
      rp_occlusion:'btn_rp_occlusion'
    };
    Object.values(map).forEach(bid => { const b=document.getElementById(bid); if(b) b.classList.remove('active'); });
    const bid = map[id];
    if(bid){ const b=document.getElementById(bid); if(b) b.classList.add('active'); }
  }

  function showFinalPage(id){
    window.RRZ_finalStack = window.RRZ_finalStack || [];
    try{
      const cur = document.querySelector('#finalReport .rp-page.active');
      if(cur && cur.id && cur.id !== id){ window.RRZ_finalStack.push(cur.id); }
    }catch(e){}

    ['fr_written','fr_final','fr_downs','fr_steiner','fr_eastman','fr_jarabak','fr_tweed','fr_comprehensive','fr_occlusion'].forEach(pid => {
      const p = document.getElementById(pid);
      if(p) p.classList.toggle('active', pid === id);
    });
    const map = { 
      fr_written:'btn_fr_written', 
      fr_downs:'btn_fr_downs', 
      fr_steiner:'btn_fr_steiner', 
      fr_eastman:'btn_fr_eastman', 
      fr_jarabak:'btn_fr_jarabak',
      fr_tweed:'btn_fr_tweed',
      fr_final:'btn_fr_final',
      fr_comprehensive:'btn_fr_comprehensive',
      fr_occlusion:'btn_fr_occlusion'
    };
    Object.values(map).forEach(bid => { const b=document.getElementById(bid); if(b) b.classList.remove('active'); });
    const bid = map[id];
    if(bid){ const b=document.getElementById(bid); if(b) b.classList.add('active'); }
  }

  // ====================================================
  // ========== ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ==============
  // ====================================================
  function calculateAngle(p1, p2, p3, p4) {
    const v1 = { x: p2.left - p1.left, y: p2.top - p1.top };
    const v2 = { x: p4.left - p3.left, y: p4.top - p3.top };
    const dot = v1.x * v2.x + v1.y * v2.y;
    const mag1 = Math.sqrt(v1.x**2 + v1.y**2);
    const mag2 = Math.sqrt(v2.x**2 + v2.y**2);
    const angle = (Math.acos(Math.max(-1, Math.min(1, dot / (mag1 * mag2)))) * 180 / Math.PI);
    return angle.toFixed(1);
  }

  function angleAt(A, B, C){
    const v1 = { x: A.left - B.left, y: A.top - B.top };
    const v2 = { x: C.left - B.left, y: C.top - B.top };
    const dot = v1.x * v2.x + v1.y * v2.y;
    const mag1 = Math.sqrt(v1.x*v1.x + v1.y*v1.y);
    const mag2 = Math.sqrt(v2.x*v2.x + v2.y*v2.y);
    const angle = (Math.acos(Math.max(-1, Math.min(1, dot / (mag1 * mag2)))) * 180 / Math.PI);
    return angle;
  }

  // ====================================================
  // ========== RRZ: Angle normalization helpers =========
  // ====================================================
  // Many cephalometric angles are *undirected* (a line has no arrow).
  // If the user draws a line "backwards", the raw angle becomes its supplement (180 - angle),
  // which can produce outliers like 151¬∞ instead of ~29¬∞.
  //
  // To stabilize results (and match WebCeph-style conventions), we normalize selected angles
  // by choosing the value (angle vs 180-angle) that is *closest to the published mean*.
  function normalizeAngleToMean(angleDeg, meanDeg){
    if (angleDeg === undefined || angleDeg === null) return angleDeg;
    const a = Number(angleDeg);
    if (!isFinite(a)) return angleDeg;
    const mean = Number(meanDeg);
    if (!isFinite(mean)) return a;
    // raw from dot-product is in [0..180]; enforce safety anyway
    const raw = Math.max(0, Math.min(180, Math.abs(a)));
    const sup = 180 - raw;
    return (Math.abs(raw - mean) <= Math.abs(sup - mean)) ? raw : sup;
  }


  // ===== RRZ V7: Modified distance functions to use calibration scale =====
  function dist(p1, p2){ 
    const pixelDist = Math.hypot(p2.left - p1.left, p2.top - p1.top);
    return pixelDist * calibrationScale; // Convert to real mm
  }

  function pointLineDistance(P, A, B){
    const x0 = P.left, y0 = P.top;
    const x1 = A.left, y1 = A.top;
    const x2 = B.left, y2 = B.top;
    const num = Math.abs((y2 - y1)*x0 - (x2 - x1)*y0 + x2*y1 - y2*x1);
    const den = Math.hypot(y2 - y1, x2 - x1);
    const pixelDist = den === 0 ? 0 : (num / den);
    return pixelDist * calibrationScale; // Convert to real mm
  }

  // Signed distance from point P to line AB in **mm**.
  // Sign is chosen so that POSITIVE is generally "anterior" (toward +X / right side of the image).
  function signedPointLineDistanceRightMm(P, A, B){
    if(!P || !A || !B) return null;
    const x0 = P.left, y0 = P.top;
    const x1 = A.left, y1 = A.top;
    const x2 = B.left, y2 = B.top;

    const dx = x2 - x1;
    const dy = y2 - y1;
    const den = Math.hypot(dx, dy);
    if(den === 0) return 0;

    // Unit normal (dy, -dx) points to one side; flip so it points to +X (right) when possible.
    let nx = dy / den;
    let ny = -dx / den;
    if(nx < 0){ nx = -nx; ny = -ny; }

    const pixelDist = (x0 - x1) * nx + (y0 - y1) * ny;
    return pixelDist * calibrationScale;
  }

  // ===== RRZ V29: E-Line descriptor by sign (requested) =====
  function rrzElineDescriptor(v){
    if(v === null || v === undefined || isNaN(v)) return '';
    const eps = 0.5; // "almost zero" threshold (mm)
    if(Math.abs(v) <= eps) return 'Normal';
    return (v > 0) ? 'Protrusion' : 'Retrusion';
  }

  // ===== RRZ V29: Molar Relation (U6M vs L6M) =====
  function rrzMolarRelationMm(){
    if(!rrzPlaced('U6M') || !rrzPlaced('L6M')) return null;
    const u = rrzP('U6M'), l = rrzP('L6M');
    // Convention: anterior direction is +X (to the right).
    return (u.left - l.left) * calibrationScale;
  }
  function rrzMolarClass(deltaMm){
    if(deltaMm === null || deltaMm === undefined || isNaN(deltaMm)) return '--';
    // Class I: same level or by 1 mm deviation
    if(Math.abs(deltaMm) <= 1) return 'Class I';
    // Class II/III threshold: 1.5 mm (per user spec)
    if(deltaMm > 1.5) return 'Class II';
    if(deltaMm < -1.5) return 'Class III';
    // Borderline zone between 1‚Äì1.5 mm
    return (deltaMm > 0) ? 'Class II (Borderline)' : 'Class III (Borderline)';
  }


  // ===== Helper: midpoint between two points (Fabric objects or plain {left,top}) =====
  function midpointPoint(pA, pB){
    if(!pA || !pB) return null;
    const aLeft = (pA.left !== undefined) ? pA.left : (pA.x !== undefined ? pA.x : 0);
    const aTop  = (pA.top  !== undefined) ? pA.top  : (pA.y !== undefined ? pA.y : 0);
    const bLeft = (pB.left !== undefined) ? pB.left : (pB.x !== undefined ? pB.x : 0);
    const bTop  = (pB.top  !== undefined) ? pB.top  : (pB.y !== undefined ? pB.y : 0);
    return { left: (aLeft + bLeft)/2, top: (aTop + bTop)/2 };
  }

  // ==================================================================

  function projectPointOnLine(P, A, B){
    const ax = A.left, ay = A.top;
    const bx = B.left, by = B.top;
    const px = P.left, py = P.top;
    const vx = bx - ax, vy = by - ay;
    const denom = vx*vx + vy*vy;
    if(denom === 0) return { x: ax, y: ay, t: 0 };
    const t = ((px - ax)*vx + (py - ay)*vy) / denom;
    return { x: ax + t*vx, y: ay + t*vy, t };
  }

  function signedDistanceAlongLine(P1, P2, A, B){
    const u = { x: B.left - A.left, y: B.top - A.top };
    const mag = Math.hypot(u.x, u.y);
    if(mag === 0) return 0;
    const ux = u.x / mag, uy = u.y / mag;
    const dx = P2.x - P1.x, dy = P2.y - P1.y;
    return (dx*ux + dy*uy) * calibrationScale; // Convert to real mm
  }

  function safeGet(key){ return cephPoints[key] || null; }
  
  // ====================================================
  // ========== NEW: OCCLUSION ANALYSIS FUNCTIONS =======
  // ====================================================// ===== FUNCTION 1: Analyze UI-coronal (U1E) vs LI-coronal (L1E) relationship =====
function analyzeOcclusion() {
  // Simplified occlusion logic based ONLY on UI-coronal (U1E) vs LI-coronal (L1E)
  // Rules (mm):
  // - Normal: UI is ~1mm anterior AND ~1mm inferior to LI
  // - Overjet: UI is >= 2mm anterior to LI
  // - Deep bite: UI is anterior AND inferior with inferior component around >= 3mm
  // - Edge-to-edge: UI at same position as LI (within tolerance)
  // - Cross bite (reverse bite): UI is posterior to LI
  // - Open bite: UI is above LI
  //
  // Output in analysis page:
  //   Overjet / Overbite / Open bite / Cross bite => (mild / moderate / sever)
  //   Combine disturbance => (Normal / Edge to edge / Overjet / Overbite / Deep bite / Open bite / Cross bite) with "+" combinations.

  const ui = safeGet('U1E');
  const li = safeGet('L1E');

  if (!ui || !li || !rrzPlaced('U1E') || !rrzPlaced('L1E')) {
    return {
      combineDisturbance: '-',
      overjetSeverity: '-',
      overbiteSeverity: '-',
      openbiteSeverity: '-',
      crossbiteSeverity: '-',
      dx: null,
      dy: null
    };
  }

  // Differences in mm:
  // dx > 0 => UI anterior to LI
  // dy > 0 => UI inferior to LI
  const dx = (ui.left - li.left) * calibrationScale;
  const dy = (ui.top  - li.top ) * calibrationScale;

  // Tolerances / thresholds
  const EPS = 0.5;          // "same point" tolerance
  const NORM_AX = 1.0;      // normal anterior
  const NORM_DN = 1.0;      // normal inferior
  const NORM_TOL = 0.75;    // tolerance around normal
  const OJ_MIN = 2.0;       // overjet threshold
  const OB_MIN = 2.0;       // overbite threshold (starts from)
  const DEEP_DY = 3.0;      // deep bite inferior threshold (per your simplified rule)
  const OPEN_MIN = 1.0;     // open bite threshold (UI above by >=1mm)
  const CROSS_MIN = 0.5;    // any posterior beyond noise

  // Classification helpers
  const above = (-dy); // UI above LI => positive above magnitude
  const posterior = (-dx); // UI posterior to LI => positive posterior magnitude

  const isEdge = (Math.abs(dx) <= EPS && Math.abs(dy) <= EPS);
  const isNormal = (!isEdge &&
    Math.abs(dx - NORM_AX) <= NORM_TOL &&
    Math.abs(dy - NORM_DN) <= NORM_TOL
  );

  const hasOverjet = (dx >= OJ_MIN);
  const hasOverbite = (dy >= OB_MIN && dx >= 0); // require not posterior
  const hasDeepBite = (dy >= DEEP_DY && dx >= 0);
  const hasOpenBite = (above >= OPEN_MIN);
  const hasCrossBite = (posterior >= CROSS_MIN);

  // Severity functions (return '-', 'mild', 'moderate', 'sever')
  function sevOverjet(x){
    if (x < OJ_MIN) return '-';
    if (x < 4.0) return 'mild';
    if (x < 6.0) return 'moderate';
    return 'sever';
  }
  function sevOverbite(y){
    if (y < OB_MIN) return '-';
    if (y < 3.0) return 'mild';
    if (y < 4.5) return 'moderate';
    return 'sever';
  }
  function sevOpen(aboveMm){
    if (aboveMm < OPEN_MIN) return '-';
    if (aboveMm < 3.0) return 'mild';
    if (aboveMm < 5.0) return 'moderate';
    return 'sever';
  }
  function sevCross(postMm){
    if (postMm < CROSS_MIN) return '-';
    if (postMm < 2.0) return 'mild';
    if (postMm < 4.0) return 'moderate';
    return 'sever';
  }

  const overjetSeverity = sevOverjet(dx);
  const overbiteSeverity = sevOverbite(dy);
  const openbiteSeverity = sevOpen(above);
  const crossbiteSeverity = sevCross(posterior);

  // Combine disturbance string (can be single or multiple)
  let combo = [];
  if (isEdge) {
    combo = ['Edge to edge'];
  } else if (isNormal && !hasOverjet && !hasOverbite && !hasOpenBite && !hasCrossBite) {
    combo = ['Normal'];
  } else {
    // Allow combinations as in your reference figure
    if (hasOpenBite) combo.push('Open bite');
    if (hasCrossBite) combo.push('Cross bite');
    if (hasOverjet) combo.push('Overjet');
    if (hasOverbite) combo.push(hasDeepBite ? 'Deep bite' : 'Overbite');
    if (combo.length === 0) combo = ['Normal'];
  }

  return {
    // primary outputs
    combineDisturbance: combo.join(' + '),
    overjetSeverity,
    overbiteSeverity,
    openbiteSeverity,
    crossbiteSeverity,
    // useful numeric values (mm)
    dx: dx,
    dy: dy
  };
}

// Helper: Incisor axis inclination using (coronal ‚Üî apex) line
// We use the same anterior direction as the overjet calculation (+X == anterior).
function rrzIncisorAxisInfo(apexKey, coronalKey, label) {
  if (!rrzPlaced(apexKey) || !rrzPlaced(coronalKey)) return null;

  const apex = rrzP(apexKey);
  const cor  = rrzP(coronalKey);

  const dxPx = (cor.left - apex.left);
  const dyPx = (cor.top  - apex.top);

  const dxMm = dxPx * calibrationScale;

  // Axis angle relative to true horizontal (y-up coordinate system)
  let ang = Math.atan2(-(dyPx), dxPx) * 180 / Math.PI;
  // Normalize to 0..180 for readability
  if (ang < 0) ang += 180;

  const EPS_MM = 0.5;
  let inclination = 'Neutral inclination';
  if (dxMm > EPS_MM) inclination = `Protruinclination of ${label} incisors`;
  if (dxMm < -EPS_MM) inclination = `Retruinclination of ${label} incisors`;

  return {
    angle: ang,
    dxMm: dxMm,
    inclination: inclination
  };
}

  // ===== FUNCTION 2: Analyze Interincisal Angle =====
  function analyzeInterincisalAngle(angles) {
    if (!angles || !angles.Interincisal) {
      return {
        angle: 'Not calculated',
        deviation: '--',
        upperInclination: '--',
        lowerInclination: '--',
        analysis: 'Interincisal angle not available'
      };
    }
  
    const interincisal = angles.Interincisal;
    const normalRange = { min: 125, max: 135 };
  
    const upper = rrzIncisorAxisInfo('U1A', 'U1E', 'upper');
    const lower = rrzIncisorAxisInfo('L1A', 'L1E', 'lower');
  
    const upperText = upper ? `${upper.inclination} (axis ${upper.angle.toFixed(1)}¬∞)` : '--';
    const lowerText = lower ? `${lower.inclination} (axis ${lower.angle.toFixed(1)}¬∞)` : '--';
  
    let deviation = '';
    let overallAnalysis = '';
  
    if (interincisal >= normalRange.min && interincisal <= normalRange.max) {
      deviation = 'Normal interincisal angle';
      overallAnalysis = 'Normal relationship between upper and lower incisor axes';
    } else if (interincisal > normalRange.max) {
      deviation = 'Increase in interincisal angle';
  
      // Determine cause based on which incisor axis shows retru-inclination (crown posterior to root apex)
      const causes = [];
      if (upper && upper.inclination.includes('Retruinclination')) causes.push('Retruinclination of upper incisors');
      if (lower && lower.inclination.includes('Retruinclination')) causes.push('Retruinclination of lower incisors');
  
      if (causes.length === 1) {
        overallAnalysis = `Increased interincisal angle due to ${causes[0]}`;
      } else if (causes.length === 2) {
        overallAnalysis = 'Increased interincisal angle due to retru-inclination of both upper and lower incisors';
      } else {
        overallAnalysis = 'Increased interincisal angle (verify U1A/U1E and L1A/L1E placement)';
      }
    } else {
      deviation = 'Decrease in interincisal angle';
  
      // Determine cause based on which incisor axis shows protru-inclination (crown anterior to root apex)
      const causes = [];
      if (upper && upper.inclination.includes('Protruinclination')) causes.push('Protruinclination of upper incisors');
      if (lower && lower.inclination.includes('Protruinclination')) causes.push('Protruinclination of lower incisors');
  
      if (causes.length === 1) {
        overallAnalysis = `Decreased interincisal angle due to ${causes[0]}`;
      } else if (causes.length === 2) {
        overallAnalysis = '';
      } else {
        overallAnalysis = 'Decreased interincisal angle (verify U1A/U1E and L1A/L1E placement)';
      }
    }
  
    return {
      angle: interincisal.toFixed(1) + '¬∞',
      deviation: deviation,
      upperInclination: upperText,
      lowerInclination: lowerText,
      analysis: overallAnalysis
    };
  }

  // ===== FUNCTION 3: Calculate Incisor Inclination Lines =====
  function calculateIncisorInclination() {
    if (!rrzPlaced('U1A') || !rrzPlaced('U1E') || !rrzPlaced('L1A') || !rrzPlaced('L1E')) {
      return {
        upperLine: null,
        lowerLine: null,
        upperAngle: null,
        lowerAngle: null
      };
    }

    // Upper incisor line: U1A to U1E (represents upper incisor axis)
    const upperLine = {
      start: { x: rrzP('U1A').left, y: rrzP('U1A').top },
      end: { x: rrzP('U1E').left, y: rrzP('U1E').top }
    };

    // Lower incisor line: L1A to L1E (represents lower incisor axis)
    const lowerLine = {
      start: { x: rrzP('L1A').left, y: rrzP('L1A').top },
      end: { x: rrzP('L1E').left, y: rrzP('L1E').top }
    };

    // Calculate angles relative to horizontal
    const upperAngle = Math.atan2(upperLine.end.y - upperLine.start.y, upperLine.end.x - upperLine.start.x) * 180 / Math.PI;
    const lowerAngle = Math.atan2(lowerLine.end.y - lowerLine.start.y, lowerLine.end.x - lowerLine.start.x) * 180 / Math.PI;

    return {
      upperLine: upperLine,
      lowerLine: lowerLine,
      upperAngle: upperAngle,
      lowerAngle: lowerAngle
    };
  }

  // ====================================================
  // ========== ENHANCED CALCULATION FUNCTIONS ==========
  // ====================================================

  function calculateAllAngles() {
    const angles = {};
    
    const allPointsExist = (...keys) => keys.every(key => rrzPlaced(key));
    
    // ===== Basic Angles =====
    if (allPointsExist('S', 'N', 'A')) {
        angles.SNA = parseFloat(angleAt(cephPoints.S, cephPoints.N, cephPoints.A).toFixed(1));
    }
    
    if (allPointsExist('S', 'N', 'B')) {
        angles.SNB = parseFloat(angleAt(cephPoints.S, cephPoints.N, cephPoints.B).toFixed(1));
    }
    
    if (allPointsExist('A', 'N', 'B')) {
        angles.ANB = parseFloat(angleAt(cephPoints.A, cephPoints.N, cephPoints.B).toFixed(1));
    }
    
    // FMA (Tweed): Frankfort plane (Po-Or) to mandibular plane (Go-Gn preferred; fallback Go-Me)
    if (allPointsExist('Po', 'Or', 'Go', 'Gn')) {
        const rawFMA = parseFloat(calculateAngle(cephPoints.Po, cephPoints.Or, cephPoints.Go, cephPoints.Gn));
        const acuteFMA = Math.min(rawFMA, 180 - rawFMA);
        angles.FMA = parseFloat(acuteFMA.toFixed(1));
    } else if (allPointsExist('Po', 'Or', 'Go', 'Me')) {
        const rawFMA = parseFloat(calculateAngle(cephPoints.Po, cephPoints.Or, cephPoints.Go, cephPoints.Me));
        const acuteFMA = Math.min(rawFMA, 180 - rawFMA);
        angles.FMA = parseFloat(acuteFMA.toFixed(1));
    }

// IMPA (Tweed): derived from Tweed triangle (FMA + FMIA + IMPA = 180)
    // (Computed after FMIA is available to prevent acute/obtuse flipping.)

// Downs (WebCeph-style): "Incisor mandibular plane angle" as deviation from 90¬∞,
    // using the Downs mandibular plane definition (Go‚ÄìGn). Use the obtuse internal angle.
    if (allPointsExist('Go', 'Gn', 'L1A', 'L1E')) {
        let dnRaw = parseFloat(calculateAngle(cephPoints.Go, cephPoints.Gn, cephPoints.L1A, cephPoints.L1E));
        if (!isNaN(dnRaw) && dnRaw < 90) dnRaw = 180 - dnRaw;
        angles.DownIncisorMandPlane = parseFloat((dnRaw - 90).toFixed(1));
    } else if (allPointsExist('Go', 'Me', 'L1A', 'L1E')) {
        // Fallback if Gn not available
        let dnRaw = parseFloat(calculateAngle(cephPoints.Go, cephPoints.Me, cephPoints.L1A, cephPoints.L1E));
        if (!isNaN(dnRaw) && dnRaw < 90) dnRaw = 180 - dnRaw;
        angles.DownIncisorMandPlane = parseFloat((dnRaw - 90).toFixed(1));
    }
    


    // Tweed FMIA: Frankfort plane (Po-Or) to mandibular incisor axis (L1A-L1E)
    if (allPointsExist('Po', 'Or', 'L1A', 'L1E')) {
        const rawFMIA = parseFloat(calculateAngle(cephPoints.Po, cephPoints.Or, cephPoints.L1A, cephPoints.L1E));
        const acuteFMIA = Math.min(rawFMIA, 180 - rawFMIA);
        angles.FMIA = parseFloat(acuteFMIA.toFixed(1));
    }

    // IMPA (Tweed): derived for internal consistency (FMA + FMIA + IMPA = 180)
    if (typeof angles.FMA === 'number' && typeof angles.FMIA === 'number') {
        angles.IMPA = parseFloat((180 - (angles.FMA + angles.FMIA)).toFixed(1));
    }

// Mandibular plane to SN (Steiner): Go-Gn to SN
    if (allPointsExist('Go', 'Gn', 'S', 'N')) {
        angles.GoGn_SN = parseFloat(calculateAngle(cephPoints.Go, cephPoints.Gn, cephPoints.S, cephPoints.N));
    }
    if (allPointsExist('U1A', 'U1E', 'N', 'A')) {
        angles.U1_NA = parseFloat(calculateAngle(cephPoints.U1A, cephPoints.U1E, cephPoints.N, cephPoints.A));
    }
    
    if (allPointsExist('L1A', 'L1E', 'N', 'B')) {
        angles.L1_NB = parseFloat(calculateAngle(cephPoints.L1A, cephPoints.L1E, cephPoints.N, cephPoints.B));
    }
    
    if (allPointsExist('U1A', 'U1E', 'L1A', 'L1E')) {
        angles.Interincisal = parseFloat(calculateAngle(cephPoints.U1A, cephPoints.U1E, cephPoints.L1A, cephPoints.L1E));
    }
    
    // Gonial angle (canonical): Ar-Go-Me (Bj√∂rk/Jarabak). 
    // Fallback (if Ar not available): Co-Go-Me (Condylion-based proxy).
    if (allPointsExist('Ar', 'Go', 'Me')) {
        angles.GonialAngle = parseFloat(angleAt(cephPoints.Ar, cephPoints.Go, cephPoints.Me).toFixed(1));
        angles.Gonial = angles.GonialAngle; // backward-compat label used in some tables
    } else if (allPointsExist('Co', 'Go', 'Me')) {
        angles.Gonial = parseFloat(angleAt(cephPoints.Co, cephPoints.Go, cephPoints.Me).toFixed(1));
    }
    
    // NOTE: "Saddle angle" in Bj√∂rk/Jarabak is N-S-Ar.
    // Any other angle using (S, Co, Gn) is not the classical saddle angle; keep it out of the core report.
    // (We will map angles.Saddle to angles.SaddleAngle later for backward compatibility.)
    
    if (allPointsExist('Prn', 'Sn', 'Ls')) {
        angles.Nasolabial = parseFloat(angleAt(cephPoints.Prn, cephPoints.Sn, cephPoints.Ls).toFixed(1));
    }
    
    if (allPointsExist('Po', 'Or', 'N', 'Pog')) {
        // Facial depth (Jarabak): angle between Frankfort plane (Po-Or) and Facial plane (N-Pog)
        const fd = parseFloat(calculateAngle(cephPoints.Po, cephPoints.Or, cephPoints.N, cephPoints.Pog));
        angles.Facial = fd;       // backward-compat label
        angles.FacialDepth = fd;  // canonical label used in reports
    }

    // ===== Downs Analysis Angles =====
    if (allPointsExist('N', 'Pog', 'Po', 'Or')) {
        angles.FacialAngle = parseFloat(calculateAngle(cephPoints.N, cephPoints.Pog, cephPoints.Po, cephPoints.Or));
    }
    
    if (allPointsExist('N', 'A', 'Pog')) {
        angles.Convexity = parseFloat(angleAt(cephPoints.N, cephPoints.A, cephPoints.Pog).toFixed(1));
    }
    
    
    // Jarabak "Facial convexity" in this project uses the same definition as convexity angle (N-A-Pog)
    if (angles.Convexity !== undefined) {
        angles.FacialConvexity = angles.Convexity;
    }
if (allPointsExist('S', 'Gn', 'Po', 'Or')) {
        angles.YAxis = parseFloat(calculateAngle(cephPoints.S, cephPoints.Gn, cephPoints.Po, cephPoints.Or));
    }
    

    // Y-axis to SN (Jarabak): angle between Y-axis (S-Gn) and SN
    if (allPointsExist('S', 'Gn', 'N')) {
        angles.Yaxis_SN = parseFloat(calculateAngle(cephPoints.S, cephPoints.Gn, cephPoints.S, cephPoints.N));
    }
    // Facial length on Y-axis (Jarabak): linear distance S-Gn (mm)
    if (allPointsExist('S', 'Gn')) {
        angles.FacialLength = dist(cephPoints.S, cephPoints.Gn);
    }

    const op = getOcclusalPlane();

    // Occlusal plane to SN (Steiner/Eastman): angle between Occlusal plane and SN
    if (op && allPointsExist('S', 'N')) {
        angles.Occlusal_SN = parseFloat(calculateAngle(op[0], op[1], cephPoints.S, cephPoints.N));
    }
    if (op && allPointsExist('Po', 'Or')) {
        angles.CantOcclusal = parseFloat(calculateAngle(op[0], op[1], cephPoints.Po, cephPoints.Or));
    }
    
    if (op && allPointsExist('L1A', 'L1E')) {
        angles.IncisorOcclusal = parseFloat(calculateAngle(cephPoints.L1A, cephPoints.L1E, op[0], op[1]));
        // Downs (WebCeph-style): 90¬∞ minus the acute angle between lower incisor axis and occlusal plane
        const _theta = angles.IncisorOcclusal;
        const _acute = Math.min(_theta, 180 - _theta);
        angles.DownIncisorOcclusal = parseFloat((90 - _acute).toFixed(1));
    }
    
    if (allPointsExist('S', 'Ar', 'Go')) {
        angles.Articular = parseFloat(angleAt(cephPoints.S, cephPoints.Ar, cephPoints.Go).toFixed(1));
    }

    // ===== Eastman Analysis Angles =====
    if (allPointsExist('S', 'N', 'ANS', 'PNS')) {
        angles.SN_Maxillary = parseFloat(calculateAngle(cephPoints.S, cephPoints.N, cephPoints.ANS, cephPoints.PNS));
    }
    
    if (allPointsExist('U1A', 'U1E', 'ANS', 'PNS')) {
        angles.U1_Maxillary = parseFloat(calculateAngle(cephPoints.U1A, cephPoints.U1E, cephPoints.ANS, cephPoints.PNS));
    }
    
    if (allPointsExist('ANS', 'PNS', 'Go', 'Me')) {
        angles.MaxMand = parseFloat(calculateAngle(cephPoints.ANS, cephPoints.PNS, cephPoints.Go, cephPoints.Me));
    }

    // ===== Jarabak Analysis Angles =====
    if (allPointsExist('N', 'S', 'Ar')) {
        angles.SaddleAngle = parseFloat(angleAt(cephPoints.N, cephPoints.S, cephPoints.Ar).toFixed(1));
        angles.Saddle = angles.SaddleAngle; // backward-compat label used in some tables

    }
    
    if (allPointsExist('S', 'Ar', 'Go')) {
        angles.ArticularAngle = parseFloat(angleAt(cephPoints.S, cephPoints.Ar, cephPoints.Go).toFixed(1));
    }
    
    // GonialAngle is already computed above (Ar-Go-Me). 
    


    // Upper & Lower Gonial Angles (Jarabak split)
    // Upper gonial: ‚à†(Ar-Go-N)
    if (allPointsExist('Ar', 'Go', 'N')) {
        angles.UpperGonial = parseFloat(angleAt(cephPoints.Ar, cephPoints.Go, cephPoints.N).toFixed(1));
    }
    // Lower gonial: ‚à†(N-Go-Me)
    if (allPointsExist('N', 'Go', 'Me')) {
        angles.LowerGonial = parseFloat(angleAt(cephPoints.N, cephPoints.Go, cephPoints.Me).toFixed(1));
    }

    // SN to Go-Me angle (Jarabak / also useful generally)
    if (allPointsExist('S', 'N', 'Go', 'Me')) {
        angles.SN_GoMe = parseFloat(calculateAngle(cephPoints.S, cephPoints.N, cephPoints.Go, cephPoints.Me));
    }
    if (angles.SaddleAngle && angles.ArticularAngle && angles.GonialAngle) {
        angles.BjorkSum = parseFloat((angles.SaddleAngle + angles.ArticularAngle + angles.GonialAngle).toFixed(1));
    }
    
    if (allPointsExist('S', 'N')) {
        angles.SN_Length = dist(cephPoints.S, cephPoints.N);
    }
    
    if (allPointsExist('S', 'Ar')) {
        angles.SAr_Length = dist(cephPoints.S, cephPoints.Ar);
    }
    
    if (allPointsExist('Ar', 'Go')) {
        angles.RamusHeight = dist(cephPoints.Ar, cephPoints.Go);
    }
    
    if (allPointsExist('Go', 'Me')) {
        angles.MandBodyLength = dist(cephPoints.Go, cephPoints.Me);
    }
    
    if (angles.MandBodyLength && angles.SN_Length) {
        angles.BodySNRatio = parseFloat((angles.MandBodyLength / angles.SN_Length * 100).toFixed(1));
    }
    
    if (allPointsExist('S', 'Go')) {
        angles.PosteriorFH = dist(cephPoints.S, cephPoints.Go);
    }
    
    if (allPointsExist('N', 'Me')) {
        angles.AnteriorFH = dist(cephPoints.N, cephPoints.Me);
    }
    
    if (angles.PosteriorFH && angles.AnteriorFH) {
        angles.FHRatio = parseFloat((angles.PosteriorFH / angles.AnteriorFH * 100).toFixed(1));
    }
    
    if (allPointsExist('N', 'Pog', 'Po', 'Or')) {
        angles.FacialPlane = parseFloat(calculateAngle(cephPoints.N, cephPoints.Pog, cephPoints.Po, cephPoints.Or));
    }
    
    if (op && allPointsExist('Go', 'Me')) {
        angles.OcclusalGoMe = parseFloat(calculateAngle(op[0], op[1], cephPoints.Go, cephPoints.Me));
    }
    
    if (allPointsExist('U1A', 'U1E', 'S', 'N')) {
        angles.U1_SN = parseFloat(calculateAngle(cephPoints.U1A, cephPoints.U1E, cephPoints.S, cephPoints.N));
    }

    
    // ===== RRZ: Normalize (angle vs 180-angle) using published means =====
    // This prevents "supplement flips" that create abnormal results when a line is drawn in reverse.
    const _ANGLE_MEANS = {
      // Steiner / core
      SNA: 82, SNB: 80, ANB: 2,
      FMA: 21.9, IMPA: 90, FMIA: 65,
      GoGn_SN: 32,
      U1_NA: 22, L1_NB: 25,
      Interincisal: 131,
      Occlusal_SN: 14,
      // Downs
      FacialAngle: 87.8,
      FacialPlane: 87.8,
      Convexity: 0,
      YAxis: 59,
      CantOcclusal: 9.3,
      IncisorOcclusal: 104.5,
      // Eastman
      SN_Maxillary: 8,
      U1_Maxillary: 108,
      MaxMand: 27,
      // Jarabak / Bj√∂rk
      SaddleAngle: 123,
      ArticularAngle: 143,
      GonialAngle: 128,
      Nasolabial: 95
    };

    Object.keys(_ANGLE_MEANS).forEach(k => {
      if (typeof angles[k] === 'number' && isFinite(angles[k])) {
        angles[k] = parseFloat(normalizeAngleToMean(angles[k], _ANGLE_MEANS[k]).toFixed(1));
      }
    });

    // Keep legacy aliases in sync AFTER normalization
    if (angles.GonialAngle !== undefined) angles.Gonial = angles.GonialAngle;
    if (angles.Convexity !== undefined) angles.FacialConvexity = angles.Convexity;
    if (angles.FacialDepth !== undefined) angles.Facial = angles.FacialDepth;
return angles;
  }

  function calculateLinearMeasurements() {
    const measurements = {};
    
    // ===== Steiner Measurements =====
    if (rrzPlaced('U1E') && rrzPlaced('N') && rrzPlaced('A')) {
      measurements.u1_na_mm = pointLineDistance(cephPoints.U1E, cephPoints.N, cephPoints.A);
    }
    
    if (rrzPlaced('L1E') && rrzPlaced('N') && rrzPlaced('B')) {
      measurements.l1_nb_mm = pointLineDistance(cephPoints.L1E, cephPoints.N, cephPoints.B);
    }
    
    // ===== Downs Measurements =====
    if (rrzPlaced('U1E') && rrzPlaced('A') && rrzPlaced('Pog')) {
      measurements.u1_apog_mm = pointLineDistance(cephPoints.U1E, cephPoints.A, cephPoints.Pog);
    }
    
    if (rrzPlaced('L1E') && rrzPlaced('A') && rrzPlaced('Pog')) {
      measurements.l1_apog_mm = pointLineDistance(cephPoints.L1E, cephPoints.A, cephPoints.Pog);
    }
    
    // ===== Eastman Measurements =====
    if (rrzPlaced('N') && rrzPlaced('ANS')) {
      measurements.uafh = dist(cephPoints.N, cephPoints.ANS);
    }
    
    if (rrzPlaced('ANS') && rrzPlaced('Me')) {
      measurements.lafh = dist(cephPoints.ANS, cephPoints.Me);
    }
    
    if (measurements.lafh && measurements.uafh) {
      measurements.total_afh = measurements.lafh + measurements.uafh;
      measurements.lafh_ratio = (measurements.lafh / measurements.total_afh * 100);
    }
    
    if (rrzPlaced('Li') && rrzPlaced('Prn') && rrzPlaced('PgS')) {
      measurements.ll_eplane = signedPointLineDistanceRightMm(rrzP('Li'), rrzP('Prn'), rrzP('PgS'));
      measurements.ll_eplane_jarabak = measurements.ll_eplane;
    }
    
    // ===== Jarabak Measurements =====
    if (rrzPlaced('U1E') && rrzPlaced('N') && rrzPlaced('Pog')) {
      measurements.u1_facial_mm = pointLineDistance(cephPoints.U1E, cephPoints.N, cephPoints.Pog);
    }
    
    if (rrzPlaced('Ls') && rrzPlaced('Prn') && rrzPlaced('PgS')) {
      measurements.ul_eplane = signedPointLineDistanceRightMm(rrzP('Ls'), rrzP('Prn'), rrzP('PgS'));
      measurements.ul_eplane_jarabak = measurements.ul_eplane;
    }
    
    if (rrzPlaced('Li') && rrzPlaced('Prn') && rrzPlaced('PgS')) {
      measurements.ll_eplane_jarabak = measurements.ll_eplane !== undefined ? measurements.ll_eplane : signedPointLineDistanceRightMm(rrzP('Li'), rrzP('Prn'), rrzP('PgS'));
    }


    // ===== Lip Lengths (Eastman) =====
    // Upper lip length: Sn ‚Üí Ls
    if (rrzPlaced('Sn') && rrzPlaced('Ls')) {
      measurements.ul_length = parseFloat(dist(cephPoints.Sn, cephPoints.Ls).toFixed(1));
    }

    
    // Backward/forward compatibility: expose _mm keys used by reports/UI
    if (measurements.ul_length !== undefined) {
      measurements.ul_length_mm = measurements.ul_length;
    }
// Lower lip length: Li ‚Üí M (Soft Menton). If M is not present, fallback to Sn ‚Üí Li.
    if (rrzPlaced('Li') && rrzPlaced('M')) {
      measurements.ll_length = parseFloat(dist(cephPoints.Li, cephPoints.M).toFixed(1));
    } else if (rrzPlaced('Sn') && rrzPlaced('Li')) {
      measurements.ll_length = parseFloat(dist(cephPoints.Sn, cephPoints.Li).toFixed(1));
    }

    
    // Backward/forward compatibility: expose _mm keys used by reports/UI
    if (measurements.ll_length !== undefined) {
      measurements.ll_length_mm = measurements.ll_length;
    }
// ===== Molar Relation =====
    const mr = rrzMolarRelationMm();
    if(mr !== null){
      measurements.molar_relation_mm = mr;
      measurements.molar_class = rrzMolarClass(mr);
    }

    return measurements;
  }

  function calculateWitsAppraisal() {
    if (!rrzPlaced('A') || !rrzPlaced('B')) return null;
    
    const occlusalPlane = getOcclusalPlane();
    if (!occlusalPlane) return null;
    
    const Aproj = projectPointOnLine(cephPoints.A, occlusalPlane[0], occlusalPlane[1]);
    const Bproj = projectPointOnLine(cephPoints.B, occlusalPlane[0], occlusalPlane[1]);
    
    return signedDistanceAlongLine(Aproj, Bproj, occlusalPlane[0], occlusalPlane[1]);
  }

  function calculateLowerAFHRatio() {
    if (!rrzPlaced('N') || !rrzPlaced('ANS') || !rrzPlaced('Me')) return null;
    
    const upperAFH = dist(cephPoints.N, cephPoints.ANS);
    const lowerAFH = dist(cephPoints.ANS, cephPoints.Me);
    const totalAFH = upperAFH + lowerAFH;
    
    if (totalAFH === 0) return null;
    
    return (lowerAFH / totalAFH) * 100;
  }

  function getOcclusalPlane(){
    let a, b;

    // Prefer manual Occlusal Plane points (added)
    if (rrzPlaced('OcclA') && cephPoints.OcclA && rrzPlaced('OcclP') && cephPoints.OcclP) {
      a = cephPoints.OcclA;
      b = cephPoints.OcclP;
    }
    // Fallback (approx): U1E to midpoint of upper molar (UMM-UMD)
    else if (rrzPlaced('U1E') && cephPoints.U1E && rrzPlaced('UMM') && cephPoints.UMM && rrzPlaced('UMD') && cephPoints.UMD) {
      a = cephPoints.U1E;
      b = midpointPoint(cephPoints.UMM, cephPoints.UMD);
    }
    // Legacy options (kept)
    else if (rrzPlaced('UMM') && rrzPlaced('LMM')) {
      a = cephPoints.UMM;
      b = cephPoints.LMM;
    } else if (rrzPlaced('U1E') && rrzPlaced('L1E')) {
      a = cephPoints.U1E;
      b = cephPoints.L1E;
    }

    return (a && b) ? [a, b] : null;
  }

  function severityFromZ(z){
    const az = Math.abs(z);
    if(!isFinite(az)) return { sev:'-', tag:'' };
    if(az < 1) return { sev:'Normal', tag:'' };
    if(az < 2) return { sev:'Mild', tag:'*' };
    if(az < 3) return { sev:'Moderate', tag:'**' };
    return { sev:'Severe', tag:'***' };
  }

  
  // ===== RRZ V31: Analysis-required landmarks tables (Generate Report + Final Report) =====
  const RRZ_ANALYSIS_REQUIRED = {
    steiner: ['S','N','A','B','OcclA','OcclP','Go','Gn','U1A','U1E','L1A','L1E','Prn','PgS','Ls','Li'],
    downs:   ['Po','Or','N','A','Pog','S','Gn','Go','Me','U1A','U1E','L1A','L1E','OcclA','OcclP','Co','Ar'],
    eastman: ['S','N','A','B','ANS','PNS','OcclA','OcclP','Go','Me','U1A','U1E','L1A','L1E','Prn','PgS','Ls','Li','Cm','Sn'],
    jarabak: ['N','S','Ar','Go','Me','A','B','Pog','Po','Or','OcclA','OcclP','U1A','U1E','L1A','L1E','Prn','PgS','Ls','Li']
  };

  function rrzPointLabel(key){
    try{
      const canon = rrzCanonKey(key);
      const p = pointSettings.find(pp => rrzCanonKey(pp.key) === canon);
      return p ? p.id : canon;
    }catch(e){ return key; }
  }

  function rrzLandmarkTableHtml(keys, opts){
    opts = opts || {};
    const title = (opts.title !== undefined) ? opts.title : 'Required Landmarks';
    const showTitle = (opts.showTitle !== false);
    const fontSize = opts.fontSize || '11px';

    const rows = (keys || []).map(k=>{
      const canon = rrzCanonKey(k);
      const placed = rrzPlaced(canon);
      const label = rrzEscapeHtml(rrzPointLabel(canon));
      const statusTxt = placed ? '‚úÖ Placed' : '‚ö†Ô∏è Missing';
      return `<tr><td>${label}</td><td class="rrzMuted">${canon}</td><td style="font-weight:800">${statusTxt}</td></tr>`;
    }).join('');

    const head = showTitle
      ? `<div style="margin:10px 0 6px 0; font-weight:900; font-size:12px;">${title}</div>`
      : '';

    return head + `<div class="rrzLandmarkStatus"><table class="rrzTable" style="font-size:${fontSize}; margin-top:6px;">
        <thead><tr><th>Landmark</th><th class="rrzMuted">Key</th><th>Status</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  }

  function rrzUpdateReportLandmarkPanels(){
    const map = {
      rp_lm_steiner: RRZ_ANALYSIS_REQUIRED.steiner,
      rp_lm_downs: RRZ_ANALYSIS_REQUIRED.downs,
      rp_lm_eastman: RRZ_ANALYSIS_REQUIRED.eastman,
      rp_lm_jarabak: RRZ_ANALYSIS_REQUIRED.jarabak
    };
    Object.keys(map).forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = rrzLandmarkTableHtml(map[id], { showTitle:false, fontSize:'10.5px' });
    });
  }
  // ===== END RRZ V31 =====

  function renderTable(containerId, rows, opts){
    const el = document.getElementById(containerId);
    if(!el) return;

    opts = opts || {};

    // NOTE: Per project spec, Final Report tables MUST NOT show Z-score or Severity columns.
    // We keep Mean/SD + Result + Meaning only.
    const style = `
      <style>
        .rrzTable{width:100%;border-collapse:collapse;font-size:12px}
        .rrzTable th,.rrzTable td{border:1px solid #e2e8f0;padding:6px 8px}
        .rrzTable th{background:#f8fafc;text-align:left}
        .rrzMuted{color:#64748b}
        .rrzGood{color:#16a34a;font-weight:700}
        .rrzBad{color:#dc2626;font-weight:700}
      </style>
    `;

    const header = `<table class="rrzTable"><thead><tr>
        <th>Metric</th>
        <th class="rrzMuted">Mean</th>
        <th class="rrzMuted">S.D.</th>
        <th>Result</th>
        <th>Meaning</th>
      </tr></thead><tbody>`;

    const body = (rows || []).map(r => {
      const mean = (r?.mean ?? '-');
      const sd = (r?.sd ?? '-');
      const res = (r?.valueText ?? '-');
      const meaning = (r?.meaning ?? '-');
      return `<tr>
        <td>${r?.label ?? '-'}</td>
        <td class="rrzMuted">${mean}</td>
        <td class="rrzMuted">${sd}</td>
        <td>${res}</td>
        <td>${meaning}</td>
      </tr>`;
    }).join('');

    el.innerHTML = style + header + body + `</tbody></table>` + (opts.appendHtml || '');
  }

function buildRow(label, mean, sd, value, unit, meaningFn){
  // Supports numeric metrics (with Mean/SD/Z-severity) and also text-only rows (Mean/SD shown as '-')
  const hasValue = !(value === null || value === undefined || value === '');

  // Text row (e.g., occlusion relation)
  if (hasValue && typeof value !== 'number') {
    const valueText = String(value);
    const meaning = meaningFn ? meaningFn(value, mean, sd, {sev:'-',tag:''}) : '-';
    return {
      label,
      mean: (mean === null || mean === undefined) ? '-' : mean,
      sd: (sd === null || sd === undefined) ? '-' : sd,
      valueText,
      zText: '-',
      severity: '-',
      meaning: meaning || '-'
    };
  }

  // Numeric row
  const v = (!hasValue || isNaN(value)) ? null : value;
  const valueText = (v === null) ? '-' : (v.toFixed(1) + (unit || ''));
  const z = (v === null || mean === null || sd === null || sd === 0) ? null : ((v - mean) / sd);
  const zText = (z === null || !isFinite(z)) ? '-' : z.toFixed(2);
  const sevObj = (z === null) ? {sev:'-',tag:''} : severityFromZ(z);
  const meaning = (v === null) ? '-' : (meaningFn ? meaningFn(v, mean, sd, sevObj) : '');
  return { label, mean, sd, valueText, zText, severity: sevObj.sev, meaning };
}


  function meaningByMeanSD(v, mean, sd, lowLabel, highLabel){
    if(v === null || v === undefined || isNaN(v) || mean === null || sd === null || sd === 0) return '-';
    const lo = mean - sd;
    const hi = mean + sd;
    if(v < lo) return lowLabel || 'Low';
    if(v > hi) return highLabel || 'High';
    return 'Normal';
  }


  function meaningSkeletalClassANB(anb){ 
    if(anb > 4) return 'Skeletal Class II'; 
    if(anb < 0) return 'Skeletal Class III'; 
    return 'Skeletal Class I'; 
  }
  
  function meaningMaxillaSNA(sna){ 
    if(sna > 84) return 'Prognathic maxilla'; 
    if(sna < 80) return 'Retrognathic maxilla'; 
    return 'Normal A-P maxilla'; 
  }
  
  function meaningMandibleSNB(snb){ 
    if(snb > 82) return 'Prognathic mandible'; 
    if(snb < 78) return 'Retrognathic mandible'; 
    return 'Normal A-P mandible'; 
  }
  
  function meaningInterincisal(v){ 
    if(v < 125) return 'Reduced (proclination)'; 
    if(v > 135) return 'Increased (uprighting)'; 
    return 'Normal interincisal'; 
  }

  function meaningIMPA(v){
    if(v > 95) return 'Proclined';
    if(v < 85) return 'Retroclined';
    return 'Normal inclination';
  }

  function meaningNasolabial(v){
    if(v > 110) return 'Obtuse';
    if(v < 85) return 'Acute';
    return 'Normal';
  }

  function meaningFacialAngle(v){
    if(v > 92) return 'Prognathic';
    if(v < 85) return 'Retrognathic';
    return 'Normal';
  }

  function clearTracing() {
    tracingLines.forEach(l => canvas.remove(l));
    angleLabels.forEach(a => canvas.remove(a));
    tracingLines = [];
    angleLabels = [];
    canvas.renderAll();
  }

  // ====================================================
  // ========== MAIN ANALYSIS GENERATION FUNCTION =======
  // ====================================================
  function generateAnalysis() {
    window.RRZ_rpStack = [];

    drawAllLines();
    const angles = calculateAllAngles();
    const measurements = calculateLinearMeasurements();
    const wits = calculateWitsAppraisal();
    const lowerAFHRatio = calculateLowerAFHRatio();
    
    // New occlusion analysis
    const occlusion = analyzeOcclusion();
    const interincisalAnalysis = analyzeInterincisalAngle(angles);
    const incisorInclination = calculateIncisorInclination();
    
    // Update all display elements
    updateAllAnalysisPages(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis);
    
    // Update comprehensive display
    document.getElementById('comp_sna').innerText = angles.SNA ? angles.SNA.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_snb').innerText = angles.SNB ? angles.SNB.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_anb').innerText = angles.ANB ? angles.ANB.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_fma').innerText = angles.FMA ? angles.FMA.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_impa').innerText = angles.IMPA ? angles.IMPA.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_u1na_ang').innerText = angles.U1_NA ? angles.U1_NA.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_l1nb_ang').innerText = angles.L1_NB ? angles.L1_NB.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_inter').innerText = angles.Interincisal ? angles.Interincisal.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_gonial').innerText = angles.GonialAngle ? angles.GonialAngle.toFixed(1) + "¬∞" : (angles.Gonial ? angles.Gonial.toFixed(1) + "¬∞" : "-");
    document.getElementById('comp_saddle').innerText = angles.SaddleAngle ? angles.SaddleAngle.toFixed(1) + "¬∞" : (angles.Saddle ? angles.Saddle.toFixed(1) + "¬∞" : "-");
    document.getElementById('comp_nasolab').innerText = angles.Nasolabial ? angles.Nasolabial.toFixed(1) + "¬∞" : "-";
    document.getElementById('comp_facial').innerText = angles.Facial ? angles.Facial.toFixed(1) + "¬∞" : "-";

    addAngleLabelsToCanvas(angles);
    
    // Update final report sections
    updateFinalReport(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis);

    // ===== RRZ HARDENING: persist latest analysis package for AI / reuse (no recompute loops) =====
    try{
      window.RRZ_LAST_CEPH = {
        generated_at: new Date().toISOString(),
        angles: angles || {},
        measurements: measurements || {},
        wits: (wits !== undefined ? wits : null),
        lowerAFHRatio: (lowerAFHRatio !== undefined ? lowerAFHRatio : null),
        occlusion: occlusion || {},
        interincisalAnalysis: interincisalAnalysis || {},
        incisorInclination: incisorInclination || {}
      };
      // Lightweight text snapshots (avoid sending raw HTML)
      const _grabTxt = (id)=>{
        const el = document.getElementById(id);
        if(!el) return null;
        const t = (el.innerText || '').trim();
        return t ? t.slice(0, 12000) : null;
      };
      window.RRZ_LAST_CEPH_REPORT_TEXT = {
        final: _grabTxt('tbl_final') || _grabTxt('fr_final') || null,
        downs: _grabTxt('tbl_downs') || null,
        steiner: _grabTxt('tbl_steiner') || null,
        eastman: _grabTxt('tbl_eastman') || null,
        jarabak: _grabTxt('tbl_jarabak') || null,
        tweed: _grabTxt('tbl_tweed') || null,
        comprehensive: _grabTxt('tbl_comprehensive') || null,
        occlusion: _grabTxt('tbl_occlusion') || null
      };
      // Reset auto-treatment guard for this new analysis
      window.RRZ_LAST_TP_HASH = null;
    }catch(e){}


    canvas.renderAll();

    const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 });
    document.getElementById('resultPreview').innerHTML = `<img src="${dataURL}">`;
    document.getElementById('reportMiniImg').src = dataURL;

    document.getElementById('analysis-board').style.display = 'flex';
    try{ showReportPage('rp_quick'); }catch(e){}
  
    window.RRZ_reportReady = true;
  }

  function updateAllAnalysisPages(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis) {
    // ===== Quick Analysis =====
    document.getElementById('b_sna').innerText = angles.SNA ? (angles.SNA.toFixed(1) + "¬∞") : "-";
    document.getElementById('b_snb').innerText = angles.SNB ? (angles.SNB.toFixed(1) + "¬∞") : "-";
    document.getElementById('b_anb').innerText = angles.ANB ? (angles.ANB.toFixed(1) + "¬∞") : "-";
    document.getElementById('b_fma').innerText = angles.FMA ? (angles.FMA.toFixed(1) + "¬∞") : "-";
    document.getElementById('b_inter').innerText = angles.Interincisal ? (angles.Interincisal.toFixed(1) + "¬∞") : "-";

    // ===== Steiner Analysis =====
    document.getElementById('st_sna').innerText = angles.SNA ? angles.SNA.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_snb').innerText = angles.SNB ? angles.SNB.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_anb').innerText = angles.ANB ? angles.ANB.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_op_sn').innerText = angles.Occlusal_SN ? angles.Occlusal_SN.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_mp_sn').innerText = angles.GoGn_SN ? angles.GoGn_SN.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_u1na_ang').innerText = angles.U1_NA ? angles.U1_NA.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_u1na_mm').innerText = measurements.u1_na_mm ? measurements.u1_na_mm.toFixed(1) + "mm" : "-";
    document.getElementById('st_l1nb_ang').innerText = angles.L1_NB ? angles.L1_NB.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_l1nb_mm').innerText = measurements.l1_nb_mm ? measurements.l1_nb_mm.toFixed(1) + "mm" : "-";
    document.getElementById('st_inter').innerText = angles.Interincisal ? angles.Interincisal.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_facial').innerText = angles.FacialAngle ? angles.FacialAngle.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_yaxis').innerText = angles.YAxis ? angles.YAxis.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_convexity').innerText = angles.Convexity ? angles.Convexity.toFixed(1) + "¬∞" : "-";
    document.getElementById('st_ul_eline').innerText = (measurements.ul_eplane !== undefined && measurements.ul_eplane !== null) ? (measurements.ul_eplane.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ul_eplane) + ")") : "-";
    document.getElementById('st_ll_eline').innerText = (measurements.ll_eplane !== undefined && measurements.ll_eplane !== null) ? (measurements.ll_eplane.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ll_eplane) + ")") : "-";

    // ===== Downs Analysis =====
    document.getElementById('dn_facial').innerText = angles.FacialAngle ? angles.FacialAngle.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_convex').innerText = angles.Convexity ? angles.Convexity.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_mp').innerText = angles.FMA ? angles.FMA.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_yaxis').innerText = angles.YAxis ? angles.YAxis.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_cant_op').innerText = angles.CantOcclusal ? angles.CantOcclusal.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_inter').innerText = angles.Interincisal ? angles.Interincisal.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_inc_occl').innerText = (angles.DownIncisorOcclusal !== undefined && angles.DownIncisorOcclusal !== null) ? angles.DownIncisorOcclusal.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_inc_mp').innerText = (angles.DownIncisorMandPlane !== undefined && angles.DownIncisorMandPlane !== null) ? angles.DownIncisorMandPlane.toFixed(1) + "¬∞" : "-";
    document.getElementById('dn_u1_apog').innerText = measurements.u1_apog_mm ? measurements.u1_apog_mm.toFixed(1) + "mm" : "-";
    document.getElementById('dn_l1_apog').innerText = measurements.l1_apog_mm ? measurements.l1_apog_mm.toFixed(1) + "mm" : "-";

    // ===== Tweed Analysis =====
    try{
      document.getElementById('tw_fma').innerText  = angles.FMA  ? angles.FMA.toFixed(1)  + "¬∞" : "-";
      document.getElementById('tw_fmia').innerText = angles.FMIA ? angles.FMIA.toFixed(1) + "¬∞" : "-";
      document.getElementById('tw_impa').innerText = angles.IMPA ? angles.IMPA.toFixed(1) + "¬∞" : "-";
    }catch(e){}
    document.getElementById('dn_gonial').innerText = angles.GonialAngle ? angles.GonialAngle.toFixed(1) + "¬∞" : (angles.Gonial ? angles.Gonial.toFixed(1) + "¬∞" : "-");
    document.getElementById('dn_saddle').innerText = angles.SaddleAngle ? angles.SaddleAngle.toFixed(1) + "¬∞" : (angles.Saddle ? angles.Saddle.toFixed(1) + "¬∞" : "-");
    document.getElementById('dn_articular').innerText = angles.Articular ? angles.Articular.toFixed(1) + "¬∞" : "-";

    // ===== Eastman Analysis =====
    document.getElementById('ea_sna').innerText = angles.SNA ? angles.SNA.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_snb').innerText = angles.SNB ? angles.SNB.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_anb').innerText = angles.ANB ? angles.ANB.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_sn_mx').innerText = angles.SN_Maxillary ? angles.SN_Maxillary.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_wits').innerText = wits ? wits.toFixed(1) + "mm" : "-";
    document.getElementById('ea_u1_mx').innerText = angles.U1_Maxillary ? angles.U1_Maxillary.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_l1_mp').innerText = angles.IMPA ? angles.IMPA.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_inter').innerText = angles.Interincisal ? angles.Interincisal.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_mx_mp').innerText = angles.MaxMand ? angles.MaxMand.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_uafh').innerText = measurements.uafh ? measurements.uafh.toFixed(1) + "mm" : "-";
    document.getElementById('ea_lafh').innerText = measurements.lafh ? measurements.lafh.toFixed(1) + "mm" : "-";
    document.getElementById('ea_lafh_ratio').innerText = measurements.lafh_ratio ? measurements.lafh_ratio.toFixed(1) + "%" : "-";
    document.getElementById('ea_l1_apog').innerText = measurements.l1_apog_mm ? measurements.l1_apog_mm.toFixed(1) + "mm" : "-";
    document.getElementById('ea_ll_eplane').innerText = (measurements.ll_eplane !== undefined && measurements.ll_eplane !== null) ? (measurements.ll_eplane.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ll_eplane) + ")") : "-";
    document.getElementById('ea_nasolab').innerText = angles.Nasolabial ? angles.Nasolabial.toFixed(1) + "¬∞" : "-";
    document.getElementById('ea_ul_length').innerText = measurements.ul_length_mm ? measurements.ul_length_mm.toFixed(1) + "mm" : "-";
    document.getElementById('ea_ll_length').innerText = measurements.ll_length_mm ? measurements.ll_length_mm.toFixed(1) + "mm" : "-";

    // ===== Jarabak Analysis =====
    document.getElementById('ja_saddle').innerText = angles.SaddleAngle ? angles.SaddleAngle.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_articular').innerText = angles.ArticularAngle ? angles.ArticularAngle.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_gonial').innerText = angles.GonialAngle ? angles.GonialAngle.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_bjork_sum').innerText = angles.BjorkSum ? angles.BjorkSum.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_sn').innerText = angles.SN_Length ? angles.SN_Length.toFixed(1) + "mm" : "-";
    document.getElementById('ja_sar').innerText = angles.SAr_Length ? angles.SAr_Length.toFixed(1) + "mm" : "-";
    document.getElementById('ja_upper_gonial').innerText = angles.UpperGonial ? angles.UpperGonial.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_lower_gonial').innerText = angles.LowerGonial ? angles.LowerGonial.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_ramus').innerText = angles.RamusHeight ? angles.RamusHeight.toFixed(1) + "mm" : "-";
    document.getElementById('ja_body').innerText = angles.MandBodyLength ? angles.MandBodyLength.toFixed(1) + "mm" : "-";
    document.getElementById('ja_body_ratio').innerText = angles.BodySNRatio ? angles.BodySNRatio.toFixed(1) + "%" : "-";
    document.getElementById('ja_sna').innerText = angles.SNA ? angles.SNA.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_snb').innerText = angles.SNB ? angles.SNB.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_anb').innerText = angles.ANB ? angles.ANB.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_sn_gome').innerText = angles.SN_GoMe ? angles.SN_GoMe.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_facial_depth').innerText = angles.FacialDepth ? angles.FacialDepth.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_facial_length').innerText = angles.FacialLength ? angles.FacialLength.toFixed(1) + "mm" : "-";
    document.getElementById('ja_yaxis_sn').innerText = angles.Yaxis_SN ? angles.Yaxis_SN.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_pfh').innerText = angles.PosteriorFH ? angles.PosteriorFH.toFixed(1) + "mm" : "-";
    document.getElementById('ja_afh').innerText = angles.AnteriorFH ? angles.AnteriorFH.toFixed(1) + "mm" : "-";
    document.getElementById('ja_fh_ratio').innerText = angles.FHRatio ? angles.FHRatio.toFixed(1) + "%" : "-";
    document.getElementById('ja_facial_plane').innerText = angles.FacialPlane ? angles.FacialPlane.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_facial_convexity').innerText = angles.FacialConvexity ? angles.FacialConvexity.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_op_gome').innerText = angles.OcclusalGoMe ? angles.OcclusalGoMe.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_inter').innerText = angles.Interincisal ? angles.Interincisal.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_u1_sn').innerText = angles.U1_SN ? angles.U1_SN.toFixed(1) + "¬∞" : "-";
    document.getElementById('ja_u1_facial').innerText = measurements.u1_facial_mm ? measurements.u1_facial_mm.toFixed(1) + "mm" : "-";
    document.getElementById('ja_ul_eplane').innerText = (measurements.ul_eplane_jarabak !== undefined && measurements.ul_eplane_jarabak !== null) ? (measurements.ul_eplane_jarabak.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ul_eplane_jarabak) + ")") : "-";
    document.getElementById('ja_ll_eplane').innerText = (measurements.ll_eplane_jarabak !== undefined && measurements.ll_eplane_jarabak !== null) ? (measurements.ll_eplane_jarabak.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ll_eplane_jarabak) + ")") : "-";

    // ===== Occlusion Analysis =====
    if (occlusion) {
      const elRel = document.getElementById('occl_relation');
      const elOJ  = document.getElementById('occl_horizontal');
      const elOB  = document.getElementById('occl_vertical');
      const elOpen= document.getElementById('occl_bite_type');
      const elCross = document.getElementById('occl_crossbite');

      if (elRel)  elRel.innerText  = occlusion.combineDisturbance || '-';
      if (elOJ)   elOJ.innerText   = occlusion.overjetSeverity || '-';
      if (elOB)   elOB.innerText   = occlusion.overbiteSeverity || '-';
      if (elOpen) elOpen.innerText = occlusion.openbiteSeverity || '-';
      if (elCross)elCross.innerText= occlusion.crossbiteSeverity || '-';
    }

    // Create analysis tables
    createAnalysisTables(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis);
  }

  function updateFinalReport(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis) {
    // Skeletal Analysis
    document.getElementById('r_sna_status').innerText = angles.SNA ? meaningMaxillaSNA(angles.SNA) : "--";
    document.getElementById('r_sna_status').className = (!angles.SNA || angles.SNA > 84 || angles.SNA < 80) ? "abnormal" : "normal";
    document.getElementById('r_snb_status').innerText = angles.SNB ? meaningMandibleSNB(angles.SNB) : "--";
    document.getElementById('r_snb_status').className = (!angles.SNB || angles.SNB > 82 || angles.SNB < 78) ? "abnormal" : "normal";
    document.getElementById('r_anb_status').innerText = angles.ANB ? meaningSkeletalClassANB(angles.ANB) : "--";
    document.getElementById('r_anb_status').className = (!angles.ANB || angles.ANB > 4 || angles.ANB < 0) ? "abnormal" : "normal";
    document.getElementById('r_facial_down').innerText = angles.FacialAngle ? angles.FacialAngle.toFixed(1) + "¬∞" : "--";
    document.getElementById('r_convexity').innerText = angles.Convexity ? angles.Convexity.toFixed(1) + "¬∞" : "--";
    document.getElementById('r_yaxis').innerText = angles.YAxis ? angles.YAxis.toFixed(1) + "¬∞" : "--";

    // Dental Analysis
    document.getElementById('r_inter_val').innerText = angles.Interincisal ? (angles.Interincisal.toFixed(1) + "¬∞") : "--";
    document.getElementById('r_u1na_status').innerText = angles.U1_NA ? (angles.U1_NA.toFixed(1) + "¬∞") : "--";
    document.getElementById('r_l1nb_status').innerText = angles.L1_NB ? (angles.L1_NB.toFixed(1) + "¬∞") : "--";
    document.getElementById('r_impa_status').innerText = angles.IMPA ? meaningIMPA(angles.IMPA) : "--";
    document.getElementById('r_impa_status').className = '';
    document.getElementById('r_u1_apog').innerText = measurements.u1_apog_mm ? measurements.u1_apog_mm.toFixed(1) + "mm" : "--";
    document.getElementById('r_l1_apog').innerText = measurements.l1_apog_mm ? measurements.l1_apog_mm.toFixed(1) + "mm" : "--";
    // Molar relation (U6M - L6M)
    const mr2 = measurements?.molar_relation_mm;
    const mc2 = measurements?.molar_class;
    const elMR = document.getElementById('r_molar_relation');
    if(elMR) elMR.innerText = (mr2 !== undefined && mr2 !== null) ? (mr2.toFixed(1) + "mm ‚Äî " + (mc2 || rrzMolarClass(mr2))) : "--";

    // New occlusion analysis in final report
    if (occlusion) {
      const elC = document.getElementById('r_occlusion_relation');
      const elOJ = document.getElementById('r_ui_inclination');
      const elOB = document.getElementById('r_li_inclination');
      const elOpen = document.getElementById('r_bite_type');
      const elCross = document.getElementById('r_crossbite_severity');

      if (elC)    elC.innerText    = occlusion.combineDisturbance || "--";
      if (elOJ)   elOJ.innerText   = occlusion.overjetSeverity || "--";
      if (elOB)   elOB.innerText   = occlusion.overbiteSeverity || "--";
      if (elOpen) elOpen.innerText = occlusion.openbiteSeverity || "--";
      if (elCross)elCross.innerText= occlusion.crossbiteSeverity || "--";
    }

// Soft Tissue Analysis
    document.getElementById('r_nasolab_status').innerText = angles.Nasolabial ? meaningNasolabial(angles.Nasolabial) : "--";
    document.getElementById('r_facial_status').innerText = angles.Facial ? (angles.Facial.toFixed(1) + "¬∞") : "--";
    document.getElementById('r_lafh_ratio').innerText = measurements.lafh_ratio ? measurements.lafh_ratio.toFixed(1) + "%" : "--";
    document.getElementById('r_uafh').innerText = measurements.uafh ? measurements.uafh.toFixed(1) + "mm" : "--";
    document.getElementById('r_lafh').innerText = measurements.lafh ? measurements.lafh.toFixed(1) + "mm" : "--";
    document.getElementById('r_ul_eline').innerText = (measurements.ul_eplane !== undefined && measurements.ul_eplane !== null) ? (measurements.ul_eplane.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ul_eplane) + ")") : "--";
    document.getElementById('r_ll_eline').innerText = (measurements.ll_eplane !== undefined && measurements.ll_eplane !== null) ? (measurements.ll_eplane.toFixed(1) + "mm" + " (" + rrzElineDescriptor(measurements.ll_eplane) + ")") : "--";
  }

  function createAnalysisTables(angles, measurements, wits, lowerAFHRatio, occlusion, interincisalAnalysis) {
    const witsValue = wits !== null ? wits.toFixed(1) : null;
    const u1_na_mm = measurements?.u1_na_mm;
    const l1_nb_mm = measurements?.l1_nb_mm;
    const u1_apog_mm = measurements?.u1_apog_mm;
    const l1_apog_mm = measurements?.l1_apog_mm;
    const uafh = measurements?.uafh;
    const lafh = measurements?.lafh;
    const lafh_ratio = measurements?.lafh_ratio;

    // ===== Downs Analysis Table =====
    const downsRows = [
      buildRow('Facial angle', 87.8, 3.5, angles.FacialAngle, '¬∞', (v)=> meaningFacialAngle(v)),
      buildRow('Angle of convexity', 0.0, 5.1, angles.Convexity, '¬∞', (v)=> Math.abs(v)<=5 ? 'Straight' : (v>5?'Convex':'Concave')),
      buildRow('Mandibular plane (FMA)', 21.9, 5.0, angles.FMA, '¬∞', (v)=> v<=26 ? 'Normodivergent' : 'Hyperdivergent'),
      buildRow('Y-axis', 59.0, 6.0, angles.YAxis, '¬∞', (v)=> '-'),
      buildRow('Cant of occlusal', 9.3, 3.8, angles.CantOcclusal, '¬∞', (v)=> '-'),
      buildRow('Interincisal angle', 128.0, 5.3, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),
      buildRow('Incisor occlusal plane angle', 14.5, 3.5, angles.DownIncisorOcclusal, '¬∞', (v)=> '-'),
      buildRow('Incisor mandibular plane angle', 1.4, 3.8, angles.DownIncisorMandPlane, '¬∞', (v)=> '-'),
      buildRow('Upper incisor to A-Pog', 2.7, 1.8, u1_apog_mm, 'mm', (v)=> v<=4 ? 'Normal' : 'Protrusive'),
      buildRow('Lower incisor to A-Pog', 1.5, 1.8, l1_apog_mm, 'mm', (v)=> v<=3 ? 'Normal' : 'Protrusive'),
      buildRow('Gonial angle', 128.0, 7.0, angles.Gonial, '¬∞', (v)=> v>=110 && v<=130 ? 'Normal' : 'Abnormal'),
      buildRow('Saddle angle', 123.0, 5.0, angles.Saddle, '¬∞', (v)=> '-'),
      buildRow('Articular angle', 143.0, 6.0, angles.Articular, '¬∞', (v)=> '-')
    ];

    // ===== Steiner Analysis Table =====
    const steinerRows = [
      buildRow('SNA', 82.0, 2.0, angles.SNA, '¬∞', (v)=> meaningMaxillaSNA(v)),
      buildRow('SNB', 80.0, 2.0, angles.SNB, '¬∞', (v)=> meaningMandibleSNB(v)),
      buildRow('ANB', 2.0, 2.0, angles.ANB, '¬∞', (v)=> meaningSkeletalClassANB(v)),
      buildRow('Occlusal to SN', 14.0, 4.0, angles.Occlusal_SN, '¬∞', (v)=> '-'),
      buildRow('Mandibular plane to SN', 32.0, 5.0, angles.GoGn_SN, '¬∞', (v)=> '-'),
      buildRow('U1 to NA (angle)', 22.0, 6.0, angles.U1_NA, '¬∞', (v)=> '-'),
      buildRow('U1 to NA (mm)', 4.0, 3.0, u1_na_mm, 'mm', (v)=> '-'),
      buildRow('L1 to NB (angle)', 25.0, 5.0, angles.L1_NB, '¬∞', (v)=> '-'),
      buildRow('L1 to NB (mm)', 4.0, 3.0, l1_nb_mm, 'mm', (v)=> '-'),
      buildRow('Interincisal', 131.0, 6.0, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),
      buildRow('Facial angle', 87.8, 3.5, angles.FacialAngle, '¬∞', (v)=> meaningFacialAngle(v)),
      buildRow('Y-axis', 59.0, 6.0, angles.YAxis, '¬∞', (v)=> '-'),
      buildRow('Convexity', 0.0, 5.1, angles.Convexity, '¬∞', (v)=> Math.abs(v)<=5 ? 'Straight' : (v>5?'Convex':'Concave'))
    ];

    // ===== Eastman Analysis Table =====
    const eastmanRows = [
      buildRow('SNA', 82.0, 3.0, angles.SNA, '¬∞', (v)=> meaningMaxillaSNA(v)),
      buildRow('SNB', 79.0, 3.0, angles.SNB, '¬∞', (v)=> meaningMandibleSNB(v)),
      buildRow('ANB', 3.0, 1.0, angles.ANB, '¬∞', (v)=> meaningSkeletalClassANB(v)),
      buildRow('SN to maxillary plane', 8.0, 3.0, angles.SN_Maxillary, '¬∞', (v)=> '-'),
      buildRow('Wits appraisal', -0.3, 2.7, wits, 'mm', (v)=> Math.abs(v)<=2 ? 'Class I' : (v>2?'Class II':'Class III')),
      buildRow('U1 to maxillary plane', 108.0, 5.0, angles.U1_Maxillary, '¬∞', (v)=> '-'),
      buildRow('L1 to mandibular plane', 92.0, 5.0, angles.IMPA, '¬∞', (v)=> meaningIMPA(v)),
      buildRow('Interincisal', 133.0, 10.0, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),
      buildRow('Maxillary-mandibular planes', 27.0, 5.0, angles.MaxMand, '¬∞', (v)=> '-'),
      buildRow('Upper anterior face height', 53.0, 3.0, uafh, 'mm', (v)=> '-'),
      buildRow('Lower anterior face height', 70.0, 4.0, lafh, 'mm', (v)=> '-'),
      buildRow('Lower AFH ratio', 55.0, 2.0, lafh_ratio, '%', (v)=> '-'),
      buildRow('L1 to A-Pog', 1.5, 1.8, l1_apog_mm, 'mm', (v)=> v<=3 ? 'Normal' : 'Protrusive'),
            buildRow('Upper lip to E-plane', -4.0, 2.0, measurements?.ul_eplane, 'mm', (v,mean,sd)=> meaningByMeanSD(v, mean, sd, 'Retrusive', 'Protrusive')),
            buildRow('Lower lip to E-plane', -2.0, 2.0, measurements?.ll_eplane, 'mm', (v,mean,sd)=> meaningByMeanSD(v, mean, sd, 'Retrusive', 'Protrusive')),
      buildRow('Upper lip length', null, null, measurements?.ul_length_mm, 'mm', (v)=> '-'),
      buildRow('Lower lip length', null, null, measurements?.ll_length_mm, 'mm', (v)=> '-'),
      buildRow('Nasolabial', 95.0, 5.0, angles.Nasolabial, '¬∞', (v)=> meaningNasolabial(v))
    ];

    // ===== Jarabak Analysis Table =====
    const jarabakRows = [
      buildRow('Saddle angle (N-S-Ar)', 123.0, 5.0, angles.SaddleAngle, '¬∞', (v)=> '-'),
      buildRow('Articular angle (S-Ar-Go)', 143.0, 6.0, angles.ArticularAngle, '¬∞', (v)=> '-'),
      buildRow('Gonial angle (Ar-Go-Me)', 128.0, 7.0, angles.GonialAngle, '¬∞', (v)=> '-'),
      buildRow('Bjork sum', 394.0, 6.0, angles.BjorkSum, '¬∞', (v)=> '-'),
      buildRow('Anterior cranial base (S-N)', 72.0, 3.0, angles.SN_Length, 'mm', (v)=> '-'),
      buildRow('Posterior cranial base (S-Ar)', 38.0, 3.0, angles.SAr_Length, 'mm', (v)=> '-'),
      buildRow('Upper gonial angle', 52.0, 3.0, angles.UpperGonial, '¬∞', (v)=> '-'),
      buildRow('Lower gonial angle', 76.0, 4.0, angles.LowerGonial, '¬∞', (v)=> '-'),
      buildRow('Ramus height (Ar-Go)', 52.0, 4.0, angles.RamusHeight, 'mm', (v)=> '-'),
      buildRow('Mandibular body length (Go-Me)', 78.0, 5.0, angles.MandBodyLength, 'mm', (v)=> '-'),
      buildRow('Body to ant. cranial base ratio', 108.0, 5.0, angles.BodySNRatio, '%', (v)=> '-'),
      buildRow('SNA (Jarabak)', 82.0, 2.0, angles.SNA, '¬∞', (v)=> meaningMaxillaSNA(v)),
      buildRow('SNB (Jarabak)', 80.0, 2.0, angles.SNB, '¬∞', (v)=> meaningMandibleSNB(v)),
      buildRow('ANB (Jarabak)', 2.0, 2.0, angles.ANB, '¬∞', (v)=> meaningSkeletalClassANB(v)),
      buildRow('SN to Go-Me', 32.0, 5.0, angles.SN_GoMe, '¬∞', (v)=> '-'),
      buildRow('Facial depth', 90.0, 3.0, angles.FacialDepth, '¬∞', (v)=> '-'),
      buildRow('Facial length on Y axis', 123.0, 5.0, angles.FacialLength, 'mm', (v)=> '-'),
      buildRow('Y axis to SN', 59.0, 6.0, angles.Yaxis_SN, '¬∞', (v)=> '-'),
      buildRow('Posterior facial height (S-Go)', 78.0, 4.0, angles.PosteriorFH, 'mm', (v)=> '-'),
      buildRow('Anterior facial height (N-Me)', 123.0, 5.0, angles.AnteriorFH, 'mm', (v)=> '-'),
      buildRow('Facial height ratio (PFH/AFH)', 63.4, 4.0, angles.FHRatio, '%', (v)=> '-'),
      buildRow('Facial plane', 87.8, 3.5, angles.FacialPlane, '¬∞', (v)=> '-'),
      buildRow('Facial convexity', 0.0, 5.1, angles.FacialConvexity, '¬∞', (v)=> '-'),
      buildRow('Occlusal plane to Go-Me', 8.0, 4.0, angles.OcclusalGoMe, '¬∞', (v)=> '-'),
      buildRow('Interincisal angle', 131.0, 6.0, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),
      buildRow('U1 to SN', 103.0, 6.0, angles.U1_SN, '¬∞', (v)=> '-'),
      buildRow('U1 to facial plane', 2.7, 1.8, measurements?.u1_facial_mm, 'mm', (v)=> '-'),
      buildRow('Upper lip to E-plane', -4.0, 2.0, measurements?.ul_eplane_jarabak, 'mm', (v,mean,sd)=> meaningByMeanSD(v, mean, sd, 'Retrusive', 'Protrusive')),
      buildRow('Lower lip to E-plane', -2.0, 2.0, measurements?.ll_eplane_jarabak, 'mm', (v,mean,sd)=> meaningByMeanSD(v, mean, sd, 'Retrusive', 'Protrusive'))
    ];


    // ===== Tweed Analysis Table =====
    const tweedRows = [
      buildRow('FMA', 25.0, 4.0, angles.FMA, '¬∞', (v)=> v<=26 ? 'Normodivergent' : 'Hyperdivergent'),
      buildRow('FMIA', 65.0, 5.0, angles.FMIA, '¬∞', (v)=> '-'),
      buildRow('IMPA', 90.0, 3.5, angles.IMPA, '¬∞', (v)=> meaningIMPA(v))
    ];

// ===== Comprehensive 12 Angles Table =====
    const comprehensiveRows = [
      buildRow('SNA (Maxilla)', 82.0, 2.0, angles.SNA, '¬∞', (v)=> meaningMaxillaSNA(v)),
      buildRow('SNB (Mandible)', 80.0, 2.0, angles.SNB, '¬∞', (v)=> meaningMandibleSNB(v)),
      buildRow('ANB (Relation)', 2.0, 2.0, angles.ANB, '¬∞', (v)=> meaningSkeletalClassANB(v)),
      buildRow('FMA (Vertical)', 21.9, 5.0, angles.FMA, '¬∞', (v)=> v<=26 ? 'Normodivergent' : 'Hyperdivergent'),
      buildRow('IMPA (L1 Inclination)', 90.0, 5.0, angles.IMPA, '¬∞', (v)=> meaningIMPA(v)),
      buildRow('U1-NA (Incisor)', 22.0, 6.0, angles.U1_NA, '¬∞', (v)=> '-'),
      buildRow('L1-NB (Incisor)', 25.0, 5.0, angles.L1_NB, '¬∞', (v)=> '-'),
      buildRow('Interincisal', 131.0, 6.0, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),
      buildRow('Gonial Angle', 120.0, 10.0, angles.Gonial, '¬∞', (v)=> v>=110 && v<=130 ? 'Normal' : 'Abnormal'),
      buildRow('Saddle Angle', 123.0, 5.0, angles.Saddle, '¬∞', (v)=> '-'),
      buildRow('Nasolabial (Soft)', 95.0, 5.0, angles.Nasolabial, '¬∞', (v)=> meaningNasolabial(v)),
      buildRow('Facial Angle', 87.8, 3.5, angles.Facial, '¬∞', (v)=> meaningFacialAngle(v))
    ];

// ===== Occlusion Analysis Table =====
const occlusionRows = [
  buildRow('Overjet/Overbite Relation', null, null, occlusion?.relation, '', (v)=> v || '-'),
  buildRow('Horizontal Difference (mm)', null, null, occlusion?.raw?.horizontal, 'mm', (v)=> {
    if(v === null || v === undefined || isNaN(v)) return '-';
    const EPS = 0.5, OJ = 2.0;
    if(Math.abs(v) <= EPS) return 'Edge to edge relation';
    if(v >= (OJ - EPS) && v <= (OJ + EPS)) return 'Normal overjet';
    if(v > (OJ + EPS)) return 'Increased overjet';
    if(v <= -(1.5 - EPS)) return 'Edge to edge relation (UI behind)';
    return 'Edge to edge relation';
  }),
  buildRow('Vertical Difference (mm)', null, null, occlusion?.raw?.vertical, 'mm', (v)=> {
    if(v === null || v === undefined || isNaN(v)) return '-';
    const EPS = 0.5;
    if(v > EPS) return (v < 2 ? 'Mild open bite' : 'Open bite');
    if(Math.abs(v) <= EPS) return 'Edge to edge relation';
    const absV = Math.abs(v);
    if(absV <= 2.0 + EPS) return 'Normal overbite';
    if(absV <= 4.0 + EPS) return 'Increased overbite';
    return 'Deep bite';
  }),
  buildRow('Bite Type', null, null, occlusion?.biteType, '', (v)=> v || '-'),
  buildRow('Crossbite Assessment', null, null, occlusion?.crossbite, '', (v)=> v || '-'),

  buildRow('Interincisal Angle', 130.0, 5.0, angles.Interincisal, '¬∞', (v)=> meaningInterincisal(v)),

];

    // ===== Final Summary Table =====
    const finalRows = [
      { label:'Maxilla (SNA)', mean:'82.0', sd:'2.0', valueText: angles.SNA?angles.SNA.toFixed(1)+'¬∞':'-', zText:'', severity: (angles.SNA && (angles.SNA<80||angles.SNA>84))?'Abnormal':'Normal', meaning: angles.SNA?meaningMaxillaSNA(angles.SNA):'-' },
      { label:'Mandible (SNB)', mean:'80.0', sd:'2.0', valueText: angles.SNB?angles.SNB.toFixed(1)+'¬∞':'-', zText:'', severity: (angles.SNB && (angles.SNB<78||angles.SNB>82))?'Abnormal':'Normal', meaning: angles.SNB?meaningMandibleSNB(angles.SNB):'-' },
      { label:'Skeletal Class (ANB)', mean:'2.0', sd:'2.0', valueText: angles.ANB?angles.ANB.toFixed(1)+'¬∞':'-', zText:'', severity: (angles.ANB && (angles.ANB<0||angles.ANB>4))?'Abnormal':'Normal', meaning: angles.ANB?meaningSkeletalClassANB(angles.ANB):'-' },
      { label:'Vertical Pattern (FMA)', mean:'21.9', sd:'5.0', valueText: angles.FMA?angles.FMA.toFixed(1)+'¬∞':'-', zText:'', severity:'', meaning: angles.FMA?(angles.FMA<=26?'Normodivergent':'Hyperdivergent'):'-' },
      { label:'Interincisal', mean:'131.0', sd:'6.0', valueText: angles.Interincisal?angles.Interincisal.toFixed(1)+'¬∞':'-', zText:'', severity:'', meaning: angles.Interincisal?meaningInterincisal(angles.Interincisal):'-' },
      { label:'IMPA (L1 Inclination)', mean:'90.0', sd:'5.0', valueText: angles.IMPA?angles.IMPA.toFixed(1)+'¬∞':'-', zText:'', severity:'', meaning: angles.IMPA?meaningIMPA(angles.IMPA):'-' },
      { label:'Nasolabial Angle', mean:'95.0', sd:'5.0', valueText: angles.Nasolabial?angles.Nasolabial.toFixed(1)+'¬∞':'-', zText:'', severity:'', meaning: angles.Nasolabial?meaningNasolabial(angles.Nasolabial):'-' },
      { label:'Facial Angle (Downs)', mean:'87.8', sd:'3.5', valueText: angles.FacialAngle?angles.FacialAngle.toFixed(1)+'¬∞':'-', zText:'', severity:'', meaning: angles.FacialAngle?meaningFacialAngle(angles.FacialAngle):'-' },
      { label:'Lower AFH Ratio', mean:'55.0', sd:'2.0', valueText: lafh_ratio?lafh_ratio.toFixed(1)+'%':'-', zText:'', severity:'', meaning: lafh_ratio?(lafh_ratio>=53 && lafh_ratio<=57?'Normal':'Abnormal'):'-' }
    ];

    // Render all tables
    renderTable('tbl_downs', downsRows, { appendHtml: rrzLandmarkTableHtml(RRZ_ANALYSIS_REQUIRED.downs) });
    renderTable('tbl_written_downs', downsRows, { showSeverity:false});
    renderTable('tbl_steiner', steinerRows, { appendHtml: rrzLandmarkTableHtml(RRZ_ANALYSIS_REQUIRED.steiner) });
    renderTable('tbl_written_steiner', steinerRows, { showSeverity:false});
    renderTable('tbl_eastman', eastmanRows, { appendHtml: rrzLandmarkTableHtml(RRZ_ANALYSIS_REQUIRED.eastman) });
    renderTable('tbl_written_eastman', eastmanRows, { showSeverity:false});
    renderTable('tbl_jarabak', jarabakRows, { appendHtml: rrzLandmarkTableHtml(RRZ_ANALYSIS_REQUIRED.jarabak) });
    renderTable('tbl_tweed', tweedRows, { showSeverity:true });
    renderTable('tbl_written_jarabak', jarabakRows, { showSeverity:false});
    renderTable('tbl_comprehensive', comprehensiveRows);
    renderTable('tbl_final', finalRows, { showSeverity:false });
renderTable('tbl_occlusion', occlusionRows, { showSeverity:false });
    
    // Update Generate Report landmark panels
    try{ rrzUpdateReportLandmarkPanels(); }catch(e){}
    
    try{ 
      const el = document.getElementById('wr_date'); 
      if(el) el.textContent = new Date().toLocaleString('en-GB'); 
    } catch(e){}
  }

  function rrzOpenBoardOrGenerate(){
    try{
      if(window.RRZ_reportReady){
        document.getElementById('analysis-board').style.display = 'flex';
      }else{
        generateAnalysis();
      }
    }catch(e){
      try{ generateAnalysis(); }catch(_e){}
    }
  }

  function closeAnalysis() {
    clearTracing();
    document.getElementById('analysis-board').style.display = 'none';
  }

  function showFinalReport() {
    window.RRZ_finalStack = [];

    document.getElementById('finalReport').style.display = 'block';
    try{
      const d = new Date();
      const dt = d.toLocaleString('en-GB');
      const el = document.getElementById('wr_date');
      if(el) el.textContent = dt;
    }catch(e){}
    try{ showFinalPage('fr_written'); }catch(e){ try{ showFinalPage('fr_final'); }catch(_e){} }

    // Auto-generate treatment plan from FULL report (Downs/Steiner/...) once per analysis
    try{ rrzAutoTreatmentFromFinalReport(); }catch(e){}
  }

  function saveDivAsImage(divId, filename) {
    html2canvas(document.getElementById(divId), { scale: 3 }).then(c => {
      const link = document.createElement('a');
      link.download = filename + '.png';
      link.href = c.toDataURL('image/png');
      link.click();
    });
  }
    // ===== RRZ PATCH: Download CEPHALOMETRIC ANALYSIS should produce a FULL A4 PDF (each analysis on its own page) =====
  async function downloadCephalometricAnalysis(){
    // 1) Make sure the Final Report exists + tables are actually rendered BEFORE we clone anything
    try{ document.getElementById('finalReport').style.display = 'block'; }catch(e){}
    try{
      // If tables are empty, build them once (do NOT rebuild repeatedly).
      const hasAnyTable =
        !!document.querySelector('#tbl_final table, #tbl_downs table, #tbl_steiner table, #tbl_eastman table, #tbl_jarabak table, #tbl_tweed table, #tbl_comprehensive table, #tbl_occlusion table');
      if(!hasAnyTable && typeof generateAnalysis === 'function'){
        generateAnalysis();
      }
    }catch(e){}

    // Force final report layout + tabs to be ready (some browsers delay layout for hidden tabs)
    try{ if(typeof showFinalReport === 'function') showFinalReport(); }catch(e){}
    try{
      if(typeof showFinalPage === 'function'){
        ['fr_written','fr_final','fr_steiner','fr_downs','fr_eastman','fr_jarabak','fr_tweed','fr_comprehensive','fr_occlusion']
          .forEach(id=>{ try{ showFinalPage(id); }catch(_e){} });
        try{ showFinalPage('fr_written'); }catch(_e){}
      }
    }catch(e){}

    // Wait 2 frames to ensure DOM/paint is committed, so PDF is never blank
    try{
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    }catch(e){}

    const reportEl = document.getElementById('printableReport');
    if(!reportEl){
      alert('Report not ready. Please generate analysis first.');
      return;
    }

    // If tables are still missing, abort (prevents empty/blank PDF)
    const probeTbl = reportEl.querySelector('table');
    if(!probeTbl){
      alert('Report tables are empty. Please click Generate/Print Analysis first.');
      return;
    }

    // 2) Prepare helpers
    const patientName = (document.getElementById('reportPatientName')?.textContent || '--').trim();
    const reportDate  = (document.getElementById('reportDate')?.textContent || '').trim() || new Date().toLocaleDateString('en-GB');
    const caseId = '#RYL-2024';

    function _cloneClean(node){
      const c = node.cloneNode(true);

      // Remove any back buttons / navigation within the print view
      c.querySelectorAll('.rrzBackWrap, .rrzBackBtn, .rp-nav, .no-print').forEach(n=>n.remove());

      // Remove missed/placed + required-landmarks panels (print-only)
      c.querySelectorAll('.rrzLandmarkStatus').forEach(n=>{
        try{
          const prev = n.previousElementSibling;
          if(prev && prev.tagName === 'DIV' && (prev.textContent||'').trim().toLowerCase() === 'required landmarks' && !prev.querySelector('table')){
            prev.remove();
          }
        }catch(e){}
        n.remove();
      });

      // Remove any remaining standalone "Required Landmarks" title (without touching analysis tables)
      try{
        c.querySelectorAll('div').forEach(el=>{
          const t = (el.textContent||'').trim().toLowerCase();
          if(t === 'required landmarks' && !el.querySelector('table') && el.children.length === 0){
            el.remove();
          }
        });
      }catch(e){}

      // Remove any landmark panels by id prefix (legacy containers)
      try{
        c.querySelectorAll('[id^="rp_lm_"]').forEach(n=>{
          const wrap = n.parentElement;
          if(wrap) wrap.remove(); else n.remove();
        });
      }catch(e){}

      // Ensure no "Go Back" buttons are printed
      try{
        c.querySelectorAll('button').forEach(b=>{
          const t = (b.textContent||'').trim().toLowerCase();
          if(t.includes('go back')) b.remove();
        });
      }catch(e){}

      return c;
    }

    // 3) Build A4 pages (NO DUPLICATED TABLES)
    const pages = [];

    // Page: Overview (skeletal/dental/soft tissue + mini image) ONLY
    try{
      const bodyEl = reportEl.querySelector('.report-body');
      const overview = _cloneClean(bodyEl);
      overview.querySelectorAll('.rp-nav, .rp-page').forEach(n=>n.remove()); // remove tabs completely
      pages.push({ title:'Overview', html: overview.outerHTML });
    }catch(e){}


    // Page: Final Summary
    try{
      const fs = _cloneClean(document.getElementById('fr_final'));
      pages.push({ title:'Final Summary', html: fs.outerHTML });
    }catch(e){}

    // Each analysis on its own A4 page
    const analysisPages = [
      ['fr_steiner',       'Steiner Analysis'],
      ['fr_downs',         'Downs Analysis'],
      ['fr_eastman',       'Eastman Analysis'],
      ['fr_jarabak',       'Jarabak Analysis'],
      ['fr_tweed',         'Tweed Analysis'],
      ['fr_comprehensive', '12 Angles Analysis'],
      ['fr_occlusion',     'Occlusion Analysis'],
    ];

    analysisPages.forEach(([id, title])=>{
      const el = document.getElementById(id);
      if(!el) return;
      const c = _cloneClean(el);
      c.style.display = 'block';
      c.classList.add('rrzPrintTabPage');
      pages.push({ title, html: c.outerHTML });
    });

    // 4) Compose print HTML (stable, compact, A4-friendly)
    const extraCss = `
      <style>
        @page { size: A4; margin: 10mm; }
        html,body{ background:#fff; }
        body{
          margin:0; padding:0;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
          color:#111;
          font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        }

        .rrzA4Page{
          width: 190mm;
          min-height: 277mm;
          margin: 0 auto;
          page-break-after: always;
          break-after: page;
          box-sizing: border-box;
          background:#fff;
          border: 2px solid #c5a059;
          border-radius: 14px;
          padding: 7mm 8mm;
          position: relative;
        }
        .rrzA4Page:before{
          content:"";
          position:absolute;
          inset: 4mm;
          border: 1px solid rgba(197,160,89,0.55);
          border-radius: 12px;
          pointer-events:none;
        }
        .rrzA4Page:last-child{ page-break-after:auto; break-after:auto; }

        .rrzPageHdr{
          display:flex;
          justify-content:space-between;
          align-items:flex-end;
          gap:12px;
          margin: 0 0 6mm 0;
          padding: 0 0 4mm 0;
          border-bottom: 2px solid rgba(197,160,89,0.65);
        }
        .rrzPageHdr .left .brand{ font-weight:900; letter-spacing:.6px; font-size:12px; }
        .rrzPageHdr .left .main{ font-weight:900; font-size:16px; margin-top:4px; }
        .rrzPageHdr .left .sub{ font-weight:800; font-size:12px; margin-top:2px; color:#374151; }
        .rrzPageHdr .right{ text-align:right; font-size:11px; color:#334155; line-height:1.35; }

        /* Make sure content is printable and does not collapse */
        .report-card{ box-shadow:none !important; margin:0 !important; border:0 !important; background:#fff !important; }

        .report-section{
          border-left: 4px solid #d1d5db;
          padding-left: 12px;
          break-inside: avoid;
          page-break-inside: avoid;
          margin: 10px 0;
        }
        h3{ margin: 0 0 8px 0 !important; font-size: 14px; }

        .report-item{
          display:flex;
          justify-content:space-between;
          gap:18px;
          padding:6px 0;
          border-bottom:1px dashed #e5e7eb;
          font-size:12px;
        }
        .report-item:last-child{ border-bottom:none; }
        .report-item span:last-child{ font-weight:700; }

        .rrzPatientBanner{
          border:1px solid #e5e7eb;
          border-radius:10px;
          padding:10px 12px;
          margin: 8px 0 10px 0;
        }
        .rrzPatientBanner .name{ font-size: 16px; font-weight: 900; margin-top: 4px; }

        img{ max-width:100%; height:auto; }

        table, .rrzTable{
          width:100%;
          border-collapse:collapse;
          break-inside: avoid;
          page-break-inside: avoid;
          font-size:10.5px;
        }
        .rrzTable th, .rrzTable td, table th, table td{
          border:1px solid #e5e7eb;
        }
        th, td{ padding:4px 6px !important; }
      </style>
    `;

    const pagesHtml = pages.map(pg => `
      <section class="rrzA4Page">
        <div class="rrzPageHdr">
          <div class="left">
            <div class="brand">ROYAL RAY ZONE</div>
            <div class="main">CEPHALOMETRIC ANALYSIS</div>
            <div class="sub">${rrzEscapeHtml(pg.title)}</div>
          </div>
          <div class="right">
            <div>Date: ${rrzEscapeHtml(reportDate)}</div>
            <div>Case ID: ${rrzEscapeHtml(caseId)}</div>
            <div>Patient: ${rrzEscapeHtml(patientName)}</div>
          </div>
        </div>
        <div class="rrzPageContent">${pg.html}</div>
      </section>
    `).join('\n');

    const w = window.open('', '_blank');
    if(!w) return;

    w.document.open();
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">${extraCss}</head><body>${pagesHtml}</body></html>`);
    w.document.close();

    // Print after load to prevent blank PDF
    const doPrint = ()=>{ try{ w.focus(); w.print(); }catch(e){} };
    try{ w.onload = ()=> setTimeout(doPrint, 250); }catch(e){}
    setTimeout(doPrint, 600);
  }
  // ===== END RRZ PATCH =====




  function _rrzPrintWindow(title, bodyHtml){
    const w = window.open('', '_blank');
    if(!w) return;
    const css = `
      <style>
        body{ font-family: "Segoe UI", Tahoma, Arial, sans-serif; margin:24px; color:#111; }
        h1,h2,h3{ margin:0 0 10px 0; }
        .rrzPrintHeader{ margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid #ddd; }
        .rrzPrintHeader .brand{ font-weight:800; letter-spacing:1px; }
        .rrzPrintHeader .meta{ font-size:12px; color:#444; margin-top:6px; }
        .printPage{ page-break-after: always; }
        .printPage:last-child{ page-break-after: auto; }
        .report-section{ border-left:4px solid #999; padding-left:12px; margin:14px 0; }
        .report-item{ display:flex; justify-content:space-between; gap:18px; padding:6px 0; border-bottom:1px dashed #eee; font-size:13px; }
        .report-item:last-child{ border-bottom:none; }
        .rrzTable{width:100%;border-collapse:collapse;font-size:11px;margin:10px 0;}
                .rrzLandmarkStatus{display:none !important;}
.rrzTable th,.rrzTable td{border:1px solid #ddd;padding:6px 8px;}
        .rrzTable th{background:#f5f5f5;}
      </style>
    `;
    w.document.open();
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>${css}</head><body>${bodyHtml}</body></html>`);
    w.document.close();
    w.focus();
    setTimeout(()=>{ try{ w.print(); }catch(e){} }, 250);
  }

  function printComprehensiveReport() {
    const now = new Date().toLocaleString('en-GB');
    const angles = calculateAllAngles();
    
    const html = `
        <div class="print-page">
            <div class="rrzPrintHeader">
                <div class="brand">ROYAL RAY ZONE ‚Äî 12 ANGLES ANALYSIS</div>
                <div style="font-size:16px; font-weight:900; margin-top:6px;">Patient: ${rrzEscapeHtml(rrzGetPatientName())}</div>
                <div class="meta">Date: ${now} | Case ID: #RYL-2024</div>
            </div>
            
            <h3>12 Key Cephalometric Angles</h3>
            <table class="rrzTable" border="1">
                <tr><th>Angle</th><th>Value</th><th>Normal Range</th><th>Status</th><th>Interpretation</th></tr>
                <tr><td>SNA</td><td>${angles.SNA?.toFixed(1) || '-'}¬∞</td><td>80-84¬∞</td><td>${getStatus(angles.SNA, 80, 84)}</td><td>${meaningMaxillaSNA(angles.SNA) || '-'}</td></tr>
                <tr><td>SNB</td><td>${angles.SNB?.toFixed(1) || '-'}¬∞</td><td>78-82¬∞</td><td>${getStatus(angles.SNB, 78, 82)}</td><td>${meaningMandibleSNB(angles.SNB) || '-'}</td></tr>
                <tr><td>ANB</td><td>${angles.ANB?.toFixed(1) || '-'}¬∞</td><td>0-4¬∞</td><td>${getStatus(angles.ANB, 0, 4)}</td><td>${meaningSkeletalClassANB(angles.ANB) || '-'}</td></tr>
                <tr><td>FMA</td><td>${angles.FMA?.toFixed(1) || '-'}¬∞</td><td>21-29¬∞</td><td>${getStatus(angles.FMA, 21, 29)}</td><td>${angles.FMA? (angles.FMA<=26?'Normodivergent':'Hyperdivergent'):'-'}</td></tr>
                <tr><td>IMPA</td><td>${angles.IMPA?.toFixed(1) || '-'}¬∞</td><td>85-95¬∞</td><td>${getStatus(angles.IMPA, 85, 95)}</td><td>${meaningIMPA(angles.IMPA) || '-'}</td></tr>
                <tr><td>U1-NA</td><td>${angles.U1_NA?.toFixed(1) || '-'}¬∞</td><td>22¬∞¬±6¬∞</td><td>${getStatus(angles.U1_NA, 16, 28)}</td><td>-</td></tr>
                <tr><td>L1-NB</td><td>${angles.L1_NB?.toFixed(1) || '-'}¬∞</td><td>25¬∞¬±5¬∞</td><td>${getStatus(angles.L1_NB, 20, 30)}</td><td>-</td></tr>
                <tr><td>Interincisal</td><td>${angles.Interincisal?.toFixed(1) || '-'}¬∞</td><td>125-135¬∞</td><td>${getStatus(angles.Interincisal, 125, 135)}</td><td>${meaningInterincisal(angles.Interincisal) || '-'}</td></tr>
                <tr><td>Gonial</td><td>${angles.Gonial?.toFixed(1) || '-'}¬∞</td><td>110-130¬∞</td><td>${getStatus(angles.Gonial, 110, 130)}</td><td>-</td></tr>
                <tr><td>Saddle</td><td>${angles.Saddle?.toFixed(1) || '-'}¬∞</td><td>118-128¬∞</td><td>${getStatus(angles.Saddle, 118, 128)}</td><td>-</td></tr>
                <tr><td>Nasolabial</td><td>${angles.Nasolabial?.toFixed(1) || '-'}¬∞</td><td>85-110¬∞</td><td>${getStatus(angles.Nasolabial, 85, 110)}</td><td>${meaningNasolabial(angles.Nasolabial) || '-'}</td></tr>
                <tr><td>Facial</td><td>${angles.Facial?.toFixed(1) || '-'}¬∞</td><td>85-92¬∞</td><td>${getStatus(angles.Facial, 85, 92)}</td><td>-</td></tr>
            </table>
        </div>
    `;
    
    _rrzPrintWindow('12 Angles Analysis', html);
  }

  function getStatus(value, min, max) {
    if (!value) return '-';
    if (value >= min && value <= max) return 'Normal';
    return 'Abnormal';
  }

  function printFinalReport(mode){
    document.getElementById('finalReport').style.display = 'block';
    const now = new Date().toLocaleString('en-GB');
    const patientName = rrzGetPatientName();
    const header = `
      <div class="rrzPrintHeader">
        <div class="brand">ROYAL RAY ZONE ‚Äî CEPHALOMETRIC REPORT</div>
        <div style="font-size:16px; font-weight:900; margin-top:6px;">Patient: ${rrzEscapeHtml(patientName)}</div>
        <div class="meta">Date: ${now} | Case ID: #RYL-2024</div>
      </div>
    `;

    const grab = (id) => {
      const el = document.getElementById(id);
      return el ? el.innerHTML : '<div style="color:#b91c1c">No data yet. Generate Report first.</div>';
    };

    if(mode === 'written'){
      try{ showFinalPage('fr_written'); }catch(e){}
      _rrzPrintWindow('RRZ Written Report', header + `<div class="printPage">${grab('fr_written')}</div>`);
      return;
    }
    if(mode === 'final'){
      try{ showFinalPage('fr_final'); }catch(e){}
      _rrzPrintWindow('RRZ Final Summary', header + `<div class="printPage">${grab('fr_final')}</div>`);
      return;
    }
    if(mode === 'steiner'){
      try{ showFinalPage('fr_steiner'); }catch(e){}
      _rrzPrintWindow('RRZ Steiner', header + `<div class="printPage">${grab('fr_steiner')}</div>`);
      return;
    }
    if(mode === 'downs'){
      try{ showFinalPage('fr_downs'); }catch(e){}
      _rrzPrintWindow('RRZ Downs', header + `<div class="printPage">${grab('fr_downs')}</div>`);
      return;
    }
    if(mode === 'eastman'){
      try{ showFinalPage('fr_eastman'); }catch(e){}
      _rrzPrintWindow('RRZ Eastman', header + `<div class="printPage">${grab('fr_eastman')}</div>`);
      return;
    }
    if(mode === 'jarabak'){
      try{ showFinalPage('fr_jarabak'); }catch(e){}
      _rrzPrintWindow('RRZ Jarabak', header + `<div class="printPage">${grab('fr_jarabak')}</div>`);
      return;
    }
    if(mode === 'tweed'){
      try{ showFinalPage('fr_tweed'); }catch(e){}
      _rrzPrintWindow('RRZ Tweed', header + `<div class="printPage">${grab('fr_tweed')}</div>`);
      return;
    }
    if(mode === 'comprehensive'){
      printComprehensiveReport();
      return;
    }
    if(mode === 'occlusion'){
      try{ showFinalPage('fr_occlusion'); }catch(e){}
      _rrzPrintWindow('RRZ Occlusion Analysis', header + `<div class="printPage">${grab('fr_occlusion')}</div>`);
      return;
    }

    try{ showFinalPage('fr_written'); }catch(e){}
    const all = [
      { id:'fr_written', title:'Written Report' },
      { id:'fr_final', title:'Final Summary' },
      { id:'fr_steiner', title:'Steiner' },
      { id:'fr_downs', title:'Downs' },
      { id:'fr_eastman', title:'Eastman' },
      { id:'fr_jarabak', title:'Jarabak' },
      { id:'fr_tweed', title:'Tweed' },
      { id:'fr_comprehensive', title:'12 Angles' },
      { id:'fr_occlusion', title:'Occlusion Analysis' }
    ].map(p => `<div class="printPage"><h2>${p.title}</h2>${grab(p.id)}</div>`).join('');
    _rrzPrintWindow('RRZ Full Report', header + all);
  }

  function hideFinalReport(){
    const fr = document.getElementById('finalReport');
    if(fr) fr.style.display = 'none';
  }

  function rrzGoBack(){
    const fr = document.getElementById('finalReport');
    if(fr && fr.style.display === 'block'){
      window.RRZ_finalStack = window.RRZ_finalStack || [];
      if(window.RRZ_finalStack.length){
        const prev = window.RRZ_finalStack.pop();
        try{ showFinalPage(prev); }catch(e){}
      } else {
        hideFinalReport();
      }
      return;
    }

    const ab = document.getElementById('analysis-board');
    if(ab && ab.style.display === 'flex'){
      window.RRZ_rpStack = window.RRZ_rpStack || [];
      if(window.RRZ_rpStack.length){
        const prev = window.RRZ_rpStack.pop();
        try{ showReportPage(prev); }catch(e){}
      } else {
        try{ closeAnalysis(); }catch(e){}
      }
      return;
    }
    
    const av = document.getElementById('analysis-view');
    if(av && av.style.display === 'flex'){
      av.style.display = 'none';
      document.getElementById('calibration-view').style.display = 'flex';
      return;
    }

    try{ if(window.history.length > 1) window.history.back(); }catch(e){}
  }

  // ===== LINE DRAWING FUNCTION =====
  function drawAllLines() {
    clearTracing();
    
    const linePairs = [
        ['S', 'N'], ['Po', 'Or'], ['Go', 'Me'], ['ANS', 'PNS'], 
        ['OcclA','OcclP'], 
        ['U6M','L6M'], ['N', 'A'], ['N', 'B'], ['S', 'Gn'], 
        ['U1A', 'U1E'], ['L1A', 'L1E'], ['Prn', 'PgS'], ['N', 'Pog'],
        ['S', 'Ar'], ['Ar', 'Go'], ['Go', 'Me'], ['S', 'Go'],
        ['N', 'Me'], ['ANS', 'Me'], ['Prn', 'Sn'], ['Sn', 'Ls']
    ];
    
    const colors = {
        'S-N': '#FF6B6B', 'Po-Or': '#4ECDC4', 'Go-Me': '#45B7D1', 
        'ANS-PNS': '#96CEB4', 'OcclA-OcclP': '#00E5FF', 'U6M-L6M': '#FFEAA7', 'N-A': '#DDA0DD', 
        'N-B': '#98D8C8', 'S-Gn': '#F7DC6F', 'U1A-U1E': '#FFA07A', 
        'L1A-L1E': '#20B2AA', 'Prn-PgS': '#778899', 'N-Pog': '#B0C4DE',
        'S-Ar': '#FF9800', 'Ar-Go': '#9C27B0', 'Go-Me': '#3F51B5',
        'S-Go': '#009688', 'N-Me': '#E91E63', 'ANS-Me': '#9C27B0',
        'Prn-Sn': '#4CAF50', 'Sn-Ls': '#2196F3'
    };
    
    linePairs.forEach(pair => {
        if (activePoints.has(pair[0]) && activePoints.has(pair[1])) {
            if (cephPoints[pair[0]] && cephPoints[pair[1]]) {
                const line = new fabric.Line([
                    cephPoints[pair[0]].left, cephPoints[pair[0]].top,
                    cephPoints[pair[1]].left, cephPoints[pair[1]].top
                ], {
                    stroke: colors[`${pair[0]}-${pair[1]}`] || '#FFFFFF',
                    strokeWidth: 1.2,
                    selectable: false,
                    opacity: 0.7
                });
                tracingLines.push(line);
                canvas.add(line);
                line.sendToBack();
            }
        }
    });
    
    canvas.renderAll();
  }

  // ===== ANGLE LABELS FUNCTION =====
  function addAngleLabelsToCanvas(angles) {
    angleLabels.forEach(label => canvas.remove(label));
    angleLabels = [];

    const angleRequirements = {
        SNA: { points: ['S', 'N', 'A'], anchor: 'N', color: '#FF6B6B' },
        SNB: { points: ['S', 'N', 'B'], anchor: 'N', color: '#4ECDC4', offsetY: 20 },
        ANB: { points: ['A', 'N', 'B'], anchor: 'A', color: '#45B7D1' },
        FMA: { points: ['Po', 'Or', 'Go', 'Me'], anchor: 'Go', color: '#96CEB4' },
        IMPA: { points: ['Go', 'Me', 'L1A', 'L1E'], anchor: 'L1A', color: '#FFEAA7' },
        U1_NA: { points: ['U1A', 'U1E', 'N', 'A'], anchor: 'U1A', color: '#DDA0DD' },
        L1_NB: { points: ['L1A', 'L1E', 'N', 'B'], anchor: 'L1A', color: '#98D8C8' },
        Interincisal: { points: ['U1A', 'U1E', 'L1A', 'L1E'], anchor: 'U1E', color: '#F7DC6F' },
        Gonial: { points: ['Co', 'Go', 'Me'], anchor: 'Go', color: '#FFA07A', offsetY: 20 },
        Nasolabial: { points: ['Prn', 'Sn', 'Ls'], anchor: 'Sn', color: '#20B2AA' },
        Facial: { points: ['Po', 'Or', 'N', 'Pog'], anchor: 'Pog', color: '#B0C4DE' }
    };

    Object.keys(angles).forEach(key => {
        const config = angleRequirements[key];
        if (config && angles[key] !== undefined) {
            const allPointsExist = config.points.every(p => rrzPlaced(p));
            
            if (allPointsExist && config.anchor && cephPoints[config.anchor]) {
                const anchor = cephPoints[config.anchor];
                const label = new fabric.Text(`${angles[key].toFixed(1)}¬∞`, {
                    fontSize: 14,
                    fontWeight: 'bold',
                    fill: config.color,
                    backgroundColor: 'rgba(0,0,0,0.6)',
                    left: anchor.left + (config.offsetX || 10),
                    top: anchor.top + (config.offsetY || 10),
                    selectable: false
                });
                angleLabels.push(label);
                canvas.add(label);
            }
        }
    });
  }

  // ====================================================
  // ========== TREATMENT PLANNER FUNCTIONS =============
  // ====================================================

  // Global Treatment Plan Data
  let treatmentPlan = {
    version: "1.0",
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    duration: 18,
    difficulty: "moderate",
    goals: [],
    phases: [],
    tools: {
        brackets: [],
        wires: [],
        elastics: [],
        devices: []
    },
    recommendations: [],
    notes: ""
  };

  let treatmentCanvas = null;
  let selectedTools = new Set();

  // ===== RRZ V9 PATCH: Treatment Planner image upload =====
  let RRZ_tpBgDataUrl = null;

  function tpSetBackgroundImageFromDataUrl(dataUrl){
      if (!treatmentCanvas) return;
      if (!dataUrl) return;

      RRZ_tpBgDataUrl = dataUrl;

      fabric.Image.fromURL(dataUrl, (img) => {
          try{
              const cw = treatmentCanvas.getWidth();
              const ch = treatmentCanvas.getHeight();
              const scale = Math.min(cw / img.width, ch / img.height);

              img.set({
                  originX: 'left',
                  originY: 'top',
                  selectable: false,
                  evented: false
              });
              img.scale(scale);

              img.left = (cw - img.getScaledWidth()) / 2;
              img.top  = (ch - img.getScaledHeight()) / 2;

              treatmentCanvas.setBackgroundImage(img, treatmentCanvas.renderAll.bind(treatmentCanvas));
          }catch(e){
              console.warn('tpSetBackgroundImageFromDataUrl error', e);
          }
      }, { crossOrigin: 'anonymous' });
  }

  function tpHandleImageUpload(evt){
      try{
          const file = evt && evt.target && evt.target.files ? evt.target.files[0] : null;
          if(!file) return;

          const reader = new FileReader();
          reader.onload = function(){
              tpSetBackgroundImageFromDataUrl(reader.result);
          };
          reader.readAsDataURL(file);
      }catch(e){
          console.warn('tpHandleImageUpload error', e);
      }
  }

  // Initialize Treatment Planner
  function initTreatmentPlanner() {
      const canvasEl = document.getElementById('treatmentCanvas');
      if (canvasEl) {
          treatmentCanvas = new fabric.Canvas('treatmentCanvas', {
              selection: false,
              backgroundColor: '#000'
          });
          
          updateTreatmentCanvasSize();
          drawSampleArchForms();
      }
      
      loadTreatmentPlanFromStorage();
      updateAIRecommendations();
  }

  function updateTreatmentCanvasSize() {
      if (!treatmentCanvas) return;
      
      const container = document.querySelector('#treatment-planner > div > div > div:nth-child(2) > div');
      if (container) {
          treatmentCanvas.setDimensions({
              width: container.clientWidth,
              height: container.clientHeight
          });
      }

      try{
          if (RRZ_tpBgDataUrl) { tpSetBackgroundImageFromDataUrl(RRZ_tpBgDataUrl); }
      }catch(e){}
  }

  function drawSampleArchForms() {
      if (!treatmentCanvas) return;
      
      const upperArch = new fabric.Path('M 100 200 Q 200 180 300 200 Q 400 220 500 200', {
          stroke: '#3498db',
          strokeWidth: 3,
          fill: '',
          opacity: 0.7
      });
      
      const lowerArch = new fabric.Path('M 100 300 Q 200 280 300 300 Q 400 320 500 300', {
          stroke: '#e74c3c',
          strokeWidth: 3,
          fill: '',
          opacity: 0.7
      });
      
      const midline = new fabric.Line([300, 150, 300, 350], {
          stroke: '#2ecc71',
          strokeWidth: 2,
          strokeDashArray: [5, 5],
          opacity: 0.5
      });
      
      treatmentCanvas.add(upperArch, lowerArch, midline);
      treatmentCanvas.renderAll();
  }

  function showTreatmentPlanner() {
      document.getElementById('treatment-planner').style.display = 'block';
      
      if (!treatmentCanvas) {
          setTimeout(initTreatmentPlanner, 100);
      } else {
          updateTreatmentCanvasSize();
          updateAIRecommendations();
      }
  }

  function closeTreatmentPlanner() {
      document.getElementById('treatment-planner').style.display = 'none';
      saveTreatmentPlanToStorage();
  }

  function selectTool(type, name) {
      document.querySelectorAll('.tool-item').forEach(item => {
          item.querySelector('div').classList.remove('selected');
      });
      
      event.currentTarget.classList.add('selected');
      selectedTools.add(`${type}:${name}`);
      updateSelectedToolsList();
      addToolToCanvas(type, name);
      updateTreatmentPlanTools(type, name);
  }

  function selectElastic(force, type) {
      document.querySelectorAll('.elastic-btn').forEach(btn => {
          btn.classList.remove('selected');
      });
      
      event.currentTarget.classList.add('selected');
      treatmentPlan.tools.elastics.push({
          type: type,
          force: force,
          side: 'both',
          duration: 'full-time'
      });
      
      updateSelectedToolsList();
      addElasticToCanvas(type);
  }

  function addDevice(deviceType) {
      if (!deviceType) return;
      
      treatmentPlan.tools.devices.push({
          type: deviceType,
          placement: 'maxillary',
          duration: 'phase-1'
      });
      
      updateSelectedToolsList();
      showNotification(`Added ${deviceType} to treatment plan`, 'success');
      document.getElementById('additionalDevices').value = '';
  }

  function updateSelectedToolsList() {
      const container = document.getElementById('selectedToolsList');
      if (!container) return;
      
      let html = '';
      
      treatmentPlan.tools.brackets.forEach((bracket, index) => {
          html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e2e8f0;">
                  <div>
                      <span style="font-weight: bold; font-size: 12px;">${bracket.type}</span>
                      <div style="font-size: 11px; color: #666;">${bracket.prescription}</div>
                  </div>
                  <button onclick="removeTool('bracket', ${index})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 16px;">√ó</button>
              </div>
          `;
      });
      
      treatmentPlan.tools.wires.forEach((wire, index) => {
          html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e2e8f0;">
                  <div>
                      <span style="font-weight: bold; font-size: 12px;">${wire.type}</span>
                      <div style="font-size: 11px; color: #666;">${wire.size}</div>
                  </div>
                  <button onclick="removeTool('wire', ${index})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 16px;">√ó</button>
              </div>
          `;
      });
      
      treatmentPlan.tools.elastics.forEach((elastic, index) => {
          html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e2e8f0;">
                  <div>
                      <span style="font-weight: bold; font-size: 12px;">Class ${elastic.type}</span>
                      <div style="font-size: 11px; color: #666;">${elastic.force}</div>
                  </div>
                  <button onclick="removeTool('elastic', ${index})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 16px;">√ó</button>
              </div>
          `;
      });
      
      treatmentPlan.tools.devices.forEach((device, index) => {
          html += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e2e8f0;">
                  <div>
                      <span style="font-weight: bold; font-size: 12px;">${device.type}</span>
                      <div style="font-size: 11px; color: #666;">${device.placement}</div>
                  </div>
                  <button onclick="removeTool('device', ${index})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 16px;">√ó</button>
              </div>
          `;
      });
      
      container.innerHTML = html || '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">No tools selected yet</div>';
  }

  function removeTool(type, index) {
      if (treatmentPlan.tools[type]) {
          treatmentPlan.tools[type].splice(index, 1);
          updateSelectedToolsList();
          updateTreatmentPlanVisualization();
      }
  }

  function addToolToCanvas(type, name) {
      if (!treatmentCanvas) return;
      
      let visual = null;
      
      switch(type) {
          case 'bracket':
              visual = new fabric.Rect({
                  left: 200 + Math.random() * 200,
                  top: 200 + Math.random() * 50,
                  width: 12,
                  height: 8,
                  fill: '#3498db',
                  stroke: 'white',
                  strokeWidth: 1,
                  opacity: 0.8
              });
              break;
              
          case 'wire':
              visual = new fabric.Line([150, 250, 450, 250], {
                  stroke: '#9b59b6',
                  strokeWidth: 4,
                  opacity: 0.7,
                  strokeLineCap: 'round'
              });
              break;
      }
      
      if (visual) {
          treatmentCanvas.add(visual);
          treatmentCanvas.renderAll();
      }
  }

  function addElasticToCanvas(type) {
      if (!treatmentCanvas) return;
      
      let elastic = null;
      const colors = {
          'Class II': '#FF6B6B',
          'Class III': '#4ECDC4',
          'Vertical': '#45B7D1',
          'Cross': '#96CEB4',
          'Box': '#FFEAA7',
          'Triangle': '#DDA0DD'
      };
      
      switch(type) {
          case 'Class II':
              elastic = new fabric.Line([250, 200, 350, 280], {
                  stroke: colors[type],
                  strokeWidth: 3,
                  strokeDashArray: [5, 5],
                  opacity: 0.8
              });
              break;
              
          case 'Class III':
              elastic = new fabric.Line([350, 200, 250, 280], {
                  stroke: colors[type],
                  strokeWidth: 3,
                  strokeDashArray: [5, 5],
                  opacity: 0.8
              });
              break;
              
          case 'Vertical':
              elastic = new fabric.Line([300, 180, 300, 220], {
                  stroke: colors[type],
                  strokeWidth: 3,
                  strokeDashArray: [5, 5],
                  opacity: 0.8
              });
              break;
      }
      
      if (elastic) {
          treatmentCanvas.add(elastic);
          treatmentCanvas.renderAll();
      }
  }

  function updateAIRecommendations() {
      const container = document.getElementById('recommendationContent');
      if (!container) return;
      
      const angles = calculateAllAngles ? calculateAllAngles() : {};
      const measurements = calculateLinearMeasurements ? calculateLinearMeasurements() : {};
      
      let recommendations = [];
      
      if (angles.ANB) {
          if (angles.ANB > 4) {
              recommendations.push("Consider Class II mechanics (elastics, Forsus, Carriere)");
              recommendations.push("Maxillary distalization or mandibular advancement");
          } else if (angles.ANB < 0) {
              recommendations.push("Consider Class III mechanics (reverse pull headgear, facemask)");
              recommendations.push("Maxillary protraction or mandibular setback");
          }
      }
      
      if (angles.FMA) {
          if (angles.FMA > 29) {
              recommendations.push("High angle case - avoid extrusion, consider TADs for intrusion");
              recommendations.push("Use light forces, consider vertical control with TPA/Nance");
          } else if (angles.FMA < 21) {
              recommendations.push("Low angle case - can tolerate extrusion, avoid intrusion");
          }
      }
      
      if (angles.IMPA) {
          if (angles.IMPA > 95) {
              recommendations.push("Proclined lower incisors - consider lingual crown torque or extraction");
          } else if (angles.IMPA < 85) {
              recommendations.push("Retroclined lower incisors - consider labial crown torque or non-extraction");
          }
      }
      
      if (angles.Interincisal) {
          if (angles.Interincisal < 125) {
              recommendations.push("Reduced interincisal angle - consider torque control and anterior intrusion");
          }
      }
      
      if (recommendations.length === 0) {
          recommendations = [
              "Standard straight-wire mechanics recommended",
              "Align and level with NiTi sequence",
              "Consider TPA for molar control in extraction cases",
              "Regular monitoring every 6-8 weeks"
          ];
      }
      
      container.innerHTML = recommendations.map(rec => 
          `<div style="margin-bottom: 6px; padding-left: 15px; position: relative;">
              <span style="position: absolute; left: 0; color: var(--gold);">‚Ä¢</span>
              ${rec}
           </div>`
      ).join('');
  }

  
  

  // ===== RRZ AI HARDENING HELPERS (Ceph -> Treatment Plan) =====
  function rrzSafeStringify(obj, maxLen){
    try{
      const s = JSON.stringify(obj);
      if(!maxLen) return s;
      return s.length>maxLen ? s.slice(0,maxLen) : s;
    }catch(e){
      return '{}';
    }
  }

  function rrzHashStr(str){
    // DJB2
    let h = 5381;
    for(let i=0;i<str.length;i++){
      h = ((h << 5) + h) + str.charCodeAt(i);
      h = h & 0xffffffff;
    }
    return (h>>>0).toString(16);
  }

  function rrzGetCurrentPatient(){
    try{
      const p = JSON.parse(localStorage.getItem('currentPatient') || 'null');
      if(!p || typeof p !== 'object') return null;
      return {
        name: p.name || '',
        id: p.id || '',
        age: (p.age ?? ''),
        gender: p.gender || ''
      };
    }catch(e){ return null; }
  }

  function rrzBuildCephAIInput(){
    // Source of truth = last generated report (stable, avoids recompute divergence)
    const last = window.RRZ_LAST_CEPH || {};
    const rpt = window.RRZ_LAST_CEPH_REPORT_TEXT || {};

    // Preferences from UI (Treatment Planner panel)
    const durationEl = document.getElementById('treatmentDuration');
    const difficultyEl = document.getElementById('treatmentDifficulty');

    const duration = durationEl ? durationEl.value : '18';
    const difficulty = difficultyEl ? difficultyEl.value : 'moderate';

    // If analysis not generated yet, compute minimal set (but do NOT force full UI rendering)
    const angles = last.angles || (typeof calculateAllAngles === 'function' ? calculateAllAngles() : {});
    const measurements = last.measurements || (typeof calculateLinearMeasurements === 'function' ? calculateLinearMeasurements() : {});
    const wits = (last.wits !== undefined) ? last.wits : (typeof calculateWitsAppraisal === 'function' ? calculateWitsAppraisal() : null);
    const lowerAFHRatio = (last.lowerAFHRatio !== undefined) ? last.lowerAFHRatio : (typeof calculateLowerAFHRatio === 'function' ? calculateLowerAFHRatio() : null);

    const payload = {
      patient: rrzGetCurrentPatient(),
      ceph: {
        angles: angles || {},
        linear_measurements: measurements || {},
        wits: wits,
        lower_afh_ratio: lowerAFHRatio,
        occlusion: last.occlusion || {},
        interincisal_analysis: last.interincisalAnalysis || {},
        incisor_inclination: last.incisorInclination || {}
      },
      reports_text: {
        final_summary: rpt.final,
        downs: rpt.downs,
        steiner: rpt.steiner,
        eastman: rpt.eastman,
        jarabak: rpt.jarabak,
        tweed: rpt.tweed,
        comprehensive: rpt.comprehensive,
        occlusion: rpt.occlusion
      },
      preferences: { duration_months: duration, difficulty },
      temperature: 0.2
    };
    return payload;
  }

  async function rrzAutoTreatmentFromFinalReport(){
    try{
      // Only auto-run when analysis exists
      if(!window.RRZ_reportReady) return;

      // Build hash from current analysis snapshot
      const input = rrzBuildCephAIInput();
      const h = rrzHashStr(rrzSafeStringify(input, 200000));

      // Prevent repeated calls for same report
      if(window.RRZ_LAST_TP_HASH && window.RRZ_LAST_TP_HASH === h) return;
      window.RRZ_LAST_TP_HASH = h;

      // If already have a saved plan for the same hash, reuse it
      try{
        const saved = JSON.parse(localStorage.getItem('rrz_last_ai_treatment_plan') || 'null');
        if(saved && saved.hash === h && saved.text){
          // hydrate UI if open
          const phasesEl = document.getElementById('treatmentPhases');
          if(phasesEl && !phasesEl.value.trim()) phasesEl.value = saved.text;
          // also ensure main treatmentPlan storage is updated
          try{
            const plan = JSON.parse(localStorage.getItem('rrz_treatment_plan') || 'null') || {};
            plan.phases = saved.text;
            plan.updated = new Date().toISOString();
            localStorage.setItem('rrz_treatment_plan', JSON.stringify(plan));
          }catch(e){}
          return;
        }
      }catch(e){}

      if(typeof generateTreatmentFromAnalysis === 'function'){
        await generateTreatmentFromAnalysis({ auto:true, inputOverride: input, hash: h });
      }
    }catch(e){
      // Silent by design; no UI crash risk
      console.warn('Auto treatment plan skipped:', e);
    }
  }
  // ===== END RRZ AI HARDENING HELPERS =====


// ===== RRZ AI PATCH: Treatment Planner -> Unified AI Gateway (ceph_treatment_planner) =====
  async function generateTreatmentFromAnalysis(opts = {}) {
      // TreatmentPlan AI (Ceph) ‚Äî reads final Steiner/Downs/Jarabak written analyses and generates a tailored plan.
      const options = opts || {};
      const tp = document.getElementById('treatmentPhases');

      const notify = (msg, type)=>{
        try{ if (typeof showNotification === 'function') return showNotification(msg, type); }catch(e){}
        try{ console.log(type ? `[${type}]` : '', msg); }catch(e){}
      };

      const getText = (id)=>{
        const el = document.getElementById(id);
        return (el?.innerText || el?.textContent || '').trim();
      };

      const steiner = getText('tbl_written_steiner');
      const downs   = getText('tbl_written_downs');
      const jarabak = getText('tbl_written_jarabak');

      // Fallback: if written analyses not built yet, we can still try building input from internal calculators
      const haveAny = !!(steiner || downs || jarabak);
      const analysisPack = [
        "STEINER (final written):\n" + (steiner || "[missing]"),
        "DOWNS (final written):\n"   + (downs   || "[missing]"),
        "JARABAK (final written):\n" + (jarabak || "[missing]")
      ].join("\n\n");

      const preferences = {
        difficulty: (document.getElementById('treatmentDifficulty')?.value || 'moderate'),
        duration_months: (document.getElementById('treatmentDuration')?.value || '18')
      };

      // Prepare prompt (English output)
      const prompt = `
You are an orthodontic treatment planning assistant.
Generate a patient-specific orthodontic treatment plan based ONLY on the cephalometric final written analyses below (Steiner, Downs, Jarabak).
If something is missing, explicitly state what is missing and proceed with conservative, safe assumptions.

OUTPUT REQUIREMENTS (English):
- Start with: "Diagnostic Summary" (2‚Äì4 lines)
- Then: "Treatment Objectives" (bullet points)
- Then: "Phased Treatment Plan" (Phase 1/2/3 with an estimated months range)
- Include: appliance system, archwire sequence, elastics/anchorage, extraction decision (if indicated), and retention.
- Keep it practical, clinic-ready, and written in clear professional English.

PREFERENCES:
- Difficulty: ${preferences.difficulty}
- Target duration (months): ${preferences.duration_months}

FINAL ANALYSES:
${analysisPack}
`.trim();

      try{
          if(!haveAny){
            notify("‚ö†Ô∏è Written analyses (Steiner/Downs/Jarabak) not found yet. Generating a generic plan based on available data‚Ä¶", "warning");
          }else{
            notify("Generating treatment plan with AI‚Ä¶", "info");
          }

          if(tp){
            tp.value = "Generating AI treatment plan‚Ä¶";
          }

          const resp = await fetch('/.netlify/functions/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              task: 'ceph_treatment_planner',
              payload: { text: prompt },
              meta: { lang: 'en' }
            })
          });

          const data = await resp.json().catch(()=> ({}));

          if(!resp.ok || !data || data.ok === false){
            throw new Error(data?.error || `HTTP ${resp.status}`);
          }

          const txt = data.text || data?.raw?.choices?.[0]?.message?.content || '';
          if(tp) tp.value = txt;

          // cache last plan
          try{
            localStorage.setItem('rrz_last_ceph_treatment_plan', JSON.stringify({
              at: new Date().toISOString(),
              difficulty: preferences.difficulty,
              duration_months: preferences.duration_months,
              plan_text: txt
            }));
          }catch(e){}

          notify("AI treatment plan generated successfully.", "success");
          return txt;
      }catch(e){
          console.warn('AI Treatment Planner failed, fallback to local:', e);
          try{
              if (typeof generateTreatmentFromAnalysisLocal === 'function'){
                generateTreatmentFromAnalysisLocal();
                notify("AI failed ‚Äî generated a local (basic) plan.", "warning");
                return (document.getElementById('treatmentPhases')?.value || '');
              }
          }catch(e2){}
          notify("Failed to generate treatment plan. Please try again.", "error");
          return "";
      }
  }
  // ===== END RRZ AI PATCH =====

function generateTreatmentFromAnalysisLocal() {
      const angles = calculateAllAngles ? calculateAllAngles() : {};
      const measurements = calculateLinearMeasurements ? calculateLinearMeasurements() : {};

      const duration = document.getElementById('treatmentDuration').value;
      const difficulty = document.getElementById('treatmentDifficulty').value;

      const notes = [];
      const flags = [];

      if (angles.ANB !== undefined && angles.ANB !== null) {
          if (angles.ANB > 4) { flags.push('Skeletal tendency: Class II'); notes.push('Consider Class II correction mechanics aligned with case objectives.'); }
          else if (angles.ANB < 0) { flags.push('Skeletal tendency: Class III'); notes.push('Consider Class III correction mechanics aligned with case objectives.'); }
          else { flags.push('Skeletal tendency: Class I'); notes.push('Maintain Class I skeletal relationship while optimizing dental alignment/occlusion.'); }
      }

      if (angles.FMA !== undefined && angles.FMA !== null) {
          if (angles.FMA >= 29) { flags.push('Vertical tendency: Hyperdivergent'); notes.push('Prioritize vertical control; monitor mandibular plane and facial height changes.'); }
          else if (angles.FMA <= 20) { flags.push('Vertical tendency: Hypodivergent'); notes.push('Monitor deep bite tendency; avoid excessive incisor intrusion unless planned.'); }
          else { flags.push('Vertical tendency: Normodivergent'); }
      }

      const phases = [
          {
              name: "Phase 1: Baseline Setup & Alignment",
              duration: "Early phase",
              tasks: [
                  "Confirm landmark accuracy (repeatability check on key planes).",
                  "Start alignment sequence while maintaining planned plane controls.",
                  "Establish baseline overjet/overbite targets informed by cephalometric angles."
              ]
          },
          {
              name: "Phase 2: Correction & Control",
              duration: "Mid phase",
              tasks: [
                  "Apply AP correction strategies consistent with ANB tendency and clinical objectives.",
                  "Apply vertical/occlusal control consistent with FMA/Y-axis/Mx‚ÄìMn findings.",
                  "Maintain incisor inclination targets (IMPA, L1‚ÄìOcclusal) during space management."
              ]
          },
          {
              name: "Phase 3: Finishing & Stability",
              duration: `Late phase (to Month ${duration})`,
              tasks: [
                  "Refine intercuspation and occlusal plane goals.",
                  "Finalize incisor display/torque within planned envelope.",
                  "Retention planning based on achieved planes and stability risk factors."
              ]
          }
      ];

      document.getElementById('treatmentPhases').value = phases.map(phase => 
          `${phase.name} (${phase.duration}):
${phase.tasks.map(task => `- ${task}`).join('\n')}`
      ).join('\n\n');

      updateTreatmentGoalsFromAnalysis(angles, {}, {});

      if (flags.length || notes.length) {
          document.getElementById('treatmentPhases').value += 
              `\n\n=== Summary (Angles/Planes) ===\n` +
              (flags.length ? `Flags:\n- ${flags.join('\n- ')}\n` : '') +
              (notes.length ? `Notes:\n- ${notes.join('\n- ')}\n` : '');
      }

      showNotification("Treatment plan generated from angles/planes!", "success");
  }

  function updateTreatmentGoalsFromAnalysis(angles, jarabak, tweed) {
      const goalsContainer = document.getElementById('treatmentGoals');

      let goals = [
          { id: 'goal1', text: 'Optimize skeletal and dental relationship (angles-driven)', checked: true },
          { id: 'goal2', text: 'Level and align arches with plane control', checked: true },
          { id: 'goal3', text: 'Establish target overjet/overbite consistent with cephalometrics', checked: true },
          { id: 'goal4', text: 'Improve soft tissue profile within planned envelope', checked: true },
          { id: 'goal5', text: 'Achieve functional occlusion with stable planes', checked: true },
          { id: 'goal6', text: 'Ensure long-term stability and retention', checked: true }
      ];

      if (angles.ANB !== undefined && angles.ANB !== null) {
          if (angles.ANB > 4) goals[0].text = 'Reduce Class II tendency (ANB-guided) while maintaining stability';
          else if (angles.ANB < 0) goals[0].text = 'Reduce Class III tendency (ANB-guided) while maintaining stability';
          else goals[0].text = 'Maintain Class I skeletal tendency (ANB-guided)';
      }

      if ((angles.FMA !== undefined && angles.FMA !== null && angles.FMA >= 29) || (angles.Yaxis !== undefined && angles.Yaxis !== null && angles.Yaxis > 65)) {
          goals.push({ id: 'goal7', text: 'Control vertical dimension (FMA/Y-axis guided)', checked: true });
      }
      if (angles.CantOcclusal !== undefined && angles.CantOcclusal !== null && angles.CantOcclusal > 13) {
          goals.push({ id: 'goal8', text: 'Manage occlusal plane cant as indicated', checked: true });
      }
      if (angles.IMPA !== undefined && angles.IMPA !== null && (angles.IMPA > 100 || angles.IMPA < 85)) {
          goals.push({ id: 'goal9', text: 'Normalize lower incisor inclination (IMPA/L1‚ÄìOcclusal guided)', checked: true });
      }

      goalsContainer.innerHTML = goals.map(goal => `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <input type="checkbox" id="${goal.id}" ${goal.checked ? 'checked' : ''} style="transform: scale(1.2);">
              <label for="${goal.id}">${goal.text}</label>
          </div>
      `).join('');
  }

  function saveTreatmentPlan() {
      treatmentPlan.duration = document.getElementById('treatmentDuration').value;
      treatmentPlan.difficulty = document.getElementById('treatmentDifficulty').value;
      treatmentPlan.phases = document.getElementById('treatmentPhases').value;
      treatmentPlan.updated = new Date().toISOString();
      
      localStorage.setItem('rrz_treatment_plan', JSON.stringify(treatmentPlan));
      
      const dataStr = JSON.stringify(treatmentPlan, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `Treatment_Plan_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification("Treatment plan saved successfully!", "success");
  }

  function loadTreatmentPlan() {
      const saved = localStorage.getItem('rrz_treatment_plan');
      if (saved) {
          try {
              treatmentPlan = JSON.parse(saved);
              
              document.getElementById('treatmentDuration').value = treatmentPlan.duration;
              document.getElementById('treatmentDifficulty').value = treatmentPlan.difficulty;
              if (treatmentPlan.phases && typeof treatmentPlan.phases === 'string') {
                  document.getElementById('treatmentPhases').value = treatmentPlan.phases;
              }
              
              updateSelectedToolsList();
              showNotification("Treatment plan loaded from storage", "success");
          } catch (e) {
              showNotification("Error loading plan: " + e.message, "error");
          }
      } else {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
              const file = e.target.files[0];
              const reader = new FileReader();
              reader.onload = (event) => {
                  try {
                      treatmentPlan = JSON.parse(event.target.result);
                      showNotification("Treatment plan loaded from file", "success");
                  } catch (e) {
                      showNotification("Invalid file format", "error");
                  }
              };
              reader.readAsText(file);
          };
          input.click();
      }
  }

  function loadTreatmentPlanFromStorage() {
      const saved = localStorage.getItem('rrz_treatment_plan');
      if (saved) {
          try {
              treatmentPlan = JSON.parse(saved);
          } catch (e) {
              console.warn("Could not load treatment plan from storage");
          }
      }
  }

  function saveTreatmentPlanToStorage() {
      try {
          localStorage.setItem('rrz_treatment_plan', JSON.stringify(treatmentPlan));
      } catch (e) {
          console.warn("Could not save treatment plan to storage");
      }
  }

  function printTreatmentPlan() {
      const plan = (window.treatmentPlan || {});
      const printWindow = window.open('', '_blank');

      let vizDataURL = '';
      try {
          if (window.treatmentCanvas && typeof window.treatmentCanvas.toDataURL === 'function') {
              vizDataURL = window.treatmentCanvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
          } else {
              const c = document.getElementById('treatmentCanvas');
              if (c && typeof c.toDataURL === 'function') vizDataURL = c.toDataURL('image/png');
          }
      } catch (e) { vizDataURL = ''; }

      const escapeHTML = (s) => String(s ?? '').replace(/[&<>"']/g, (m) => (
          m === '&' ? '&amp;' : m === '<' ? '&lt;' : m === '>' ? '&gt;' : m === '"' ? '&quot;' : '&#39;'
      ));

      const _durEl = document.getElementById('treatmentDuration');
      const _diffEl = document.getElementById('treatmentDifficulty');
      const _phasesEl = document.getElementById('treatmentPhases');

      const uiDuration = (_durEl && _durEl.value !== '') ? _durEl.value : (plan.duration ?? '');
      const uiDifficulty = (_diffEl && _diffEl.selectedIndex >= 0) ? (_diffEl.options[_diffEl.selectedIndex].text || _diffEl.value) : (plan.difficulty ?? '');
      const uiPhasesRaw = (_phasesEl && typeof _phasesEl.value === 'string') ? _phasesEl.value : '';

      const fallbackPhases = Array.isArray(plan.phases) ? plan.phases.map(ph => {
          if (!ph) return '';
          if (typeof ph === 'string') return ph;
          const name = ph.name || 'Phase';
          const dur = ph.duration || '';
          const tasks = Array.isArray(ph.tasks) ? ph.tasks.map(t => `- ${t}`).join('\n') : '';
          return `${name}${dur ? ` (${dur})` : ''}:\n${tasks}`.trim();
      }).filter(Boolean).join('\n\n') : (typeof plan.phases === 'string' ? plan.phases : '');

      const phasesText = escapeHTML((uiPhasesRaw && uiPhasesRaw.trim()) ? uiPhasesRaw : fallbackPhases);
      const createdDate = plan.created ? new Date(plan.created).toLocaleDateString() : '';

      printWindow.document.write(`
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <title>Treatment Planner Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 36px; color: #111; }
                  h1 { margin: 0 0 14px 0; font-size: 22px; }
                  .section { margin: 18px 0; }
                  .card { border: 1px solid #e6e6e6; border-radius: 10px; padding: 14px; }
                  .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                  .meta div { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
                  .viz { width: 100%; max-width: 980px; margin: 0 auto; }
                  .viz img { width: 100%; height: auto; border-radius: 12px; border: 1px solid #ddd; background: #000; }
                  pre { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin: 0; }
                  .no-print { margin-top: 16px; }
                  @media print { .no-print { display: none !important; } body { margin: 18px; } }
              </style>
          </head>
          <body>
              <h1>Treatment Planner Report</h1>

              <div class="section viz">
                  ${vizDataURL ? `<div class="card"><img src="${vizDataURL}" alt="Treatment Visualization" /></div>`
                              : `<div class="card"><strong>Visualization:</strong> (No image captured)</div>`}
              </div>

              <div class="section">
                  <div class="card">
                      <div class="meta">
                          <div><strong>Duration (months):</strong> ${uiDuration}</div>
                          <div><strong>Difficulty:</strong> ${uiDifficulty}</div>
                          <div><strong>Created:</strong> ${createdDate}</div>
                          <div><strong>Notes:</strong> ${escapeHTML(plan.notes || '')}</div>
                      </div>
                  </div>
              </div>

              <div class="section">
                  <div class="card">
                      <strong>Treatment Plan</strong>
                      <div style="height:10px"></div>
                      ${phasesText ? `<pre>${phasesText}</pre>` : `<div>(No phases defined)</div>`}
                  </div>
              </div>

              <div class="no-print">
                  <button onclick="window.print()" style="background:#1a3c5a;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;">Print / Save as PDF</button>
              </div>
          </body>
          </html>
      `);

      printWindow.document.close();
      setTimeout(() => printWindow.print(), 300);
  }

  function exportTreatmentPlan() {
      showNotification("PDF export feature coming soon!", "info");
  }

  function clearTreatmentPlan() {
      if (confirm("Are you sure you want to clear all treatment plan data?")) {
          treatmentPlan = {
              version: "1.0",
              created: new Date().toISOString(),
              updated: new Date().toISOString(),
              duration: 18,
              difficulty: "moderate",
              goals: [],
              phases: [],
              tools: {
                  brackets: [],
                  wires: [],
                  elastics: [],
                  devices: []
              },
              recommendations: [],
              notes: ""
          };
          
          document.getElementById('treatmentDuration').value = 18;
          document.getElementById('treatmentDifficulty').value = "moderate";
          document.getElementById('treatmentPhases').value = "";
          updateSelectedToolsList();
          
          if (treatmentCanvas) {
              const _bg = (typeof RRZ_tpBgDataUrl !== 'undefined') ? RRZ_tpBgDataUrl : null;
              treatmentCanvas.clear();
              try{ if(_bg) tpSetBackgroundImageFromDataUrl(_bg); }catch(e){}
              drawSampleArchForms();
          }
          
          showNotification("Treatment plan cleared", "info");
      }
  }

  function updateTreatmentPlanTools(type, name) {
      if (!treatmentPlan.tools[type]) {
          treatmentPlan.tools[type] = [];
      }
      
      const exists = treatmentPlan.tools[type].some(tool => tool.type === name);
      if (!exists) {
          treatmentPlan.tools[type].push({
              type: name,
              added: new Date().toISOString()
          });
      }
  }

  function updateTreatmentPlanVisualization() {
      if (!treatmentCanvas) return;
      
      treatmentCanvas.getObjects().forEach(obj => {
          if (!obj.path) {
              treatmentCanvas.remove(obj);
          }
      });
      
      Object.values(treatmentPlan.tools).flat().forEach(tool => {
          // Add visualization based on tool type
      });
      
      treatmentCanvas.renderAll();
  }

  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
          color: white;
          border-radius: 8px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          z-index: 9999;
          animation: slideInRight 0.3s ease-out;
      `;
      
      notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 20px;">
                  ${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}
              </span>
              <span>${message}</span>
          </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
          notification.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => {
              if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
              }
          }, 300);
      }, 3000);
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
          try { rrzApplyPatientNameToUI(); } catch(e) {}
      }, 100);
  });

  // ===== Reference Cephalometric Image =====
  function openCephReference(){
    // File should sit next to this HTML: "referance ceph.png"
    const url = 'referance%20ceph.png';
    try{
      const w = window.open(url, '_blank');
      if(!w){
        alert('Popup blocked. Please allow popups to open the reference image.');
      }
    }catch(e){
      alert('Unable to open reference image.');
    }
  }

</script>
</body>
</html>